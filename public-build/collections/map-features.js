define(["jquery","underscore","backbone","models/geo-feature","parsers/index","moment"],function(e,t,n,r,i,s){var o=n.Collection.extend({model:r,initialize:function(t,n){this.mapLayer=n.mapLayer,this.queryParams=n.queryParams?e.extend({},n.queryParams):{},this.urlParams=n.urlParams?e.extend({},n.urlParams):{},this.urlFormat=n.urlFormat,this.properties={},n.parser?this.parser=new i[n.parser](this):this.parser=new i.GeoJSON(this),this.initiallyFetched=this.visibleMapAreaFetched=!1,this.on("error",function(){this.initiallyFetched=!1})},canFetch:function(){return this.mapLayer.attributes.featureCollection||this.urlFormat!=undefined&&this.urlFormat!=""},fetch:function(e){var e=e||{};return this.urlFormat!=undefined&&(e=t.extend(e,{dataType:"jsonp"})),this.initiallyFetched=this.visibleMapAreaFetched=!0,o.__super__.fetch.call(this,e)},url:function(e){if(this.urlFormat!=undefined){var n=this.urlFormat.format(this.urlParams);return n}if(!e){var e={},r=this.urlParams.bounds;r&&(e.b=[r[0][0],r[0][1],r[1][0],r[1][1]]),this.urlParams.zoom!=undefined&&(e.z=this.urlParams.zoom),this.urlParams.original&&(e.o=this.urlParams.original=1)}return this.mapLayer.url()+"/features"+"?"+genQueryString(t.extend(this.queryParams,e))},resetFrom:function(e){this.reset(e.models),this.visibleMapAreaFetched=e.visibleMapAreaFetched,this.urlParams=t.clone(e.urlParams)},setVisibleMapArea:function(e){var n=t.clone(this.urlParams);this.urlParams.bounds=e.bounds,this.urlParams.zoom=e.zoom,this.visibleMapAreaFetched=t.isEqual(n,this.urlParams)},isCurrent:function(){return this.initiallyFetched&&this.visibleMapAreaFetched},parse:function(e,t){var n=this.parser.parse(e,t);return this.properties=n.properties,n.features},getCounts:function(){return this.properties.counts},gridSize:function(){return this.properties.gridSize}});return o});