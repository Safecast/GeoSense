define(["jquery","underscore","backbone","config","utils","text!templates/data-detail.html","views/panel-view-base"],function(e,t,n,r,i,s,o){var u=o.extend({className:"panel data-detail",events:{},initialize:function(e){u.__super__.initialize.call(this,e),this.template=t.template(s),this.defaultLayout=[{fields:["properties.icon"],label:!1,formatter:"icon","class":"icon muted"},{fields:["%(label)s","%(datetime)s"],label:!1,"class":"box title"},{fields:["%(numeric)s"],label:"%(numeric)s","class":"large"},{fields:["properties.description"],label:!1,"class":"box text-body muted"},{fields:["properties.$other"],label:"%(field)s","class":"text-body muted"},{fields:["count"],label:__("no. of %(itemTitlePlural)s"),formatter:"numeric","class":"muted"},{fields:["%(numeric)s.max"],label:"peak","class":"muted"},{fields:["%(numeric)s.min"],label:"minimum","class":"muted"},{fields:["%(numeric)s.avg"],label:"average","class":"muted"}]},setModel:function(e){this.model&&(this.stopListening(this.model),this.model.collection&&this.model.collection.mapLayer&&this.stopListening(this.model.collection.mapLayer)),this.model=e,this.populateFromModel(),this.listenTo(e.collection.mapLayer,"change",this.populateFromModel),this.listenTo(e.collection.mapLayer,"toggle:valFormatter",this.populateFromModel)},populateFromModel:function(){var t=this.model,n=this.compileDetailDataForModel(t),r=this.$(".panel-body"),i=function(e){var t=e.class?'<span class="'+e.class+'">':"<span>";return e.label!=undefined&&e.value!=undefined?'<tr><th class="detail-label">'+t+e.label+'</span></th><td class="detail-value">'+t+e.value+"</span></td></tr>":e.label!=undefined?'<tr><td colspan="2" class="detail-label single">'+t+e.label+"</span></td></tr>":e.value!=undefined?'<tr><td colspan="2" class="detail-value single">'+t+e.value+"</span></td></tr>":""},s=e(".detail-data",r),o=[];for(var u=0;u<n.length;u++)o.push(i(n[u]));s.html(o.join("\n")),this.model.collection&&this.model.collection.mapLayer&&this.$(".model-title").text(this.model.collection.mapLayer.getDisplay("title"))},compileDetailDataForModel:function(e){if(!e.collection)return[];var n=e.collection.mapLayer,r=n.getLayerOptions(),i=n.getDisplay("detailLayout")||this.defaultLayout,s=n.getValFormatter(),o={},u=function(e){return e instanceof Date},a=function(e){return!u(e)&&(typeof e=="object"&&t.isEmpty(e)||!e&&e!=0||e==="")},f=function(e,t){if(u(e)||typeof e!="object")return t?t.format(e):e;if(e.value!=undefined)return f(e.value,t);if(e.avg!=undefined)return f(e.avg,t);if(Array.isArray(e))return e.join(", ");var n=t.minMaxFormat||__("%(min)s to %(max)s");return __(n).format({min:f(e.min,t),max:f(e.max,t)})},l={date:{format:function(e){var e=e instanceof Date?e:new Date(e);return e.format(r.datetimeFormat||locale.formats.DATE_SHORT)}},numeric:s,icon:{format:function(e){return'<img class="icon" src="'+e+'" />'}}};l.icon.minMaxFormat=__("%(min)s %(max)s"),l.date.minMaxFormat=l.numeric.minMaxFormat=__("%(min)sâ€“%(max)s");var c=r.attrMap?{numeric:r.attrMap.numeric,datetime:r.attrMap.datetime,label:r.attrMap.label}:{},h=n.getFeatureCollectionAttr("fields"),p={numeric:a(s.unit)?c.numeric&&h?h.reduce(function(e,t){return t.name==c.numeric?t.label:e}):__("Value"):s.unit,unit:s.unit,itemTitlePlural:n.getDisplay("itemTitlePlural")||__("samples")},d=[];return t.each(i,function(n){var r=[],i=function(t,n,r,i){var s=e.get(n),u=i.formatter?l[i.formatter]:!1;o[n]=!0;if(!u&&!a(s)){switch(r.split(".")[0]){case"%(datetime)s":u=l.date;break;case"%(numeric)s":u=l.numeric}t.push(f(s,u))}return t},s=function(e,t){if(e.length){var n=e.join(t.join||"<br />");t.label?d.push({label:t.label.format(p),value:n,"class":t.class}):d.push({value:n,"class":t.class})}};t.each(n.fields,function(u){var a=u.format(c);a=="properties.$other"?t.each(e.get("properties"),function(e,r){if(!o["properties."+r]){var a={label:n.label?n.label.format(t.extend(c,{field:r})):!1,"class":n.class,formatter:n.formatter};s(i([],"properties."+r,u,a),a)}}):i(r,a,u,n)}),s(r,n)}),d}});return u});