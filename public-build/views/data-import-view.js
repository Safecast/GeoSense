/*!prev ||Â !prev.length*/

define(["jquery","underscore","backbone","config","utils","text!templates/data-import.html","views/modal-view"],function(e,t,n,r,i,s,o){var u=o.extend({tagName:"div",className:"data-import-view modal fade",events:{"change .step.source input":"sourceInputChanged","click .import-run":"importButtonClicked","click .source-submit":"sourceSubmitButtonClicked","click .back":"backButtonClicked","click .from-field .remove":"fromFieldRemoveClicked"},initialize:function(e){this.template=t.template(s),this.vent=e.vent,this.responseData=null,this.dataTitle="",this.dataDescription="",this.maxPreview=30,this.inspectedSource,this.fromFieldColors=["#a52a2a","#f89406","#46a546","#62cffc","#ff7f50","#87ceeb","#daa520","#b8860b","#c43c35","#556b2f"],this.toFields={loc:"Point X,Y",val:"Point Value",datetime:"Date",label:"Point Label",attributes:"Attributes"}},canImport:function(){return!this.isLoading&&this.$("input[name=url]").val().length},sourceSubmitButtonClicked:function(){var e=this;return this.canImport()?(console.log("sourceSubmit"),this.runImport({inspect:!0,max:this.maxPreview},{success:function(t){t.items&&t.items.length&&(e.initSourceForMapping(t),e.setStep("mapping"))}}),!1):!1},backButtonClicked:function(){this.setStep("source")},sourceInputChanged:function(){var e=this.$("input[name=url]").data("prevVal"),t=this.$("input[name=url]").val();this.$("input[name=url]").data("prevVal",t),t=t.replace(/^https:\/\/www.dropbox.com\//,"https://dl.dropbox.com/"),this.$("input[name=url]").val(t),this.$(".btn.source-submit").attr("disabled",!this.canImport())},importButtonClicked:function(){var e=this;return this.canImport()?(this.runImport({background:!0},{success:function(t){app.saveNewMapLayer(t.collection._id),e.setStep("source"),e.close()}}),!1):!1},initSourceForMapping:function(n){var r=this;this.inspectedSource=n,this.fromFields={},t.each(this.inspectedSource.items[0],function(e,t){r.fromFields[t]=t}),this.$(".from-data thead").empty(),this.$(".from-data tbody").empty(),this.$(".to-data thead").empty(),this.$(".to-data tbody").empty();var i=0;for(var s in this.fromFields){var o=this.fromFieldTemplate.clone();o.removeClass("element-template"),e(".field-name",o).text(s),e(".label",o).css("background-color",this.fromFieldColors[i%this.fromFieldColors.length]),e(".from-field",o).attr("data-from",s),this.$(".from-data thead").append(o).show(),i++}t.each(this.inspectedSource.items,function(e){var n="";t.each(r.fromFields,function(t,r){n+="<td>"+e[r]+"</td>"}),r.$(".from-data tbody").append("<tr>"+n+"</tr>")});var u=function(t){e(".show-field-settings",t).hide()};this.updateHandleStates();for(var s in this.toFields){var o=this.toFieldTemplate.clone();o.removeClass("element-template"),e(".field-title",o).text(this.toFields[s]),e(".to-field",o).attr("data-to",s),e(".field-settings",o).hide(),u(o),this.$(".to-data thead").append(o).show()}this.$(".to-field").sortable({connectWith:".to-field",stop:function(e,t){if(r.preventSortableEvents)return;r.loadImportPreview()}}),this.$(".from-field").draggable({revert:"invalid",helper:"clone",connectToSortable:".to-field",stack:".drag.label",start:function(t,n){r.preventSortableEvents=!0,e(n.helper).removeClass("half-opacity"),r.$(".to-field").addClass("highlight")},stop:function(e,t){r.preventSortableEvents=!1,r.$(".to-field").removeClass("highlight"),r.$(".to-data .from-field").removeClass("half-opacity"),r.updateHandleStates(),r.loadImportPreview()}})},render:function(){var t=this;e(this.el).html(this.template());var t=this;return this.spinner=this.$(".spinner").html((new Spinner({radius:6,length:0,width:6,color:"#333",lines:7,speed:1.5})).spin().el).hide(),this.setStep("source"),DEV&&(this.$("[name=url]").val("https://dl.dropbox.com/s/cb4blktkkelwg1n/nuclear_reactors.csv"),t.sourceSubmitButtonClicked()),this.sourceInputChanged(),this.fromFieldTemplate=this.$(".from-data thead .element-template"),this.toFieldTemplate=this.$(".to-data thead .element-template"),this.$(".element-template").remove(),this.$("input.text").click(function(){e(this).select()}),this},setStep:function(t){this.setAlert(),this.$(".step").each(function(){e(this).toggle(e(this).is("."+t))})},updateHandleStates:function(){var t=this,n=this.$(".to-data .from-field");this.$(".from-data .from-field").each(function(){for(var t=0;t<n.length;t++)if(e(n[t]).attr("data-from")==e(this).attr("data-from")){e(this).addClass("half-opacity");return}e(this).removeClass("half-opacity")}),this.$(".target").toggleClass("mapped",n.length>0)},fromFieldRemoveClicked:function(t){return e(t.currentTarget).closest(".from-field").remove(),this.updateHandleStates(),this.previousFieldDefs=null,this.loadImportPreview(),!1},setAlert:function(e){e?(this.$(".modal-body .alert").show(),this.$(".modal-body .alert").html(e)):this.$(".modal-body .alert").hide()},getFieldDefs:function(){var t={},n=!1;for(var r in this.toFields){var i=this.$(".to-field[data-to="+r+"] .from-field"),s={fromFields:[]};for(var o=0;o<i.length;o++)s.fromFields.push(e(i[o]).attr("data-from"));s.fromFields.length&&(t[r]=s,n=!0)}var u=[];return{fieldDefs:t,errors:u,valid:n}},runImport:function(n,r){var i=this,s,o,r=r||{};if(!n.inspect){s=this.getFieldDefs(),o=s.fieldDefs||[];if(s.errors.length){r.silent||this.setAlert("<ul><li>"+s.errors.join("</li></li>")+"</li></ul>");if(!n.preview)return!1}if(!s.valid&&n.preview){i.updateImportPreview([]);return}}this.previousFieldDefs=o;var n=t.extend({url:this.$("input[name=url]").val(),fields:o},n);console.log("Requesting import",n),this.setAlert(),this.setLoading(!0),this.request,this.request=e.ajax({type:"POST",url:"/api/import/",data:n,success:function(e){console.log("import response",e),i.setLoading(!1),n.preview&&i.updateImportPreview(e.items),r.success&&r.success(e)},error:function(t,s,o){i.setLoading(!1);var u=e.parseJSON(t.responseText),a=u&&u.errors?u.errors:u.error?{"":u}:null;console.error("import failed",a);var f="";if(a){for(var l in a)f+='<li><i class="icon icon-ban-circle"></i> '+a[l].message+"</li>";r.silent||i.setAlert("<ul>"+f+"</ul>")}n.preview&&i.updateImportPreview([]),r.error&&r.error(responseData)}})},setLoading:function(e){this.isLoading=e,this.$(".import-run").attr("disabled",e),this.$(".source-submit").attr("disabled",e),e?this.spinner.show():this.spinner.hide()},loadImportPreview:function(){if(this.previousFieldDefs&&t.isEqual(this.previousFieldDefs,this.getFieldDefs().fieldDefs))return;this.runImport({preview:!0,max:this.maxPreview},{silent:!0})},updateImportPreview:function(e){var t=this,n=e.reduce(function(e,n){var r="";if(n)for(var i in t.toFields){var s=undefined,o=undefined;if(typeof n[i]=="object"&&n[i].error){o="conversion-error";switch(n[i].name){case"ValueSkippedError":s=n[i].message;break;default:s=n[i].message}}else{switch(i){default:s=n[i];break;case"datetime":n[i]&&(s=new Date(n[i]),s&&(s=s.format(locale.formats.DATE_TIME)))}if(s==undefined||(typeof s=="string"||Array.isArray(s))&&!s.length)o="conversion-blank",s="blank"}r+="<td"+(o?' class="'+o+'"':"")+">"+s+"</td>"}return e.push("<tr>"+r+"</tr>"),e},[]);this.$(".to-data tbody").html(n.join(""))}});return u});