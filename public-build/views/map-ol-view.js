define(["jquery","underscore","backbone","config","utils","text!templates/map-ol.html","views/map-view-base","openlayers","cloudmade","stamen"],function(e,t,n,r,i,s,o,u){var a=u.Geometry,f=o.extend({tagName:"div",className:"map-view",_addFeatures:{},initialize:function(e){f.__super__.initialize.call(this,e),this.template=t.template(s),t.bindAll(this,"updateViewStyle"),e.vent.bind("updateViewStyle",this.updateViewStyle),t.bindAll(this,"updateViewBase"),e.vent.bind("updateViewBase",this.updateViewBase),this.externalProjection=new u.Projection("EPSG:4326"),this.internalProjection=null,u.ImgPath="/assets/openlayers-light/",this.featureLayers={}},getVisibleMapArea:function(){var e=this.map,t=e.getZoom(),n=e.getExtent(),r=e.getCenter(),i=new u.Geometry.Point(n.left,n.bottom),s=new u.Geometry.Point(n.right,n.top),o=Math.sqrt(Math.pow((s.x-i.x)/2,2)+Math.pow((s.y-i.y)/2,2))/1e3;i.transform(this.internalProjection,this.externalProjection),s.transform(this.internalProjection,this.externalProjection);var a=[[i.x,i.y],[s.x,s.y]];return r.transform(this.internalProjection,this.externalProjection),r=[r.lon,r.lat],{center:r,zoom:t,bounds:a,radius:o}},render:function(t,n){return e(this.el).html(this.template()),this},renderMap:function(e,t){var n=this;this.map=new u.Map({div:"map_canvas",displayProjection:this.externalProjection,scope:this,controls:[],eventListeners:{moveend:function(e){if(n.map.suppressMoveEnd){n.map.suppressMoveEnd=!1;return}n.visibleAreaChanged(n.getVisibleMapArea())}}}),this.map.addControls([new u.Control.PanZoomBar,new u.Control.Navigation]),this.updateViewBase(e,t);var r=new u.Control.ScaleLine;return this.map.addControl(r),this.map.addControl(new u.Control.Attribution),DEBUG&&this.map.addControl(new u.Control.MousePosition),this.internalProjection=this.map.baseLayer.projection,this.formats={geoJSON:new u.Format.GeoJSON({internalProjection:this.internalProjection,externalProjection:this.externalProjection,ignoreExtraDims:!0})},f.__super__.renderMap.call(this,e,t),this},attachLayer:function(e){this.initRenderLayer(e),f.__super__.attachLayer.call(this,e)},getStyleMapForLayer:function(e){var n=this,r=e.getLayerOptions(),i=function(e,t){return(e||e==0)&&e!=""&&(typeof e=="string"||e>=0)?e:t},s=r.opacity,o=i(r.featureSize,MAX_BUBBLE_SIZE),a=Math.min(o,i(r.minFeatureSize,MIN_BUBBLE_SIZE)),f={getColor:function(e){return e.attributes.color},getDarkerColor:function(e){return e.attributes.darkerColor},getBubbleRadius:function(e){return isNaN(e.attributes.size)?a*.5:(a+e.attributes.size*(o-a))*.5}},l={pointRadius:i(r.featureSize*.5,DEFAULT_POINT_RADIUS),fillColor:"${getColor}",fillOpacity:s,strokeDashstyle:r.strokeDashstyle,strokeLinecap:r.strokeLinecap,graphicZIndex:0,graphicName:null};switch(r.featureType){case FeatureType.GRAPHIC:l=t.extend(l,{externalGraphic:r.externalGraphic,graphicWidth:r.graphicWidth,graphicHeight:r.graphicHeight});default:case FeatureType.POINTS:l=t.extend(l,{strokeColor:i(r.strokeColor,"${getDarkerColor}"),strokeWidth:i(r.strokeWidth,DEFAULT_FEATURE_STROKE_WIDTH),strokeOpacity:i(r.strokeOpacity,s*.8)});break;case FeatureType.SQUARE_TILES:l=t.extend(l,{strokeColor:i(r.strokeColor,"${getDarkerColor}"),strokeWidth:i(r.strokeWidth,DEFAULT_FEATURE_STROKE_WIDTH),strokeOpacity:i(r.strokeOpacity,s*.8)});break;case FeatureType.SHAPES:l=t.extend(l,{strokeColor:i(r.strokeColor,"${getColor}"),strokeWidth:i(r.strokeWidth,DEFAULT_FEATURE_STROKE_WIDTH),strokeOpacity:i(r.strokeOpacity,s)});break;case FeatureType.BUBBLES:l=t.extend(l,{pointRadius:"${getBubbleRadius}",strokeColor:i(r.strokeColor,"${getDarkerColor}"),strokeWidth:i(r.strokeWidth,DEFAULT_FEATURE_STROKE_WIDTH),strokeOpacity:i(r.strokeOpacity,s*.5)})}var c={fillOpacity:l.fillOpacity==1?.8:Math.min(1,l.fillOpacity*1.5),strokeOpacity:l.strokeOpacity==1?.1:Math.min(1,l.strokeOpacity*1.5),graphicZIndex:100},h=new u.StyleMap({"default":new u.Style(l,{context:f}),select:new u.Style(c,{context:f})});return h},layerToggled:function(e){this.featureLayers[e.id].setVisibility(e.isEnabled())},layerChanged:function(e){var t=this.featureLayers[e.id];if(e.hasChanged("layerOptions.htmlRenderer")){this.destroyRenderLayer(e),this.initRenderLayer(e),this.featureReset(e.featureCollection);return}t.styleMap=this.getStyleMapForLayer(e),e.hasChangedColors()||e.hasChanged("layerOptions.featureType")||e.hasChanged("layerOptions.featureTypeFallback")||e.hasChanged("layerOptions.attrMap.numeric")||e.hasChanged("layerOptions.attrMap.featureSize")||e.hasChanged("layerOptions.attrMap.featureColor")?this.featureReset(e.featureCollection):t.redraw()},drawLayer:function(e){this._addFeatures[e.id]&&this._addFeatures[e.id].length&&(this.featureLayers[e.id].addFeatures(this._addFeatures[e.id]),delete this._addFeatures[e.id])},initRenderLayer:function(e){var t=this,n=e.getLayerOptions(),r=new u.Layer.Vector(e.id,{styleMap:this.getStyleMapForLayer(e),renderers:[n.htmlRenderer&&n.htmlRenderer!=""?n.htmlRenderer:"SVG","SVG","VML","Canvas"],wrapDateLine:!0,rendererOptions:{}});this.featureLayers[e.id]=r,r.setVisibility(e.isEnabled()),this.map.addLayers([r]);var i=new u.Control.SelectFeature(r,{clickout:!0,multiple:!1,hover:!1,box:!1,onBeforeSelect:function(e){},onSelect:function(e){t.featureSelected(e)},onUnselect:function(e){t.featureUnselected(e)}});this.map.addControl(i),i.activate(),i.handlers.feature.stopDown=!1},destroyRenderLayer:function(e){this.featureLayers[e.id].destroyFeatures(),this.map.removeLayer(this.featureLayers[e.id]),delete this.featureLayers[e.id]},destroyLayer:function(e){this.destroyRenderLayer(e),f.__super__.destroyLayer.call(this,e)},featureReset:function(e,t){this.featureLayers[e.mapLayer.id].destroyFeatures(),f.__super__.featureReset.call(this,e,t)},featureAdd:function(e,t,n){var t=e.collection,r=e.getRenderAttributes(),i=t.mapLayer.attributes.layerOptions,s;switch(i.featureType){case FeatureType.POINTS:case FeatureType.BUBBLES:s=this.formats.geoJSON.parseGeometry({type:"Point",coordinates:e.getCenter()});break;case FeatureType.SQUARE_TILES:if(!i.featureTypeFallback||e.attributes.geometry.type!="Point"){s=this.formats.geoJSON.parseGeometry({type:"Polygon",coordinates:[e.getBox()]});break};case FeatureType.SHAPES:s=this.formats.geoJSON.parseGeometry(e.attributes.geometry)}var o=new u.Feature.Vector(s,r);this._addFeatures[t.mapLayer.id]||(this._addFeatures[t.mapLayer.id]=[]),this._addFeatures[t.mapLayer.id].push(o)},featureRemove:function(e,t,n){},featureChange:function(e,t){},featureSelected:function(e){this.trigger("feature:select",e.attributes.model)},featureUnselected:function(e){this.trigger("feature:unselect",e.attributes.model)},updateViewBase:function(e,t){if(!e||!this.ViewBase[e])e=DEFAULT_MAP_VIEW_BASE;if(e==this.viewBase)return;this.baselayer&&this.map.removeLayer(this.baselayer.mapLayer),this.baselayer=new this.ViewBase[e](this.map,this,t||this.viewStyle),this.viewBase=e,this.viewStyles=this.baselayer.mapStyles,this.viewStyle=this.baselayer.mapStyle,this.defaultViewStyle=this.baselayer.defaultMapStyle,this.map.addLayer(this.baselayer.mapLayer),this.vent.trigger("viewOptionsChanged",this)},updateViewStyle:function(e){this.baselayer.setMapStyle&&this.baselayer.setMapStyle(e)&&(this.viewStyle=this.baselayer.mapStyle,this.vent.trigger("viewOptionsChanged",this))},setVisibleMapArea:function(e){var t=new u.LonLat(e.center[0],e.center[1]);t.transform(this.externalProjection,this.internalProjection),this.map.setCenter(t,e.zoom)},zoomToExtent:function(e){var t=new u.Bounds(e[0],e[1],e[2],e[3]);t.transform(this.externalProjection,this.internalProjection),this.map.zoomToExtent(t,!this.map.isValidZoomLevel(this.map.getZoomForExtent(t)))}}),l=f.prototype.Baselayer=u.Class({initialize:function(e,t,n){this.map=e,this.mapView=t,this.setMapStyle(n),this.initMapLayer()},initMapLayer:function(e){},setMapStyle:function(e){var t=this.mapStyle;return this.mapStyles&&this.mapStyles[e]?this.mapStyle=e:this.mapStyle=this.defaultMapStyle,t!=this.mapStyle?(this.mapLayer&&this.applyMapStyle(),!0):!1},applyMapStyle:function(){return this.mapLayer&&(this.map.removeLayer(this.mapLayer),this.map.suppressMoveEnd=!0,this.initMapLayer(!0),this.map.addLayer(this.mapLayer)),!0},mapStyles:null,defaultMapStyle:DEFAULT_MAP_STYLE,mapStyle:null}),c=f.prototype.ViewBase={};return c.gm=u.Class(l,{providerName:"Google Maps",initMapLayer:function(e){var t=this,n=this.mapLayer=new u.Layer.Google("Google Maps",{type:"styled",wrapDateLine:!0,sphericalMercator:!0,baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS});e||this.map.events.on({addlayer:function(e){e.layer.baselayer&&e.layer==n&&(t.applyMapStyle(),google.maps.event.addListenerOnce(e.layer.mapObject,"idle",function(){t.mapView.trigger("view:ready")}))}})},applyMapStyle:function(){var e="simplified";switch(this.mapStyle){case"dark":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:45},{invert_lightness:!0},{gamma:1.1}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"light":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:8},{gamma:1.31}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"full":var t=[{stylers:[]}]}var n=t,r={name:"Styled Map"},i=new google.maps.StyledMapType(n,r);this.mapLayer.mapObject.mapTypes.set("styled",i),this.mapLayer.mapObject.setMapTypeId("styled")},mapStyles:{dark:"Dark",light:"Light",full:"Full"}}),c.cm=u.Class(l,{providerName:"CloudMade",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new u.Layer.CloudMade("CloudMade",{key:CLOUDMADE_KEY,styleId:this.styleIds[this.mapStyle],baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.trigger("view:ready")}}})},mapStyles:{dark:"Dark",light:"Light",full:"Full"},styleIds:{dark:74569,light:74513,full:998}}),c.osm=u.Class(l,{providerName:"OpenStreetMap",initMapLayer:function(e,t){var n=this;this.mapLayer=this.mapLayer=new u.Layer.OSM(null,t,{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||n.mapView.trigger("view:ready")}}})},defaultMapStyle:null}),c.stm=u.Class(l,{providerName:"Stamen",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new u.Layer.Stamen(this.styleIds[this.mapStyle],{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.trigger("view:ready")}}})},mapStyles:{dark:"Toner",light:"Toner Lite",watercolor:"Watercolor"},styleIds:{dark:"toner",light:"toner-lite",watercolor:"watercolor"}}),c.blank=u.Class(l,{providerName:"Blank",initMapLayer:function(e){c.osm.prototype.initMapLayer.call(this,!1,"/assets/blank.gif")},mapStyles:{dark:"Dark",light:"Light"}}),f});