define(["jquery","underscore","backbone","config","utils","text!templates/map-ol.html","views/map-view-base","lib/openlayers/cloudmade"],function(e,t,n,r,i,s,o){var u=o.extend({tagName:"div",className:"map-view",addFeatures:{},initialize:function(e){u.__super__.initialize.call(this,e),this.template=t.template(s),t.bindAll(this,"updateViewStyle"),e.vent.bind("updateViewStyle",this.updateViewStyle),t.bindAll(this,"updateViewBase"),e.vent.bind("updateViewBase",this.updateViewBase),Feature=OpenLayers.Feature.Vector,Geometry=OpenLayers.Geometry,Rule=OpenLayers.Rule,Filter=OpenLayers.Filter,previousKey=0,scope=this,OpenLayers.ImgPath="/assets/openlayers-light/"},render:function(){return e(this.el).html(this.template()),this},getVisibleMapArea:function(){var e=this.map,t=e.getZoom(),n=e.getExtent(),r=e.getCenter();r.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var i=new OpenLayers.Geometry.Point(n.left,n.bottom);i.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var s=new OpenLayers.Geometry.Point(n.right,n.top);s.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));var o=[[i.x,i.y],[s.x,s.y]];return{center:[r.lon,r.lat],zoom:t,bounds:o}},start:function(e,t){var n=this;map_controls=[new OpenLayers.Control.PanZoomBar,new OpenLayers.Control.Navigation],this.map=new OpenLayers.Map({div:"map_canvas",projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),numZoomLevels:MAP_NUM_ZOOM_LEVELS,controls:map_controls,scope:this,eventListeners:{moveend:function(e){n.mapAreaChanged(n.getVisibleMapArea())}}}),this.updateViewBase(e,t);var r=new OpenLayers.Control.ScaleLine;this.map.addControl(r),this.map.addControl(new OpenLayers.Control.Attribution);var i=this.baselayer.mapLayer.resolutions,s=[];for(var o=0;o<i.length;o++){var a=new OpenLayers.Geometry.Point(i[o],0);s.push(a.transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326")).x)}DEBUG&&this.map.addControl(new OpenLayers.Control.MousePosition),u.__super__.start.call(this),this.add30kmtemp()},getItems:function(e,t,n){var r=this;e=new Geometry.Vector2(e,t),r.quadTreeRetrieve(e.x,e.y);if(t==null)return[];n*=n;for(var i=Number.MAX_VALUE,s=[],o=0;o<t.length;o++){var u=t[o],a=(e.x-u.x)*(e.x-u.x)+(e.y-u.y)*(e.y-u.y);a<n&&(s.push(u.id),a<i&&(i=a))}return s},addKMLLayer:function(e){kml=new OpenLayers.Layer.Vector("KML",{projection:new OpenLayers.Projection("EPSG:4326"),strategies:[new OpenLayers.Strategy.Fixed],renderers:["Canvas"],opacity:.3,protocol:new OpenLayers.Protocol.HTTP({url:e,format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})}),this.map.addLayers([kml])},destroyFeatureLayer:function(e){var t=e.pointCollectionId;this.featureLayers[t].destroyFeatures(),this.map.removeLayer(this.featureLayers[t]),this.featureLayers[t]=null},reset:function(e){var t=e.pointCollectionId;this.featureLayers[t].destroyFeatures(),u.__super__.reset.call(this,e)},initFeatureLayer:function(e){u.__super__.initFeatureLayer.call(this,e);var n=this,r=e.pointCollectionId,i={getColor:function(e){return e.attributes.color},getDarkerColor:function(e){return e.attributes.darkerColor},getBubbleRadius:function(e){return MIN_BUBBLE_SIZE+e.attributes.size*(MAX_BUBBLE_SIZE-MIN_BUBBLE_SIZE)/2},getStrokeWidth:function(e){return MIN_POLYGON_STROKE_WIDTH+e.attributes.size*(MAX_POLYGON_STROKE_WIDTH-MIN_POLYGON_STROKE_WIDTH)}},s,o={fillOpacity:DEFAULT_SELECTED_FEATURE_OPACITY,strokeColor:DEFAULT_SELECTED_STROKE_COLOR,strokeOpacity:1,strokeWidth:DEFAULT_SELECTED_STROKE_WIDTH},a={};switch(e.mapLayer.options.featureType){case FeatureType.POINTS:var f=new OpenLayers.Style({fillColor:"${getColor}",strokeColor:"${getDarkerColor}",pointRadius:DEFAULT_POINT_RADIUS,strokeWidth:DEFAULT_POINT_STROKE_WIDTH,fillOpacity:this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY,strokeOpacity:(this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY)*.8},{context:i});s=new OpenLayers.Layer.Vector(null,{projection:new OpenLayers.Projection("EPSG:4326"),sphericalMercator:!0,styleMap:new OpenLayers.StyleMap({"default":f,temporary:a,select:o}),renderers:["Canvas"],wrapDateLine:!0});break;default:case FeatureType.CELLS:var f=new OpenLayers.Style({fillColor:"${getColor}",fillOpacity:this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY,strokeOpacity:0},{context:i});s=new OpenLayers.Layer.Vector(null,{styleMap:new OpenLayers.StyleMap({"default":f,temporary:a,select:o}),renderers:["Canvas"],wrapDateLine:!0});break;case FeatureType.POLYGONS:var f=new OpenLayers.Style({fillColor:"${getColor}",fillOpacity:this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY,strokeOpacity:this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY,strokeColor:"${getColor}",strokeWidth:"${getStrokeWidth}"},{context:i}),o=new OpenLayers.Style(t.extend(o,{strokeColor:"${getColor}",strokeWidth:"${getStrokeWidth}"}),{context:i});s=new OpenLayers.Layer.Vector(null,{styleMap:new OpenLayers.StyleMap({"default":f,temporary:a,select:o}),renderers:["Canvas"],wrapDateLine:!0});break;case FeatureType.BUBBLES:var f=new OpenLayers.Style({pointRadius:"${getBubbleRadius}",strokeOpacity:0,fillColor:"${getColor}",fillOpacity:this.layerOptions[r].opacity!=null?this.layerOptions[r].opacity:DEFAULT_FEATURE_OPACITY},{context:i});s=new OpenLayers.Layer.Vector(null,{styleMap:new OpenLayers.StyleMap({"default":f,temporary:a,select:o}),renderers:["Canvas"],wrapDateLine:!0})}this.featureLayers[r]=s,this.map.addLayers([s]);var l=new OpenLayers.Control.SelectFeature(s,{clickout:!0,multiple:!1,hover:!1,box:!1,onBeforeSelect:function(e){},onSelect:function(e){n.featureSelected(e)},onUnselect:function(e){n.featureUnselected(e)}});this.map.addControl(l),l.activate()},add30kmtemp:function(){var e=new OpenLayers.Style({strokeColor:"#999999",pointRadius:7,fillOpacity:0,strokeOpacity:.8,strokeWidth:1},{context:{}});layer=new OpenLayers.Layer.Vector(null,{projection:new OpenLayers.Projection("EPSG:4326"),sphericalMercator:!0,styleMap:new OpenLayers.StyleMap({"default":e}),renderers:["Canvas"],wrapDateLine:!0}),this.map.addLayers([layer]);var t=new OpenLayers.Geometry.Point(141.033247,37.425252);t.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));var n,r=3e4,i=50,s=wktCircle(t,r,r,i),n=OpenLayers.Geometry.fromWKT(s),o=new OpenLayers.Feature.Vector(n,{});layer.addFeatures([o])},featureSelected:function(e){var t=e.attributes.model;this.vent.trigger("showDetailData",e.attributes.pointCollectionId,t)},featureUnselected:function(e){this.vent.trigger("hideDetailData",e.attributes.pointCollectionId)},addFeatureToLayer:function(e,t,n){var r=this.collections[n],i=e.get("loc"),s=e.get("extra"),o=i[0],u=i[1],a=new OpenLayers.Geometry.Point(o,u),f,l;switch(r.mapLayer.options.featureType){default:a.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")),l=a;break;case FeatureType.POLYGONS:s&&s.min&&s.min.endLoc&&(f=[a,new OpenLayers.Geometry.Point(s.min.endLoc[0],s.min.endLoc[1])]);case FeatureType.CELLS:if(!f){var c=r.gridSize/2;f=[new OpenLayers.Geometry.Point(a.x-c,a.y-c),new OpenLayers.Geometry.Point(a.x-c,a.y+c),new OpenLayers.Geometry.Point(a.x+c,a.y+c),new OpenLayers.Geometry.Point(a.x+c,a.y-c)]}var h=[];for(var p=0;p<f.length;p++){var a=f[p];a.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")),h.push(a.x+" "+a.y)}var d="POLYGON("+h.join(", ")+")",l=OpenLayers.Geometry.fromWKT(d)}var v=new OpenLayers.Feature.Vector(l,t);this.addFeatures[n]||(this.addFeatures[n]=[]),this.addFeatures[n].push(v)},drawLayerForCollection:function(e){var t=e.pointCollectionId;this.addFeatures[t]&&(this.featureLayers[t].addFeatures(this.addFeatures[t]),delete this.addFeatures[t]),this.featureLayers[t].redraw()},toggleLayerVisibility:function(e,t){this.featureLayers[e].setVisibility(t)},updateViewBase:function(e,t){if(!e||!this.ViewBase[e])e=DEFAULT_MAP_VIEW_BASE;if(e==this.viewBase)return;this.baselayer&&this.map.removeLayer(this.baselayer.mapLayer),this.baselayer=new this.ViewBase[e](this.map,this,t||this.viewStyle),this.viewBase=e,this.viewStyles=this.baselayer.mapStyles,this.viewStyle=this.baselayer.mapStyle,console.log(this.viewStyle,"viewStyle"),this.defaultViewStyle=this.baselayer.defaultMapStyle,this.map.addLayer(this.baselayer.mapLayer),this.vent.trigger("viewOptionsChanged",this)},updateViewStyle:function(e){this.baselayer.setMapStyle&&this.baselayer.setMapStyle(e)&&(this.viewStyle=this.baselayer.mapStyle,this.vent.trigger("viewOptionsChanged",this))},redrawMapLayer:function(e){u.__super__.redrawMapLayer.call(this,e);var t=e.pointCollection._id;this.destroyFeatureLayer(this.collections[t]),this.addCollectionToMap(this.collections[t])},toWebMercator:function(t){props=[];for(prop in t)t.hasOwnProperty(prop)&&props.push(prop);return e.each(t,function(e,t){e==props[0]?lat=t:e==props[1]&&(lng=t)}),translation=new Geometry.Point(lng,lat),translation.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")),[translation.x,translation.y]},setVisibleMapArea:function(e){var t,n;console.log("setVisibleMapArea",e);switch(e.type){case"google":var r=e[0],t=this.toWebMercator(r.geometry.location),i=r.geometry.viewport,s=i.getSouthWest(),o=i.getNorthEast(),u=this.toWebMercator(s),a=this.toWebMercator(o),n=this.map.getZoomForExtent(new OpenLayers.Bounds(u[0],u[1],a[0],a[1]));break;default:translation=new Geometry.Point(e.center[0],e.center[1]),translation.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913")),t=[translation.x,translation.y],e.zoom!=undefined&&(n=e.zoom)}t&&this.map.setCenter(new OpenLayers.LonLat(t[0],t[1]),n)}}),a=u.prototype.Baselayer=OpenLayers.Class({initialize:function(e,t,n){this.map=e,this.mapView=t,this.setMapStyle(n),this.initMapLayer()},initMapLayer:function(e){},setMapStyle:function(e){var t=this.mapStyle;return this.mapStyles&&this.mapStyles[e]?this.mapStyle=e:this.mapStyle=this.defaultMapStyle,t!=this.mapStyle?(this.mapLayer&&this.applyMapStyle(),!0):!1},applyMapStyle:function(){return this.mapLayer&&(this.map.removeLayer(this.mapLayer),this.initMapLayer(!0),this.map.addLayer(this.mapLayer)),!0},mapStyles:null,defaultMapStyle:DEFAULT_MAP_STYLE,mapStyle:null}),f=u.prototype.ViewBase={};return f.gm=OpenLayers.Class(a,{providerName:"Google Maps",initMapLayer:function(e){var t=this,n=this.mapLayer=new OpenLayers.Layer.Google("Google Maps",{type:"styled",wrapDateLine:!0,sphericalMercator:!0,baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS});e||this.map.events.on({addlayer:function(e){e.layer.baselayer&&e.layer==n&&(t.applyMapStyle(),google.maps.event.addListenerOnce(e.layer.mapObject,"idle",function(){t.mapView.vent.trigger("mapViewReady")}))}})},applyMapStyle:function(){var e="simplified";switch(this.mapStyle){case"dark":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:45},{invert_lightness:!0},{gamma:1.1}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"light":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:8},{gamma:1.31}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"full":var t=[{stylers:[]}]}var n=t,r={name:"Styled Map"},i=new google.maps.StyledMapType(n,r);this.mapLayer.mapObject.mapTypes.set("styled",i),this.mapLayer.mapObject.setMapTypeId("styled")},mapStyles:{dark:"Dark",light:"Light",full:"Full"}}),f.cm=OpenLayers.Class(a,{providerName:"CloudMade",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new OpenLayers.Layer.CloudMade("CloudMade",{key:CLOUDMADE_KEY,styleId:this.styleIds[this.mapStyle],baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.vent.trigger("mapViewReady")}}})},mapStyles:{dark:"Dark",light:"Light",full:"Full"},styleIds:{dark:74569,light:74513,full:998}}),f.osm=OpenLayers.Class(a,{providerName:"OpenStreetMap",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new OpenLayers.Layer.OSM(null,null,{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.vent.trigger("mapViewReady")}}})},defaultMapStyle:null}),f.stm=OpenLayers.Class(a,{providerName:"Stamen",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new OpenLayers.Layer.Stamen(this.styleIds[this.mapStyle],{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.vent.trigger("mapViewReady")}}})},mapStyles:{dark:"Toner",light:"Toner Lite",watercolor:"Watercolor"},styleIds:{dark:"toner",light:"toner-lite",watercolor:"watercolor"}}),u});