define(["jquery","underscore","backbone","config","utils","text!templates/map-ol.html","views/map-view-base","openlayers","cloudmade","stamen"],function(e,t,n,r,i,s,o,u){var a=u.Geometry,f=o.extend({tagName:"div",className:"map-view",_addFeatures:{},initialize:function(e){f.__super__.initialize.call(this,e),this.template=t.template(s),t.bindAll(this,"updateViewStyle"),e.vent.bind("updateViewStyle",this.updateViewStyle),t.bindAll(this,"updateViewBase"),e.vent.bind("updateViewBase",this.updateViewBase),u.ImgPath="/assets/openlayers-light/",this.featureLayers={}},getVisibleMapArea:function(){var e=this.map;zoom=e.getZoom(),extent=e.getExtent(),center=e.getCenter(),center.transform(new u.Projection("EPSG:900913"),new u.Projection("EPSG:4326"));var t=new u.Geometry.Point(extent.left,extent.bottom);t.transform(new u.Projection("EPSG:900913"),new u.Projection("EPSG:4326"));var n=new u.Geometry.Point(extent.right,extent.top);n.transform(new u.Projection("EPSG:900913"),new u.Projection("EPSG:4326"));var r=[[t.x,t.y],[n.x,n.y]];return{center:[center.lon,center.lat],zoom:zoom,bounds:r}},render:function(t,n){return e(this.el).html(this.template()),this},renderMap:function(e,t){var n=this;this.map=new u.Map({div:"map_canvas",projection:new u.Projection("EPSG:900913"),displayProjection:new u.Projection("EPSG:4326"),numZoomLevels:MAP_NUM_ZOOM_LEVELS,scope:this,controls:[],eventListeners:{moveend:function(e){if(n.map.suppressMoveEnd){n.map.suppressMoveEnd=!1;return}n.visibleAreaChanged(n.getVisibleMapArea())}}}),this.map.addControls([new u.Control.PanZoomBar,new u.Control.Navigation]),this.updateViewBase(e,t);var r=new u.Control.ScaleLine;this.map.addControl(r),this.map.addControl(new u.Control.Attribution);var i=this.baselayer.mapLayer.resolutions,s=[];for(var o=0;o<i.length;o++){var a=new u.Geometry.Point(i[o],0);s.push(a.transform(new u.Projection("EPSG:900913"),new u.Projection("EPSG:4326")).x)}return DEBUG&&this.map.addControl(new u.Control.MousePosition),this.add30kmtemp(),f.__super__.renderMap.call(this,e,t),this},addKMLLayer:function(e){kml=new u.Layer.Vector("KML",{projection:new u.Projection("EPSG:4326"),strategies:[new u.Strategy.Fixed],renderers:["Canvas"],opacity:.3,protocol:new u.Protocol.HTTP({url:e,format:new u.Format.KML({extractStyles:!0,extractAttributes:!0,maxDepth:2})})}),this.map.addLayers([kml])},attachLayer:function(e){var t=this,n=new u.Layer.Vector(e.id,{styleMap:this.getStyleMapForLayer(e),renderers:["Canvas"],wrapDateLine:!0,rendererOptions:{zIndexing:!0}});this.featureLayers[e.id]=n,n.setVisibility(e.isEnabled()),this.map.addLayers([n]);var r=new u.Control.SelectFeature(n,{clickout:!0,multiple:!1,hover:!1,box:!1,onBeforeSelect:function(e){},onSelect:function(e){t.featureSelected(e)},onUnselect:function(e){t.featureUnselected(e)}});this.map.addControl(r),r.activate(),r.handlers.feature.stopDown=!1,f.__super__.attachLayer.call(this,e)},getStyleMapForLayer:function(e){var n=this,r=e.getDisplay("opacity"),i=e.attributes.layerOptions,s={getColor:function(e){return e.attributes.color},getDarkerColor:function(e){return e.attributes.darkerColor},getBubbleRadius:function(e){return MIN_BUBBLE_SIZE+e.attributes.size*(MAX_BUBBLE_SIZE-MIN_BUBBLE_SIZE)/2},getStrokeWidth:function(e){return MIN_POLYGON_STROKE_WIDTH+e.attributes.size*(MAX_POLYGON_STROKE_WIDTH-MIN_POLYGON_STROKE_WIDTH)}},o={fillOpacity:r,graphicZIndex:0},a={fillOpacity:DEFAULT_SELECTED_FEATURE_OPACITY,strokeColor:DEFAULT_SELECTED_STROKE_COLOR,strokeOpacity:DEFAULT_SELECTED_STROKE_OPACITY,strokeWidth:DEFAULT_SELECTED_STROKE_WIDTH,graphicZIndex:100},f={};switch(i.featureType){case FeatureType.GRAPHIC:o=t.extend(o,{externalGraphic:i.externalGraphic,graphicWidth:i.graphicWidth,graphicHeight:i.graphicHeight});default:case FeatureType.POINTS:o=t.extend(o,{fillColor:"${getColor}",strokeColor:"${getDarkerColor}",pointRadius:DEFAULT_POINT_RADIUS,strokeWidth:DEFAULT_POINT_STROKE_WIDTH,strokeOpacity:r*.8});break;case FeatureType.CELLS:o=t.extend(o,{fillColor:"${getColor}",strokeOpacity:0});break;case FeatureType.SHAPES:o=t.extend(o,{fillColor:"${getColor}",fillOpacity:r,strokeOpacity:r,strokeColor:"${getColor}",strokeWidth:"${getStrokeWidth}"}),a=t.extend(a,{strokeColor:"${getColor}",strokeWidth:"${getStrokeWidth}"});break;case FeatureType.BUBBLES:o=t.extend(o,{fillColor:"${getColor}",pointRadius:"${getBubbleRadius}",strokeColor:"${getDarkerColor}",strokeWidth:DEFAULT_POINT_STROKE_WIDTH,strokeOpacity:r*.5})}return new u.StyleMap({"default":new u.Style(o,{context:s}),select:new u.Style(a,{context:s})})},layerToggled:function(e){this.featureLayers[e.id].setVisibility(e.isEnabled())},layerChanged:function(e){var t=this.featureLayers[e.id];t.styleMap=this.getStyleMapForLayer(e),e.hasChangedColors()||e.hasChanged("layerOptions.featureType")||e.hasChanged("layerOptions.featureSizeAttr")||e.hasChanged("layerOptions.featureColorAttr")?this.featureReset(e.featureCollection):t.redraw()},drawLayer:function(e){this._addFeatures[e.id]&&this._addFeatures[e.id].length&&(this.featureLayers[e.id].addFeatures(this._addFeatures[e.id]),delete this._addFeatures[e.id])},destroyLayer:function(e){this.featureLayers[e.id].destroyFeatures(),this.map.removeLayer(this.featureLayers[e.id]),delete this.featureLayers[e.id],f.__super__.destroyLayer.call(this,e)},featureReset:function(e,t){this.featureLayers[e.mapLayer.id].destroyFeatures(),f.__super__.featureReset.call(this,e,t)},featureAdd:function(e,t,n){var t=e.collection,r=e.getRenderAttributes(),i=e.get("loc"),s=i[0],o=i[1],a=new u.Geometry.Point(s,o),f,l;switch(t.mapLayer.attributes.layerOptions.featureType){case FeatureType.POINTS:default:a.transform(new u.Projection("EPSG:4326"),new u.Projection("EPSG:900913")),l=a;break;case FeatureType.POLYGONS:case FeatureType.CELLS:if(!f){var c=t.gridSize/2;f=[new u.Geometry.Point(a.x-c,a.y-c),new u.Geometry.Point(a.x-c,a.y+c),new u.Geometry.Point(a.x+c,a.y+c),new u.Geometry.Point(a.x+c,a.y-c)]}var h=[];for(var p=0;p<f.length;p++){var a=f[p];a.transform(new u.Projection("EPSG:4326"),new u.Projection("EPSG:900913")),h.push(a.x+" "+a.y)}var d="POLYGON("+h.join(", ")+")",l=u.Geometry.fromWKT(d)}var v=new u.Feature.Vector(l,r);this._addFeatures[t.mapLayer.id]||(this._addFeatures[t.mapLayer.id]=[]),this._addFeatures[t.mapLayer.id].push(v)},featureRemove:function(e,t,n){},featureChange:function(e,t){},add30kmtemp:function(){var e=new u.Style({strokeColor:"#999999",pointRadius:7,fillOpacity:0,strokeOpacity:.8,strokeWidth:1},{context:{}});layer=new u.Layer.Vector(null,{projection:new u.Projection("EPSG:4326"),sphericalMercator:!0,styleMap:new u.StyleMap({"default":e}),renderers:["Canvas"],wrapDateLine:!0}),this.map.addLayers([layer]);var t=new u.Geometry.Point(141.033247,37.425252);t.transform(new u.Projection("EPSG:4326"),new u.Projection("EPSG:900913"));var n,r=3e4,i=50,s=wktCircle(t,r,r,i),n=u.Geometry.fromWKT(s),o=new u.Feature.Vector(n,{});layer.addFeatures([o])},featureSelected:function(e){this.trigger("feature:select",e.attributes.model)},featureUnselected:function(e){this.trigger("feature:unselect",e.attributes.model)},updateViewBase:function(e,t){if(!e||!this.ViewBase[e])e=DEFAULT_MAP_VIEW_BASE;if(e==this.viewBase)return;this.baselayer&&this.map.removeLayer(this.baselayer.mapLayer),this.baselayer=new this.ViewBase[e](this.map,this,t||this.viewStyle),this.viewBase=e,this.viewStyles=this.baselayer.mapStyles,this.viewStyle=this.baselayer.mapStyle,this.defaultViewStyle=this.baselayer.defaultMapStyle,this.map.addLayer(this.baselayer.mapLayer),this.vent.trigger("viewOptionsChanged",this)},updateViewStyle:function(e){this.baselayer.setMapStyle&&this.baselayer.setMapStyle(e)&&(this.viewStyle=this.baselayer.mapStyle,this.vent.trigger("viewOptionsChanged",this))},toWebMercator:function(t){props=[];for(prop in t)t.hasOwnProperty(prop)&&props.push(prop);return e.each(t,function(e,t){e==props[0]?lat=t:e==props[1]&&(lng=t)}),translation=new a.Point(lng,lat),translation.transform(new u.Projection("EPSG:4326"),new u.Projection("EPSG:900913")),[translation.x,translation.y]},setVisibleMapArea:function(e){var t,n;console.log("setVisibleMapArea",e);switch(e.type){case"google":var r=e[0],t=this.toWebMercator(r.geometry.location),i=r.geometry.viewport,s=i.getSouthWest(),o=i.getNorthEast(),f=this.toWebMercator(s),l=this.toWebMercator(o),n=this.map.getZoomForExtent(new u.Bounds(f[0],f[1],l[0],l[1]));break;default:translation=new a.Point(e.center[0],e.center[1]),translation.transform(new u.Projection("EPSG:4326"),new u.Projection("EPSG:900913")),t=[translation.x,translation.y],e.zoom!=undefined&&(n=e.zoom)}t&&this.map.setCenter(new u.LonLat(t[0],t[1]),n)}}),l=f.prototype.Baselayer=u.Class({initialize:function(e,t,n){this.map=e,this.mapView=t,this.setMapStyle(n),this.initMapLayer()},initMapLayer:function(e){},setMapStyle:function(e){var t=this.mapStyle;return this.mapStyles&&this.mapStyles[e]?this.mapStyle=e:this.mapStyle=this.defaultMapStyle,t!=this.mapStyle?(this.mapLayer&&this.applyMapStyle(),!0):!1},applyMapStyle:function(){return this.mapLayer&&(this.map.removeLayer(this.mapLayer),this.map.suppressMoveEnd=!0,this.initMapLayer(!0),this.map.addLayer(this.mapLayer)),!0},mapStyles:null,defaultMapStyle:DEFAULT_MAP_STYLE,mapStyle:null}),c=f.prototype.ViewBase={};return c.gm=u.Class(l,{providerName:"Google Maps",initMapLayer:function(e){var t=this,n=this.mapLayer=new u.Layer.Google("Google Maps",{type:"styled",wrapDateLine:!0,sphericalMercator:!0,baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS});e||this.map.events.on({addlayer:function(e){e.layer.baselayer&&e.layer==n&&(t.applyMapStyle(),google.maps.event.addListenerOnce(e.layer.mapObject,"idle",function(){t.mapView.trigger("view:ready")}))}})},applyMapStyle:function(){var e="simplified";switch(this.mapStyle){case"dark":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:45},{invert_lightness:!0},{gamma:1.1}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"light":var t=[{stylers:[{saturation:-100},{visibility:e},{lightness:8},{gamma:1.31}]},{elementType:"labels",stylers:[{visibility:"off"}]}];break;case"full":var t=[{stylers:[]}]}var n=t,r={name:"Styled Map"},i=new google.maps.StyledMapType(n,r);this.mapLayer.mapObject.mapTypes.set("styled",i),this.mapLayer.mapObject.setMapTypeId("styled")},mapStyles:{dark:"Dark",light:"Light",full:"Full"}}),c.cm=u.Class(l,{providerName:"CloudMade",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new u.Layer.CloudMade("CloudMade",{key:CLOUDMADE_KEY,styleId:this.styleIds[this.mapStyle],baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.trigger("view:ready")}}})},mapStyles:{dark:"Dark",light:"Light",full:"Full"},styleIds:{dark:74569,light:74513,full:998}}),c.osm=u.Class(l,{providerName:"OpenStreetMap",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new u.Layer.OSM(null,null,{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.trigger("view:ready")}}})},defaultMapStyle:null}),c.stm=u.Class(l,{providerName:"Stamen",initMapLayer:function(e){var t=this;this.mapLayer=this.mapLayer=new u.Layer.Stamen(this.styleIds[this.mapStyle],{baselayer:!0,numZoomLevels:MAP_NUM_ZOOM_LEVELS,eventListeners:{loadend:function(){e||t.mapView.trigger("view:ready")}}})},mapStyles:{dark:"Toner",light:"Toner Lite",watercolor:"Watercolor"},styleIds:{dark:"toner",light:"toner-lite",watercolor:"watercolor"}}),f});