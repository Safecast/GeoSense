define(["jquery","underscore","backbone","config","utils","permissions","models/map-layer","views/panel-view-base","views/map-layer-view","mixins/scroll-paginator-mixin","mixins/spinner-mixin","collections/geo-feature-collections"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=u.extend({draggable:!1,events:{"submit form.search, keypress form.search .search-query":"searchClicked","click button.remove-query":"removeQueryClicked"},subViewContainer:".collections-list",prevQuery:"",dataCollectionsFetched:!1,initialize:function(e){h.__super__.initialize.apply(this,arguments),this.collection=new c},loadNextPage:function(e){if(this.isLoading||this.isLastPage)return;var t=this;this.searchParams.p++,this.fetchResults(this.searchParams,function(e,n,r){t.updateFeatureCollectionList(!1)})},render:function(){var t=this;return h.__super__.render.call(this),this.$("form.search .search-query").on("click",function(){e(this).select()}),this.$("form.search .search-query").keyup(function(){}),this.initScrollable(this.$(this.subViewContainer).parent(),this.$(this.subViewContainer),30),this.initSpinner(this.$(".state-indicator")),this.$removeQueryParent=this.$("button.remove-query").parent(),this.$removeQueryButton=this.$("button.remove-query").remove(),s.currentUser()||(this.$('.nav-tabs li[data-type="user"]').removeClass("active").remove(),this.$('.nav-tabs li[data-type="public"]').addClass("active")),this.$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){t.searchClicked()}),this},searchClicked:function(e){var t=this.$(".search-query").val();return this.resetPageParams(),this.searchParams.q=t,t!=""?this.$removeQueryParent.append(this.$removeQueryButton):this.$removeQueryButton.remove(),this.fetchResults(this.searchParams),self.$(".search-query").focus(),!1},removeQueryClicked:function(e){this.$(".search-query").val("")},removeSubViews:function(e){h.__super__.removeSubViews.apply(this,arguments),this.$(".status-message").text(e)},updateFeatureCollectionList:function(e){var t=this,n=this.collection;e&&this.removeSubViews(),n.each(function(e,n){var r=(new o({featureCollection:e.attributes,layerOptions:e.attributes.defaults})).initCollections(),i=new a({model:r});r.isEnabled=function(){return!0},i.expandContent=!1,i.expandLayerDetails=!0,i.legendViewOptions.autoHide=!1,i.once("expand",function(){setTimeout(function(){r.fetchGraphs()},500)}),t.appendSubView(i).render(),t.mapLayerViewPostRender(i),i.$el.hide().slideDown("fast")});var r=this.numResults();this.isLastPage||(r+="+"),this.$(".status-message").text(r==1?__("%(num)s collection found",{num:r}):__("%(num)s collections found",{num:r}))},mapLayerViewPostRender:function(e){},numResults:function(){return this.$(this.subViewContainer).children().length},fetchResults:function(e,t,n){var r=this;return r.isLoading=!0,r.showSpinner(),this.dataCollectionsFetched=!0,e.t=this.$(".nav-tabs .active").attr("data-type"),this.collection.fetch({data:e,success:function(e,n,i){r.isLoading=!1,r.hideSpinner(),e.length?r.$(".no-objects").addClass("hidden"):r.$(".no-objects").removeClass("hidden").hide().fadeIn("fast");if(!e.length||e.length<r.searchParams.l)r.isLastPage=!0;t?t(e,n,i):r.updateFeatureCollectionList(!0)},error:function(e,t,i){console.error("failed to fetch collections"),r.isLoading=!1,r.hideSpinner(),n&&n(e,t,i)}}),this}});return t.extend(h.prototype,f),t.extend(h.prototype,l),h});