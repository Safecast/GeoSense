define(["jquery","underscore","backbone","config","utils","d3","lib/color-gradient/color-gradient"],function(e,n,r,i,s,o,u){var a=r.View.extend({tagName:"div",className:"data-inspector",events:{"click #removeData":"removeDataClicked","click #editData":"editDataClicked","click #updateData":"updateDataClicked","click .color-type":"colorTypeChanged","click .feature-type":"featureTypeChanged","click #colorInput":"colorInputClicked","click .visibility":"visibilityChanged"},initialize:function(e){this.vent=e.vent,this.title=e.mapLayer.pointCollection.title,this.collection=e.collection,this.mapLayer=e.mapLayer,this.colors=[],this.colorType=null,this.featureType=null,this.visible=!0,this.collection.bind("add",this.addOne,this),this.collection.bind("reset",this.addAll,this),n.bindAll(this,"setStateType"),this.vent.bind("setStateType",this.setStateType),n.bindAll(this,"toggleValFormatter"),this.vent.bind("toggleValFormatter",this.toggleValFormatter),n.bindAll(this,"toggleLayerVisibility"),e.vent.bind("toggleLayerVisibility",this.toggleLayerVisibility)},setStateType:function(e,t){if(!t||t!=this.mapLayer.pointCollection._id)return;this.updateStatus();switch(this.mapLayer.pointCollection.status){case DataStatus.COMPLETE:this.showLegend(!0)}var n=this.$(".state-indicator");if(n.length)switch(e){default:n.stop().fadeIn(0),n.addClass("loading"),this.$(".visibility.toggle").stop().fadeTo(0,0);break;case"complete":n.stop().fadeOut(300,function(){n.removeClass("loading")}),this.$(".visibility.toggle").stop().fadeTo(300,1)}},updateStatus:function(){var e="",t="",n=this.mapLayer.pointCollection.progress;switch(this.mapLayer.pointCollection.status){case DataStatus.COMPLETE:if(this.mapLayer.sessionOptions.visible)if(this.collection.fetched){e=__("%(number)i of %(total)i",{number:formatLargeNumber(this.collection.originalCount),total:formatLargeNumber(this.collection.fullCount)}),this.mapLayer.pointCollection.sync&&(e+=' <span class="updated micro">'+__("updated %(date)s",{date:(new Date(this.mapLayer.pointCollection.reduce?this.mapLayer.pointCollection.updatedAt<this.mapLayer.pointCollection.lastReducedAt||!this.mapLayer.pointCollection.lastReducedAt?this.mapLayer.pointCollection.updatedAt:this.mapLayer.pointCollection.lastReducedAt:this.mapLayer.pointCollection.updatedAt)).format(locale.formats.DATE_SHORT)})+"</span>");var r=this.collection.url();e+=' <a target="_blank" class="download-collection '+this.mapLayer.pointCollection._id+'" href="'+r+'"><span class="icon icon-white icon-download half-opacity"></span></a>'}else e="loading…";else e="";break;case DataStatus.IMPORTING:e=__(n?"importing… %(count)s":"importing…",{count:formatLargeNumber(this.mapLayer.pointCollection.progress)});break;case DataStatus.UNREDUCED:case DataStatus.UNREDUCED_INC:e=__("queued for crunching…");break;case DataStatus.REDUCING:if(this.mapLayer.pointCollection.numBusy){var i=Math.floor(n/this.mapLayer.pointCollection.numBusy*100);e=__(n?"crunching… %(percent)s%":"crunching…",{percent:i}),this.$(".progress .bar").css("width",i+"%"),this.$(".progress").show()}else e=__("crunching…",{})}var s=this.$(".status"),o=s.text();e==""?s.hide("fast"):s.show("fast"),s.html(e+(e==""&&o!=""?"&nbsp;":""))},updateToggleState:function(e){var t=this;e==undefined&&(e=t.$(".collapse").is(".in")),e?(t.$(".icon.in-out").removeClass("out"),t.$(".icon.in-out").addClass("in")):(t.$(".icon.in-out").addClass("out"),t.$(".icon.in-out").removeClass("in"))},render:function(){var t=this;return e(this.el).html(this.template()),this.$(".status").hide(),e(this.el).addClass(this.mapLayer.pointCollection._id),this.title!=""?dataTitle=this.title:dataTitle="Untitled Data",this.updateStatus(),this.$(".title").html(dataTitle),this.$(".accordion-toggle").attr("href","#collapse-"+this.className+"-"+this.mapLayer.pointCollection._id),this.$(".collapse").attr("id","collapse-"+this.className+"-"+this.mapLayer.pointCollection._id),this.$(".collapse").on("show",function(e){t.updateToggleState(!0),t.visible||(console.log("set to visible"),t.visible=!0,t.visibilityChanged())}),this.$(".collapse").on("hide",function(){t.updateToggleState(!1)}),app.isMapAdmin()||this.$("#adminDataControls").remove(),this.setParameters(),this},initHistogram:function(){var t=this,n=t.$(".histogram");n.show();if(!n.length)return;if(!this.histogramData){e.ajax({type:"GET",url:"/api/histogram/"+this.mapLayer.pointCollection._id,success:function(e){t.histogramData=e,t.initHistogram()},error:function(){console.error("failed to fetch histogram")}});return}var r=this.histogramData,i=r.length,s=t.mapLayer.pointCollection.maxVal,a=n.innerHeight(),f=n.innerWidth(),l=r[0].y,c=r[0].y,h=[],p=[];for(var d=1;d<i;d++)l=Math.max(l,r[d].y),c=Math.min(c,r[d].y);var v=c!=0?c:1,m=v/l,g;t.mapLayer.options.cropDistribution&&(g=1/a*CROP_DISTRIBUTION_RATIO);var y,b=!g||m>g?l:v*1/g,p=[],w=new u(this.histogramColors||this.colors),E;for(var d=0;d<i;d++)(y==null||r[d].val<y)&&p.push(r[d].y);n.html("");var S=o.select(n[0]).append("svg").attr("class","chart").attr("width",f).attr("height",a),x=o.scale.linear().domain([c,b]).range([0,a]).clamp(!0),T=f/p.length,N=p.length-1;S.selectAll("rect").data(p).enter().append("rect").attr("x",function(e,t){return t*T}).attr("y",function(e,t){return a-x(e)}).attr("height",x).attr("width",T).style("fill",function(e,t){return w.colorAt(t/N)}),n.append('<span class="graph-max-y">'+b+"</span>")},setParameters:function(){var t=this,n=this.mapLayer.options;this.colors=n.colors,this.colorType=n.colorType,this.featureType=n.featureType,this.visible=n.visible;for(var r in n){var i=this.$("[name="+r+"]");i.length&&(i.val(n[r]),i.change(function(){}))}e(this.el).delegate("input, select","change",function(){t.enableUpdateButton()});switch(this.mapLayer.pointCollection.status){case DataStatus.COMPLETE:case DataStatus.UNREDUCED_INC:this.updateLegend(!0);break;default:this.hideLegend()}console.log("disableUpdateButton"),this.disableUpdateButton()},removeDataClicked:function(t){var n=this;e(this.el).fadeOut("fast"),n.collection.reset(),n.collection.unbindCollection(),t&&t.preventDefault()},updateDataClicked:function(t){var n=this;switch(this.colorType){case ColorType.SOLID:this.colors=[{color:this.$("#colorInput").val()}];break;case ColorType.PALETTE:this.colors=this.getColorsFromPaletteEditor()}var r={visible:this.visible,colorType:this.colorType,colors:this.colors,featureType:this.featureType,opacity:this.$("[name=opacity]").val(),title:this.$("[name=title]").val(),description:this.$("[name=description]").val(),unit:this.$("[name=unit]").val(),altUnit:this.$("[name=altUnit]").val()};console.log("postData",r),e.ajax({type:"POST",url:"/api/updatemapcollection/"+app.mapInfo._id+"/"+this.mapLayer.pointCollection._id,dataType:"json",data:r,success:function(e){n.disableUpdateButton(),n.updateLegend(!0),n.vent.trigger("updateMapLayer",e)},error:function(){console.error("failed to update layer options")}}),t&&t.preventDefault()},editDataClicked:function(t){var n=this;this.editDataView&&this.editDataView.remove(),this.editDataView=new EditDataView({vent:this.vent,collection:this.collection}),e("body").append(this.editDataView.render().el),e("#editDataModal").modal("toggle"),t&&t.preventDefault()},showLegend:function(){this.$(".legend").show()},hideLegend:function(){this.$(".legend").hide()},updateLegend:function(n){var r=this;this.visible?(e(this.el).addClass("visible"),e(this.el).removeClass("hidden")):(e(this.el).removeClass("visible"),e(this.el).addClass("hidden")),this.mapLayer.options.description?(this.$(".description").show(),this.$(".description").html(this.mapLayer.options.description)):this.$(".description").hide(),this.mapLayer.pointCollection.source?(this.$(".source").show(),this.$(".source").html(__("Source: %(source)s",this.mapLayer.pointCollection))):this.$(".source").hide();switch(this.colorType){case ColorType.SOLID:this.$(".legend-button").css("background-color",this.colors[0].color);break;case ColorType.PALETTE:case ColorType.LINEAR_GRADIENT:this.$(".legend-button").css("background-color",this.colors[0].color)}for(t in FeatureType)FeatureType[t]==this.featureType?this.$(".legend-button").addClass(FeatureType[t]):this.$(".legend-button").removeClass(FeatureType[t]);var i=this.mapLayer.sessionOptions.valFormatter,s=i.unit,o=function(t){return function(n){return r.vent.trigger("toggleValFormatter",r.mapLayer,t),r.$(".unit-item").removeClass("active"),e(n.currentTarget).addClass("active"),!1}};if(s){var u=[],a=this.mapLayer.sessionOptions.valFormatters,f=this.$(".legend .unit ul");f.html("");for(var l=0;l<a.length;l++){var c=a[l],h='<li class="unit-item'+(a.length>1&&c==i?" active":"")+'">'+(a.length>1?'<a href="#" class="unit-toggle">':"<span>")+c.unit+(a.length>1?"</a>":"</span>")+"</li>",h=e(h);a.length>1&&h.on("click",o(c)),f.append(h)}this.$(".legend .unit").show()}else this.$(".legend .unit").hide();if(n&&this.$(".color-bar").length){this.mapLayer.options.histogram&&this.initHistogram();var p=[];for(var l=0;l<this.colors.length;l++){var d=this.colors[l].color,v=multRGB(d,.85);p.push('<li style="width: '+Math.round(100/this.colors.length*100)/100+'%;">'+'<div class="segment" style="background: '+d+"; background: linear-gradient(top, "+d+" 40%, "+v+" 80%)"+"; background: -webkit-gradient(linear, left top, left bottom, color-stop(.4, "+d+"), color-stop(.8, "+v+"))"+'">'+"</div>"+"</li>")}this.$(".color-bar").html(p.join("")),this.setColorBarLabels()}},toggleValFormatter:function(e,t){if(e!=this.mapLayer)return;this.setColorBarLabels()},setColorBarLabels:function(){var t=this.colors.length>1&&(this.colorType==ColorType.LINEAR_GRADIENT||this.colorType==ColorType.PALETTE),n=this.$(".color-bar .segment"),r=this.mapLayer.sessionOptions.valFormatter,i=!1;for(var s=0;s<this.colors.length;s++){var o;this.colors[s].title?o=this.colors[s].title:(i=!0,t?(o=r.format(this.mapLayer.pointCollection.minVal+this.colors[s].position*(this.mapLayer.pointCollection.maxVal-this.mapLayer.pointCollection.minVal)),s==this.colors.length-1&&this.colors[s].position<1&&(o+="+")):o=r.format(this.mapLayer.pointCollection.minVal)+"–"+r.format(this.mapLayer.pointCollection.maxVal),s==0&&(o=UnitFormat.LEGEND.format({value:o,unit:this.mapLayer.pointCollection.unit}))),e(n[s]).text(o)}i?this.$(".legend .unit").show():this.$(".legend .unit").hide()},addOne:function(e){var t=this},addAll:function(){this.updateStatus()},enableUpdateButton:function(){console.log("enableUpdateButton"),this.$("#updateData").attr("disabled",!1),this.$("#updateData").removeClass("disabled"),this.$("#updateData").addClass("btn-primary")},disableUpdateButton:function(){this.$("#updateData").attr("disabled",!0),this.$("#updateData").removeClass("btn-primary"),this.$("#updateData").addClass("disabled")},colorInputClicked:function(e){this.enableUpdateButton(),e&&e.preventDefault()},featureTypeChanged:function(t){var n=this;if(t){var r=e(t.currentTarget).val();if(r==this.colorType)return;this.featureType=r,this.enableUpdateButton()}this.$(".feature-type").each(function(){e(this).val()==n.featureType?e(this).addClass("active"):e(this).removeClass("active")}),this.$(".feature-settings").each(function(){e(this).hasClass(n.featureType)?e(this).show():e(this).hide()}),t&&t.preventDefault()},colorTypeChanged:function(t){var n=this;if(t){var r=e(t.currentTarget).val();if(r==this.colorType)return;this.colorType=r,this.enableUpdateButton()}this.$(".color-type").each(function(){e(this).val()==n.colorType?e(this).addClass("active"):e(this).removeClass("active")});switch(this.colorType){case ColorType.SOLID:this.$(".color-gradient").hide(),this.$(".color-palette").hide(),this.$(".color-solid").show(),this.updateLegend(!0);break;case ColorType.LINEAR_GRADIENT:this.$(".color-gradient").show(),this.$(".color-palette").hide(),this.$(".color-solid").hide(),this.updateLegend(!0);break;case ColorType.PALETTE:this.$(".color-gradient").hide(),this.$(".color-palette").show(),this.$(".color-solid").hide(),this.updateLegend(!0)}t&&t.preventDefault()},toggleLayerVisibility:function(t,n,r){var i=this;if(t!=this.mapLayer.pointCollection._id)return;this.visible=n,this.$(".visibility").each(function(){var t=e(this).val();t=Number(t)!=0,t==i.visible?e(this).addClass("active"):e(this).removeClass("active")}),i.visible?(this.$(".icon.visibility.toggle").addClass("icon-eye-open"),this.$(".icon.visibility.toggle").removeClass("icon-eye-close"),e(this.el).show()):(this.$(".icon.visibility.toggle").removeClass("icon-eye-open"),this.$(".icon.visibility.toggle").addClass("icon-eye-close"),r&&e(this.el).hide()),this.updateStatus(),this.updateToggleState()},visibilityChanged:function(t){var n=this;if(t){if(!e(t.currentTarget).hasClass("toggle")){var r=e(t.currentTarget).val();r=Number(r)!=0;if(r==this.visible)return;this.visible=r}else this.visible=!this.visible;this.enableUpdateButton()}this.vent.trigger("toggleLayerVisibility",this.mapLayer.pointCollection._id,this.visible),this.updateLegend(),t&&t.preventDefault()}});return a});