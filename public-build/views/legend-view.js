define(["jquery","underscore","backbone","config","utils","text!templates/legend.html"],function(e,t,n,r,i,s){var o=n.View.extend({className:"legend",events:{"click .unit-toggle":"unitToggleClicked"},initialize:function(e){this.template=t.template(s),this.listenTo(this.model,"toggle:valFormatter",this.valFormatterChanged)},unitToggleClicked:function(t){return this.model.setValFormatter(parseInt(e(t.currentTarget).attr("data-index"))),!1},valFormatterChanged:function(t){var n=this.$(".unit ul li");n.removeClass("active"),e(n[this.model.sessionOptions.valFormatterIndex]).addClass("active"),this.updateColorBarLabels()},render:function(){var t=this,n=this.model.attributes.layerOptions;e(this.el).html(this.template());var r=this.model.getValFormatter(),i=r.unit;if(i){var s=[],o=this.model.getValFormatters(),u=this.$(".unit ul");u.html("");for(var a=0;a<o.length;a++){var f=o[a],l='<li class="unit-item'+(o.length>1&&f==r?" active":"")+'">'+(o.length>1?'<a href="#" class="unit-toggle" data-index="'+a+'">':"<span>")+f.unit+(o.length>1?"</a>":"</span>")+"</li>",l=e(l);u.append(l)}this.$(".unit").show()}else this.$(".unit").hide();if(this.$(".color-bar").length){var c=[],h=this.model.getNormalizedColors(),p=n.colorLabelColor&&n.colorLabelColor.length?n.colorLabelColor:null;for(var a=0;a<h.length;a++){var d=h[a].color,v=multRGB(d,.85),m=getRGBChannels(p||d),g=m[0]+m[1]+m[2]<COLOR_BAR_INVERT_CUTOFF*3,g=p?!g:g;c.push('<li style="width: '+Math.round(100/h.length*100)/100+'%;">'+'<div class="segment'+(g?" inverted":"")+'" style="background: '+d+";"+"background: linear-gradient(top, "+d+" 40%, "+v+" 80%);"+"background: -webkit-gradient(linear, left top, left bottom, color-stop(.4, "+d+"), color-stop(.8, "+v+"));"+(p?" color: "+p+";":"")+'">'+"</div>"+"</li>")}this.$(".color-bar").html(c.join("")),this.updateColorBarLabels()}return this},updateColorBarLabels:function(){if(!this.$(".color-bar").length)return;var t=this.model.getValFormatter(),n=this.model.getNormalizedColors(),r=n.length>1,i=this.$(".color-bar .segment"),s=!1;for(var o=0;o<n.length;o++){var u,a,f=this.model.getExtremes(),l=this.model.isNumeric();if(!l||n[o].title&&n[o].title.length)u=n[o].title||"&nbsp;";else{s=!0;if(r){u=t.format(f.minVal+n[o].position*(f.maxVal-f.minVal));if(a==undefined||n[o].position>n[a].position)a=o}else u=t.format(f.minVal)+"â€“"+t.format(f.maxVal)}e(i[o]).html(u)}a!=undefined&&n[a].position<1&&e(i[a]).append("+")}});return o});