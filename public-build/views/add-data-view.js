define(["jquery","underscore","backbone","config","utils","text!templates/add-data.html"],function(e,t,n,r,i,s){var o=n.View.extend({tagName:"div",className:"add-data-view",events:{"click #importButton":"importButtonClicked","click .from-field .remove":"fromFieldRemoveClicked"},initialize:function(e){this.template=t.template(s),this.vent=e.vent,this.responseData=null,this.dataTitle="",this.dataDescription=""},render:function(){e(this.el).html(this.template());var t=this;this.$(".modal").addClass("large"),this.fromFieldTemplate=this.$(".from-data thead .element-template"),this.toFieldTemplate=this.$(".to-data thead .element-template"),this.$(".element-template").remove(),this.fromFieldColors=["#c43c35","#f89406","#46a546","#62cffc"],this.fromFields={location:"location",Facility:"Facility",val:"val",year:"year"},this.toFields={loc:"Point X,Y",val:"Point Value",datetime:"Date",label:"Point Label"};var n=0;for(var r in this.fromFields){var i=this.fromFieldTemplate.clone();i.removeClass("element-template"),e(".name",i).text(this.fromFields[r]),e(".label",i).css("background-color",this.fromFieldColors[n%this.fromFieldColors.length]),e(".from-field",i).attr("data-from",r),this.$(".from-data thead").append(i).show(),n++}for(var r in this.toFields){var i=this.toFieldTemplate.clone();i.removeClass("element-template"),e(".name",i).text(this.toFields[r]),e(".to-field",i).attr("data-to",r),this.$(".to-data thead").append(i).show()}return this.$(".to-field").sortable({connectWith:".to-field"}),this.$(".from-field").draggable({revert:"invalid",helper:"clone",connectToSortable:".to-field",stack:".drag.label"}),this},fromFieldRemoveClicked:function(t){return e(t.currentTarget).closest(".from-field").remove(),!1},showAlert:function(e){e?(this.$(".modal-body .alert").show(),this.$(".modal-body .alert").html(e)):this.$(".modal-body .alert").hide()},getFieldDefs:function(){var t={};for(var n in this.toFields){console.log(this.$(".to-field[data-to="+n+"] .from-field"));var r=this.$(".to-field[data-to="+n+"] .from-field");t[n]={fromFields:[]};for(var i=0;i<r.length;i++)t[n].fromFields.push(e(r[i]).attr("data-from"))}return t},importButtonClicked:function(){this.startImport()},startImport:function(){var t=this;t.$("#importButton").attr("disabled",!0),e.ajax({type:"POST",url:"/api/import/",data:{url:"https://dl.dropbox.com/s/03cqpv1camzz4a1/reactors.csv",fields:this.getFieldDefs()},success:function(n){app.bindCollectionToMap(n.pointCollectionId),e("#addDataModal").modal("hide"),t.close()},error:function(n,r,i){var s=e.parseJSON(n.responseText);console.error("import failed",s.errors);var o="";if(s&&s.errors){for(var u in s.errors)o+="<li>"+s.errors[u].message+"</li>";console.error("errors:",s.errors),t.showAlert("<ul>"+o+"</ul>")}t.$("#importButton").attr("disabled",!1)}})}});return o});