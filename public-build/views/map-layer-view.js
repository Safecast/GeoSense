define(["jquery","underscore","backbone","config","utils","text!templates/map-layer.html","views/panel-view-base","views/histogram-view","views/legend-view","lib/color-gradient/color-gradient"],function(e,t,n,r,i,s,o,u,a,f){var l=n.View.extend({className:"map-layer",events:{"click .panel-controls .toggle-layer":"toggleLayerClicked","click .panel-controls .show-layer-editor":"showLayerEditorClicked","click .panel-controls .show-layer-details":"showLayerDetailsClicked"},initialize:function(e){this.vent=e.vent,this.template=t.template(s),this.listenTo(this.model,"change",this.modelChanged),this.listenTo(this.model,"toggle:enabled",this.updateEnabled),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.vent,"panel:resize",this.panelViewResized),this.listenTo(this.model.featureCollection,"request",this.layerFeaturesRequest),this.listenTo(this.model.featureCollection,"error",this.layerFeaturesRequestError),this.listenTo(this.model.featureCollection,"sync",this.layerFeaturesSynced)},showSpinner:function(){this.spinner.is(":visible")||this.spinner.css({opacity:0}).show(),this.spinner.stop().animate({opacity:1},50)},hideSpinner:function(){var e=this;this.spinner.stop().fadeOut(300,function(){})},layerFeaturesRequest:function(e,t,n){this.isLoading=!0,this.updateStatus()},layerFeaturesRequestError:function(e,t,n){this.isLoading=!1,this.updateStatus(__("failed")),console.log("layerFeaturesRequestError",t)},layerFeaturesSynced:function(e,t,n){this.isLoading=!1,this.updateStatus()},updateStatus:function(e){var t="",n=this.model.attributes.featureCollection.progress,r=this.model.featureCollection;this.isLoading||this.model.getDataStatus()!=DataStatus.COMPLETE?this.showSpinner():this.hideSpinner();if(!e)switch(this.model.getDataStatus()){case DataStatus.COMPLETE:if(this.model.isEnabled())if(r.initiallyFetched){e=__("%(number)i of %(total)i",{number:formatLargeNumber(r.originalCount),total:formatLargeNumber(r.fullCount)});var i=r.url();e+=' <a target="_blank" class="download-collection '+this.model.attributes.featureCollection._id+'" href="'+i+'"><span class="icon icon-white icon-download half-opacity"></span></a>'}else e="loading…";else e="";break;case DataStatus.IMPORTING:case DataStatus.IMPORTING_INC:e=__(n?"importing… %(count)s":"importing…",{count:formatLargeNumber(this.model.attributes.featureCollection.progress)});break;case DataStatus.UNREDUCED:case DataStatus.UNREDUCED_INC:e=__("queued for crunching…");break;case DataStatus.REDUCING:case DataStatus.REDUCING_INC:if(this.model.attributes.featureCollection.numBusy){var s=Math.floor(n/this.model.attributes.featureCollection.numBusy*100);e=__(n?"crunching… %(percent)s%":"crunching…",{percent:s}),this.$(".progress .bar").css("width",s+"%"),this.$(".progress").show()}else e=__("crunching…",{})}var o=this.$(".status .text");o.html(e)},render:function(){this.$el.html(this.template()),this.$el.attr("data-id",this.model.id);var e=this.$(".state-indicator");e.length&&(this.spinner=e.html((new Spinner({radius:4,length:0,width:4,color:"#eee",lines:7,speed:1.5})).spin().el).hide()),this.toggleEl=this.$(".accordion-toggle"),this.collapseEl=this.$(".collapse"),this.toggleEl.attr("href","#collapse-"+this.className+"-"+this.model.id),this.collapseEl.attr("id","collapse-"+this.className+"-"+this.model.id);var t=this.model.isEnabled();return t?this.collapseEl.addClass("in"):this.toggleEl.addClass("collapsed"),this.$(".status").toggle(t),this.$(".admin-control").toggle(app.isMapAdmin()),this.$(".details").hide(),this.populateFromModel(!0),this},expand:function(){return this.collapseEl.is(".in")||(this.collapseEl.collapse("toggle"),this.toggleEl.removeClass("collapsed")),this},collapse:function(){return this.collapseEl.is(".in")&&(this.collapseEl.collapse("toggle"),this.toggleEl.addClass("collapsed")),this},hide:function(e){return this.$el.hide(e),this},show:function(e){return this.$el.show(e),this},renderHistogram:function(){this.histogramView?this.histogramView.$el.remove():this.histogramView=new u({model:this.model});if(!this.model.canDisplayValues()||!this.model.isNumeric()||!this.model.attributes.layerOptions.histogram)return;this.$(".graphs").append(this.histogramView.el),this.histogramView.render().delegateEvents()},renderLegend:function(){this.legendView?this.legendView.$el.remove():this.legendView=new a({model:this.model});if(!this.model.canDisplayValues())return;this.$(".legend").append(this.legendView.el),this.legendView.render().delegateEvents()},panelViewResized:function(e){e==this.superView&&this.histogramView&&this.histogramView.render()},updateEnabled:function(t){var n=this.model.isEnabled(),r=t||t==undefined?"fast":0;e(this.el).toggleClass("enabled",n),e(this.el).toggleClass("disabled",!n),n?this.$(".status").slideDown(r):this.$(".status").slideUp(r),n?this.expand():this.collapse()},modelChanged:function(e){this.populateFromModel(this.model.hasChangedColors()||this.model.hasChanged("featureCollection.status")||this.model.hasChanged("layerOptions.histogram"))},populateFromModel:function(e){this.updateEnabled(!1),e&&this.renderHistogram(),this.renderLegend(),this.updateStatus(),this.$(".model-title").text(this.model.getDisplay("title"));var t=this.model.attributes.featureCollection,n=this.model.getDisplay("description"),r=this.model.getDisplay("source"),i=this.model.getDisplay("sourceUrl");n?(this.$(".description").html(n),this.$(".layer-details").show()):(this.$(".description").hide(),this.$(".panel-controls .layer-details").hide());if(r||t.sync){this.$(".source").show();var s=i&&i.length?'<a href="%(sourceUrl)s">%(source)s</a>'.format({sourceUrl:i,source:r}):r;r&&(r=__("Source: %(source)s",{source:s})),t.sync&&(r+=' <span class="updated micro">('+__("updated %(date)s",{date:(new Date(t.reduce?t.updatedAt<t.lastReducedAt||!t.lastReducedAt?t.updatedAt:t.lastReducedAt:t.updatedAt)).format(locale.formats.DATE_SHORT)})+")</span>"),this.$(".source").html(r)}else this.$(".source").hide()},toggleLayerClicked:function(e){return this.model.toggleEnabled(!this.model.isEnabled()),!1},showLayerEditorClicked:function(e){return this.vent.trigger("showMapLayerEditor",this.model),!1},showLayerDetailsClicked:function(e){var t=this;return this.$(".details").uiToggle({activate:this.$(".show-layer-details"),show:function(){t.expand()}}),!1}});return l});