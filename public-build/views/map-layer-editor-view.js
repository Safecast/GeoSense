define(["jquery","underscore","backbone","config","utils","text!templates/map-layer-editor.html","views/panel-view-base","mixins/model-editor-mixin","lib/color-gradient/color-gradient"],function(e,t,n,r,i,s,o,u,a){var f=o.extend({className:"panel map-layer-editor",events:{"click .btn.save":"saveButtonClicked","click .btn.undo":"undoButtonClicked","click .btn.destroy":"destroyButtonClicked","click .btn.feature-type":"featureTypeClicked","change .model-input, .color-palette input, .color-palette select":"modelInputChanged","change .preview":"previewChanged","click .remove-color":"removeColorClicked","click .add-color":"addColorClicked","change .model-input.layer-toggle":"layerToggled"},initialize:function(e){f.__super__.initialize.call(this,e),this.template=t.template(s),this.listenTo(this.model,"change",this.updateFromModel),this.listenTo(this.model,"sync",this.modelSynced),this.listenTo(this.model,"destroy",this.remove)},modelSynced:function(e){this.model.hasChanged("layerOptions")},render:function(){var e=this;return f.__super__.render.call(this),this.colorRowTemplate=this.$(".color-palette tr.element-template").remove().clone().removeClass("element-template"),this.initModelInputs(),this.initSliders(),this.populateFromModel(),this.initColorPicker(this.$(".model-input.color-picker")),this.$(".color-palette tbody").sortable({handle:".drag-handle",stop:function(t,n){e.modelInputChanged(t)}}),this},updateFromModel:function(){this.$(".model-title").text(this.model.attributes.layerOptions.title&&this.model.attributes.layerOptions.title.length?this.model.attributes.layerOptions.title:this.model.attributes.pointCollection.title),this.$(".model-numeric").toggle(this.model.isNumeric())},initSliders:function(){var t=this;this.$(".slider").each(function(){var n=e(this).attr("data-field");e(this).slider({min:0,max:1,range:"min",step:.05,slide:function(r,i){e(t.modelInputs[n][0]).val(i.value),t.modelInputChanged()}}),e(t.modelInputs[n][0]).change(function(){t.updateSliders()})})},updateSliders:function(){var t=this;this.$(".slider").each(function(){var n=e(this).attr("data-field");e(this).slider("value",e(t.modelInputs[n][0]).val())})},populateFromModel:function(){this.updateFromModel(),this.populateModelInputs(),this.$(".panel-header .title").text(this.model.get("layerOptions.title")),this.populateColorTable(),this.setButtonState(!1),this.updateSliders()},getModelInputValues:function(e){return e["layerOptions.colors"]=this.getColorsFromTable(),e},undoButtonClicked:function(e){return this.model.set(t.extend(this.model.attributes,this.unchangedModelAttributes),{}),this.populateFromModel(),!1},saveButtonClicked:function(e){var t=this;return this.isChanged?(this.setButtonState(!1),this.updateModelFromInputs(),this.model.save({},{success:function(e,n,r){console.log("saved layer"),t.populateFromModel()},error:function(e,n,r){t.setButtonState(!0),console.log("error saving layer"),t.handleValidationErrors(n)}}),!1):!1},destroyButtonClicked:function(e){var t=this;return window.confirm(__("Are you sure you want to delete this layer? This action cannot be reversed!"))&&this.model.destroy({success:function(e,t,n){},error:function(e,t,n){}}),!1},featureTypeClicked:function(t){return this.populateModelInput("layerOptions.featureType",e(t.currentTarget).val()),this.modelInputChanged(t),!1},modelInputChanged:function(e){this.isChanged=!0,this.setButtonState(this.isChanged),this.updateModelFromInputs({silent:!this.isPreviewEnabled()})},previewChanged:function(e){this.isPreviewEnabled()&&this.updateModelFromInputs()},isPreviewEnabled:function(){return this.$(".preview").is(":checked")},setButtonState:function(t){t!=undefined&&(this.$(".btn.undo").attr("disabled",!t),this.$(".btn.save").attr("disabled",!t)),this.$(".color-palette tbody tr").length>1?this.$(".remove-color").attr("disabled",!1):this.$(".remove-color").attr("disabled",!0);var n=this.getValueFromModelInput("layerOptions.featureType");this.$(".feature-settings").each(function(){e(this).hasClass(n)?e(this).show():e(this).hide()})},initColorPicker:function(t,n){var r=this;n!=undefined&&e(t).miniColors("value",n),e(t).miniColors({change:function(e,t){r.modelInputChanged()}}),n||(n="#0aa5ff")},addColorRow:function(t){var t=t||{},n=this.colorRowTemplate.clone();return n.attr("data-id",t._id),e("[name=position]",n).val(t.position||DEFAULT_COLOR_EDITOR_POSITION),this.initColorPicker(e(".color-picker",n),t.color||DEFAULT_COLOR_EDITOR_COLOR),e("[name=interpolation] option",n).each(function(){e(this).attr("selected",e(this).val()==t.interpolation||t.interpolation==""&&e(this).val()==a.prototype.interpolation.default)}),this.$(".color-palette tbody").append(n),n},populateColorTable:function(){var e=[],t=this;this.$(".color-palette tbody").empty();var e=this.model.get("layerOptions.colors");for(var n=0;n<e.length;n++)var r=this.addColorRow(e[n])},getColorsFromTable:function(){var t=[];return this.$(".color-palette tbody tr").each(function(){if(e(this).is(".element-template"))return;var n={_id:e(this).attr("data-id"),color:e(".color-picker",this).val(),position:e("[name=position]",this).val(),interpolation:e("[name=interpolation]",this).val()};n._id.length||delete n._id,t.push(n)}),t},removeColorClicked:function(t){return e(t.currentTarget).attr("disabled")?!1:(e(t.currentTarget).closest("tr").remove(),this.modelInputChanged(),!1)},addColorClicked:function(e){return this.addColorRow(),this.modelInputChanged(),!1},layerToggled:function(t){this.model.toggleEnabled(e(t.currentTarget).is(":checked"))}});return t.extend(f.prototype,u),f});