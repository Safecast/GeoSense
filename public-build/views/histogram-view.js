define(["jquery","underscore","backbone","config","utils","text!templates/histogram.html","d3"],function(e,t,n,r,i,s,o){var u=n.View.extend({className:"histogram",events:{},initialize:function(e){this.template=t.template(s)},render:function(){var t=this;e(this.el).hide().html(this.template());var n=t.$el;if(!this.histogramData)return e.ajax({type:"GET",url:"/api/histogram/"+this.model.attributes.featureCollection._id,success:function(e){t.histogramData=e,t.render()},error:function(){t.histogramData=[],console.error("failed to fetch histogram")}}),this;var r=this.histogramData,i=r.length,s=this.model.getMappedExtremes(),u=s.numeric?s.numeric.min:NaN,a=s.numeric?s.numeric.max:NaN,f=n.innerHeight(),l=n.innerWidth();if(!i)return this;var c=r[0].y,h=r[0].y,p=[],d=[];for(var v=1;v<i;v++)c=Math.max(c,r[v].y),h=Math.min(h,r[v].y);var m=h!=0?h:1,g=m/c,y;t.model.getLayerOptions().cropDistribution&&(y=1/f*CROP_DISTRIBUTION_RATIO);var b,w=!y||g>y?c:m*1/y,d=[],E;for(var v=0;v<i;v++)(b==null||r[v].val<b)&&d.push(r[v].y);n.html("");var S=o.select(n[0]).append("svg").attr("class","chart").attr("width",l).attr("height",f),x=o.scale.linear().domain([h,w]).range([0,f]).clamp(!0),T=l/d.length,N=d.length-1;return S.selectAll("rect").data(d).enter().append("rect").attr("x",function(e,t){return t*T}).attr("y",function(e,t){return f-x(e)}).attr("height",x).attr("width",T).style("fill",function(e,n){return t.model.colorAt(n/N)}),n.append('<span class="graph-max-y">'+w+"</span>"),this.$el.show("fast"),this}});return u});