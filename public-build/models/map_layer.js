define(["jquery","underscore","backbone","collections/geo-feature-collection","lib/color-gradient/color-gradient","deepextend","deepmodel"],function(e,t,n,r,i){var s=n.DeepModel.extend({idAttribute:"_id",urlRoot:function(){return this.parentMap.url()+"/layer"},getDataStatus:function(){return this.attributes.featureCollection.status},getDisplay:function(e){var t=this.attributes.layerOptions,n=this.attributes.featureCollection,r=n?n.defaults:{};return t&&t[e]&&(typeof t[e]!="string"||t[e].length)?t[e]:n?n[e]:r?r[e]:null},initialize:function(e,n){var i=this,n=n||{};this.parentMap=n.parentMap,this.featureCollection=new r([],{mapLayer:this}),this.valFormatters=[],this.sessionOptions=t.extend(n.sessionOptions||{},{enabled:this.attributes.layerOptions?this.attributes.layerOptions.enabled:!0,valFormatterIndex:0}),this.on("change",this.onChange,this),this.initValFormatters()},onChange:function(){delete this._normalizedColors,delete this._colorGradient,this.initValFormatters()},initValFormatters:function(){var e=this;this.valFormatters=[],this.attributes.layerOptions&&!this.attributes.layerOptions.unit&&(!this.attributes.layerOptions.unit+"").length&&this.attributes.layerOptions.valFormat&&this.attributes.layerOptions.valFormat.length?t.each(this.attributes.layerOptions.valFormat,function(t){e.valFormatters.push(new ValFormatter(t))}):this.valFormatters.push(new ValFormatter({unit:this.getDisplay("unit")})),this.setValFormatter(Math.min(this.valFormatters.length-1,this.sessionOptions.valFormatterIndex))},getValFormatter:function(){return this.valFormatters[this.sessionOptions.valFormatterIndex]},getValFormatters:function(){return this.valFormatters},setValFormatter:function(e){this.sessionOptions.valFormatterIndex=e,this.trigger("toggle:valFormatter",this)},getLayerOptions:function(){return this.attributes.layerOptions},getExtremes:function(){return{minVal:this.attributes.featureCollection.minVal,maxVal:this.attributes.featureCollection.maxVal,maxCount:this.featureCollection.maxReducedCount}},colorAt:function(e){return this._colorGradient||(this._colorGradient=new i(this.getNormalizedColors())),this._colorGradient.colorAt(e,COLOR_GRADIENT_STEP)},getNormalizedColors:function(e){var n=this,e=e||this.attributes.layerOptions.colors,r=this.getExtremes();return this._normalizedColors||(this._normalizedColors=e.map(function(e){var n=parseFloat(e.position),n=isNaN(n)?1:n,i=(e.position||"")+"";return t.extend({},e,{position:i[i.length-1]=="%"?n/100:(n-r.minVal)/(r.maxVal-r.minVal)})})),this._normalizedColors},toggleEnabled:function(e){this.sessionOptions.enabled!=e&&(this.sessionOptions.enabled=e,this.trigger("toggle:enabled",this))},isEnabled:function(){return this.sessionOptions.enabled},isNumeric:function(){return this.attributes.featureCollection.isNumeric&&this.attributes.featureCollection.maxVal!=undefined&&this.attributes.featureCollection.minVal!=undefined},canDisplayValues:function(){var e=this.getDataStatus();return e==DataStatus.COMPLETE||e==DataStatus.UNREDUCED_INC||e==DataStatus.REDUCING_INC||e==DataStatus.IMPORTING_INC},hasChangedColors:function(){var e=this.previousAttributes().layerOptions.colors,n=this.attributes.layerOptions.colors;return this.hasChanged("layerOptions.colorLabelColor")||e&&n&&!t.isEqual(e,n)}});return s});