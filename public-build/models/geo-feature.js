define(["jquery","underscore","backbone","deepextend","deepmodel"],function(e,t,n){var r=n.DeepModel.extend({idAttribute:"_id",initialize:function(){var e=this;this.on("change",function(){delete e._renderAttrs})},getNumericVal:function(){var e=this.collection.mapLayer.getNumericField();return e?this.get(e):undefined},getDatetimeVal:function(){var e=this.collection.mapLayer.getOption("attrMap",{});return e.datetime?this.get(e.datetime):undefined},getCenter:function(){if(!this.attributes.bbox||!this.attributes.bbox.length)return this.attributes.geometry.coordinates;var e=this.getSize();return[this.attributes.bbox[0]+e[0]/2,this.attributes.bbox[1]+e[1]/2]},getSize:function(){return!this.attributes.bbox||!this.attributes.bbox.length?[0,0]:[this.attributes.bbox[2]-this.attributes.bbox[0],this.attributes.bbox[3]-this.attributes.bbox[1]]},getBox:function(){var e,t=this.collection.mapLayer.mapFeatures.gridSize();this.attributes.geometry.type=="Point"&&t?e=t:e=this.getSize();var n=e[0]/2,r=e[1]/2,i=this.getCenter(),s=i[0]-n,o=i[1]-r,u=i[0]+n,a=i[1]+r;return[[s,o],[u,o],[u,a],[s,a]]},getRenderAttr:function(e,t){if(!this._renderAttrs){var n=this.collection.mapLayer,r=n.getLayerOptions(),i=this.collection.mapLayer.getOption("attrMap",{}),s=n.getMappedExtremes(),o=n.mapFeatures.getCounts(),u=this.getNumericVal(),a=s.numeric?s.numeric.max:NaN,f=s.numeric?s.numeric.min:NaN;u&&u.avg!=null&&(u=u.avg);var l=this.attributes.properties?this.attributes.properties.count||1:1,c=(u-f)/(a-f),h=l/(o?o.max:1),p,d;switch(r.colorType){default:switch(i.featureColor){case"count":p=n.colorAt(h);break;default:case"$numeric.avg":p=n.colorAt(isNaN(c)?0:c)}}switch(i.featureSize){default:case"count":d=h;break;case"$numeric.avg":d=c}this._renderAttrs={size:d,color:p,model:this,data:{val:u,normVal:c,count:l}}}return e?(this._renderAttrs[e]==undefined&&t!=undefined&&(this._renderAttrs[e]=typeof t=="function"?t():t),this._renderAttrs[e]):this._renderAttrs}});return r});