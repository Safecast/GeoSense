define(["jquery","underscore","backbone","deepextend","deepmodel"],function(e,t,n){var r=n.DeepModel.extend({idAttribute:"_id",initialize:function(){var e=this;this.on("change",function(){delete e._renderAttrs,console.log("delete")})},getNumericVal:function(){var e=this.collection.mapLayer.getOption("attrMap",{});return e.numeric?this.get(e.numeric):undefined},getDatetimeVal:function(){var e=this.collection.mapLayer.getOption("attrMap",{});return e.datetime?this.get(e.datetime):undefined},getCenter:function(){if(!this.attributes.bbox||!this.attributes.bbox.length)return this.attributes.geometry.coordinates;var e=this.getSize();return[this.attributes.bbox[0]+e[0]/2,this.attributes.bbox[1]+e[1]/2]},getSize:function(){return!this.attributes.bbox||!this.attributes.bbox.length?[0,0]:[this.attributes.bbox[2]-this.attributes.bbox[0],this.attributes.bbox[3]-this.attributes.bbox[1]]},getBox:function(){var e,t=this.collection.mapLayer.mapFeatures.gridSize();this.attributes.geometry.type=="Point"&&t?e=t:e=this.getSize();var n=e[0]/2,r=e[1]/2,i=this.getCenter(),s=i[0]-n,o=i[1]-r,u=i[0]+n,a=i[1]+r;return[[u,o],[s,o],[s,a],[u,a]]},getRenderAttributes:function(e){if(!this._renderAttrs){var t=this.collection.mapLayer,n=t.getLayerOptions(),r=this.collection.mapLayer.getOption("attrMap",{}),i=t.getMappedExtremes(),s=t.mapFeatures.getCounts(),o=this.getNumericVal(),u=i.numeric?i.numeric.max:NaN,a=i.numeric?i.numeric.min:NaN;o&&o.avg!=null&&(o=o.avg);var f=this.attributes.properties?this.attributes.properties.count||1:1,l=(o-a)/(u-a),c=f/(s?s.max:1),h,p;switch(n.colorType){default:switch(r.featureColor){case"count":h=t.colorAt(c);break;default:case"val.avg":h=t.colorAt(isNaN(l)?0:l)}}switch(r.featureSize){default:case"count":p=c;break;case"$numeric.avg":p=l}this._renderAttrs={color:h,darkerColor:multRGB(h,.75),model:this,data:{val:o,normVal:l,count:f},size:p}}return e?this._renderAttrs[e]:this._renderAttrs}});return r});