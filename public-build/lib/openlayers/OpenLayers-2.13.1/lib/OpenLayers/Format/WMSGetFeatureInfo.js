/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var n=e.documentElement;if(n){var r=this,i=this["read_"+n.nodeName];i?t=i.call(this,n):t=(new OpenLayers.Format.GML(this.options?this.options:{})).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],n=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(n)for(var r=0,i=n.length;r<i;++r){var s=n[r],o=s.nodeName;s.prefix&&(o=o.split(":")[1]);var o=o.replace(this.layerIdentifier,""),u=this.getSiblingNodesByTagCriteria(s,this.featureIdentifier);if(u)for(var a=0;a<u.length;a++){var f=u[a],l=this.parseGeometry(f),c=this.parseAttributes(f),h=new OpenLayers.Feature.Vector(l.geometry,c,null);h.bounds=l.bounds,h.type=o,t.push(h)}}return t},read_FeatureInfoResponse:function(e){var t=[],n=this.getElementsByTagNameNS(e,"*","FIELDS");for(var r=0,i=n.length;r<i;r++){var s=n[r],o=null,u={},a,f=s.attributes.length;if(f>0)for(a=0;a<f;a++){var l=s.attributes[a];u[l.nodeName]=l.nodeValue}else{var c=s.childNodes;for(a=0,f=c.length;a<f;++a){var h=c[a];h.nodeType!=3&&(u[h.getAttribute("name")]=h.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(o,u,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var n=[],r,i,s,o,u;if(e&&e.hasChildNodes()){r=e.childNodes,s=r.length;for(var a=0;a<s;a++){u=r[a];while(u&&u.nodeType!=1)u=u.nextSibling,a++;i=u?u.nodeName:"",i.length>0&&i.indexOf(t)>-1?n.push(u):(o=this.getSiblingNodesByTagCriteria(u,t),o.length>0&&(n.length==0?n=o:n.push(o)))}}return n},parseAttributes:function(e){var t={};if(e.nodeType==1){var n=e.childNodes,r=n.length;for(var i=0;i<r;++i){var s=n[i];if(s.nodeType==1){var o=s.childNodes,u=s.prefix?s.nodeName.split(":")[1]:s.nodeName;if(o.length==0)t[u]=null;else if(o.length==1){var a=o[0];if(a.nodeType==3||a.nodeType==4){var f=a.nodeValue.replace(this.regExes.trimSpace,"");t[u]=f}}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t=this.gmlFormat.parseFeature(e),n,r=null;return t&&(n=t.geometry&&t.geometry.clone(),r=t.bounds&&t.bounds.clone(),t.destroy()),{geometry:n,bounds:r}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"});