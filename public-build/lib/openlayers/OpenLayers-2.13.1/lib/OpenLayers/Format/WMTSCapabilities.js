/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.WMTSCapabilities=OpenLayers.Class(OpenLayers.Format.XML.VersionedOGC,{defaultVersion:"1.0.0",yx:{"urn:ogc:def:crs:EPSG::4326":!0},createLayer:function(e,t){var n;if("layer"in t){var r=e.contents,i=r.layers,s;for(var o=0,u=r.layers.length;o<u;++o)if(r.layers[o].identifier===t.layer){s=r.layers[o];break}if(!s)throw new Error("Layer not found");var a=t.format;!a&&s.formats&&s.formats.length&&(a=s.formats[0]);var f;t.matrixSet?f=r.tileMatrixSets[t.matrixSet]:s.tileMatrixSetLinks.length>=1&&(f=r.tileMatrixSets[s.tileMatrixSetLinks[0].tileMatrixSet]);if(!f)throw new Error("matrixSet not found");var l;for(var o=0,u=s.styles.length;o<u;++o){l=s.styles[o];if(l.isDefault)break}var c=t.requestEncoding;if(!c){c="KVP";if(e.operationsMetadata.GetTile.dcp.http){var h=e.operationsMetadata.GetTile.dcp.http;if(h.get[0].constraints){var p=h.get[0].constraints,d=p.GetEncoding.allowedValues;!d.KVP&&(d.REST||d.RESTful)&&(c="REST")}}}var v=[],m=t.params||{};delete t.params;for(var g=0,y=s.dimensions.length;g<y;g++){var b=s.dimensions[g];v.push(b.identifier),m.hasOwnProperty(b.identifier)||(m[b.identifier]=b["default"])}var w=t.projection||f.supportedCRS.replace(/urn:ogc:def:crs:(\w+):(.*:)?(\w+)$/,"$1:$3"),E=t.units||(w==="EPSG:4326"?"degrees":"m"),S=[];for(var x in f.matrixIds)f.matrixIds.hasOwnProperty(x)&&S.push(f.matrixIds[x].scaleDenominator*28e-5/OpenLayers.METERS_PER_INCH/OpenLayers.INCHES_PER_UNIT[E]);var T;if(c==="REST"&&s.resourceUrls){T=[];var N=s.resourceUrls,C;for(var k=0,L=s.resourceUrls.length;k<L;++k)C=s.resourceUrls[k],C.format===a&&C.resourceType==="tile"&&T.push(C.template)}else{var A=e.operationsMetadata.GetTile.dcp.http.get;T=[];var O;for(var o=0,u=A.length;o<u;o++)O=A[o].constraints,(!O||O&&O.GetEncoding.allowedValues[c])&&T.push(A[o].url)}return new OpenLayers.Layer.WMTS(OpenLayers.Util.applyDefaults(t,{url:T,requestEncoding:c,name:s.title,style:l.identifier,format:a,matrixIds:f.matrixIds,matrixSet:f.identifier,projection:w,units:E,resolutions:t.isBaseLayer===!1?undefined:S,serverResolutions:S,tileFullExtent:f.bounds,dimensions:v,params:m}))}throw new Error("Missing property 'layer' in configuration.")},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities"});