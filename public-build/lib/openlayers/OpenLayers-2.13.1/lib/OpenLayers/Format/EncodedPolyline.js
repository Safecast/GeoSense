/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.EncodedPolyline=OpenLayers.Class(OpenLayers.Format,{geometryType:"linestring",initialize:function(e){OpenLayers.Format.prototype.initialize.apply(this,[e])},read:function(e){var t;if(this.geometryType=="linestring")t=OpenLayers.Geometry.LineString;else if(this.geometryType=="linearring")t=OpenLayers.Geometry.LinearRing;else if(this.geometryType=="multipoint")t=OpenLayers.Geometry.MultiPoint;else if(this.geometryType!="point"&&this.geometryType!="polygon")return null;var n=this.decodeDeltas(e,2),r=n.length,i=[];for(var s=0;s+1<r;){var o=n[s++],u=n[s++];i.push(new OpenLayers.Geometry.Point(u,o))}return this.geometryType=="point"?new OpenLayers.Feature.Vector(i[0]):this.geometryType=="polygon"?new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(i)])):new OpenLayers.Feature.Vector(new t(i))},decode:function(e,t,n){var r=n||1e5,i=this.decodeDeltas(e,t,r),s=i.length,o=[];for(var u=0;u+(t-1)<s;){var a=[];for(var f=0;f<t;++f)a.push(i[u++]);o.push(a)}return o},write:function(e){var t;e.constructor==Array?t=e[0]:t=e;var n=t.geometry,r=n.CLASS_NAME.split(".")[2].toLowerCase(),i;if(r=="point")i=new Array(n);else if(r=="linestring"||r=="linearring"||r=="multipoint")i=n.components;else{if(r!="polygon")return null;i=n.components[0].components}var s=[],o=i.length;for(var u=0;u<o;++u){var a=i[u];s.push(a.y),s.push(a.x)}return this.encodeDeltas(s,2)},encode:function(e,t,n){var r=n||1e5,i=[],s=e.length;for(var o=0;o<s;++o){var u=e[o];for(var a=0;a<t;++a)i.push(u[a])}return this.encodeDeltas(i,t,r)},encodeDeltas:function(e,t,n){var r=n||1e5,i,s=new Array(t);for(i=0;i<t;++i)s[i]=0;var o=e.length;for(var u=0;u<o;)for(i=0;i<t;++i,++u){var a=e[u],f=a-s[i];s[i]=a,e[u]=f}return this.encodeFloats(e,r)},decodeDeltas:function(e,t,n){var r=n||1e5,i,s=new Array(t);for(i=0;i<t;++i)s[i]=0;var o=this.decodeFloats(e,r),u=o.length;for(var a=0;a<u;)for(i=0;i<t;++i,++a)s[i]+=o[a],o[a]=s[i];return o},encodeFloats:function(e,t){var n=t||1e5,r=e.length;for(var i=0;i<r;++i)e[i]=Math.round(e[i]*n);return this.encodeSignedIntegers(e)},decodeFloats:function(e,t){var n=t||1e5,r=this.decodeSignedIntegers(e),i=r.length;for(var s=0;s<i;++s)r[s]/=n;return r},encodeSignedIntegers:function(e){var t=e.length;for(var n=0;n<t;++n){var r=e[n],i=r<<1;r<0&&(i=~i),e[n]=i}return this.encodeUnsignedIntegers(e)},decodeSignedIntegers:function(e){var t=this.decodeUnsignedIntegers(e),n=t.length;for(var r=0;r<n;++r){var i=t[r];t[r]=i&1?~(i>>1):i>>1}return t},encodeUnsignedIntegers:function(e){var t="",n=e.length;for(var r=0;r<n;++r)t+=this.encodeUnsignedInteger(e[r]);return t},decodeUnsignedIntegers:function(e){var t=[],n=0,r=0,i=e.length;for(var s=0;s<i;++s){var o=e.charCodeAt(s)-63;n|=(o&31)<<r,o<32?(t.push(n),n=0,r=0):r+=5}return t},encodeFloat:function(e,t){return e=Math.round(e*(t||1e5)),this.encodeSignedInteger(e)},decodeFloat:function(e,t){var n=this.decodeSignedInteger(e);return n/(t||1e5)},encodeSignedInteger:function(e){var t=e<<1;return e<0&&(t=~t),this.encodeUnsignedInteger(t)},decodeSignedInteger:function(e){var t=this.decodeUnsignedInteger(e);return t&1?~(t>>1):t>>1},encodeUnsignedInteger:function(e){var t,n="";while(e>=32)t=(32|e&31)+63,n+=String.fromCharCode(t),e>>=5;return t=e+63,n+=String.fromCharCode(t),n},decodeUnsignedInteger:function(e){var t=0,n=0,r=e.length;for(var i=0;i<r;++i){var s=e.charCodeAt(i)-63;t|=(s&31)<<n;if(s<32)break;n+=5}return t},CLASS_NAME:"OpenLayers.Format.EncodedPolyline"});