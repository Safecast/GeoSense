/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.ArcXML=OpenLayers.Class(OpenLayers.Format.XML,{fontStyleKeys:["antialiasing","blockout","font","fontcolor","fontsize","fontstyle","glowing","interval","outline","printmode","shadow","transparency"],request:null,response:null,initialize:function(e){this.request=new OpenLayers.Format.ArcXML.Request,this.response=new OpenLayers.Format.ArcXML.Response;if(e)if(e.requesttype=="feature"){this.request.get_image=null;var t=this.request.get_feature.query;this.addCoordSys(t.featurecoordsys,e.featureCoordSys),this.addCoordSys(t.filtercoordsys,e.filterCoordSys),e.polygon?(t.isspatial=!0,t.spatialfilter.polygon=e.polygon):e.envelope&&(t.isspatial=!0,t.spatialfilter.envelope={minx:0,miny:0,maxx:0,maxy:0},this.parseEnvelope(t.spatialfilter.envelope,e.envelope))}else if(e.requesttype=="image"){this.request.get_feature=null;var n=this.request.get_image.properties;this.parseEnvelope(n.envelope,e.envelope),this.addLayers(n.layerlist,e.layers),this.addImageSize(n.imagesize,e.tileSize),this.addCoordSys(n.featurecoordsys,e.featureCoordSys),this.addCoordSys(n.filtercoordsys,e.filterCoordSys)}else this.request=null;OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},parseEnvelope:function(e,t){t&&t.length==4&&(e.minx=t[0],e.miny=t[1],e.maxx=t[2],e.maxy=t[3])},addLayers:function(e,t){for(var n=0,r=t.length;n<r;n++)e.push(t[n])},addImageSize:function(e,t){t!==null&&(e.width=t.w,e.height=t.h,e.printwidth=t.w,e.printheight=t.h)},addCoordSys:function(e,t){typeof t=="string"?(e.id=parseInt(t),e.string=t):typeof t=="object"&&t.proj!==null?(e.id=t.proj.srsProjNumber,e.string=t.proj.srsCode):e=t},iserror:function(e){var t=null;if(!e)t=this.response.error!=="";else{e=OpenLayers.Format.XML.prototype.read.apply(this,[e]);var n=e.documentElement.getElementsByTagName("ERROR");t=n!==null&&n.length>0}return t},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=null;e&&e.documentElement&&(e.documentElement.nodeName=="ARCXML"?t=e.documentElement:t=e.documentElement.getElementsByTagName("ARCXML")[0]);if(!t||t.firstChild.nodeName==="parsererror"){var n,r;try{n=e.firstChild.nodeValue,r=e.firstChild.childNodes[1].firstChild.nodeValue}catch(i){}throw{message:"Error parsing the ArcXML request",error:n,source:r}}var s=this.parseResponse(t);return s},write:function(e){e||(e=this.request);var t=this.createElementNS("","ARCXML");t.setAttribute("version","1.1");var n=this.createElementNS("","REQUEST");if(e.get_image!=null){var r=this.createElementNS("","GET_IMAGE");n.appendChild(r);var i=this.createElementNS("","PROPERTIES");r.appendChild(i);var s=e.get_image.properties;if(s.featurecoordsys!=null){var o=this.createElementNS("","FEATURECOORDSYS");i.appendChild(o),s.featurecoordsys.id===0?o.setAttribute("string",s.featurecoordsys.string):o.setAttribute("id",s.featurecoordsys.id)}if(s.filtercoordsys!=null){var u=this.createElementNS("","FILTERCOORDSYS");i.appendChild(u),s.filtercoordsys.id===0?u.setAttribute("string",s.filtercoordsys.string):u.setAttribute("id",s.filtercoordsys.id)}if(s.envelope!=null){var a=this.createElementNS("","ENVELOPE");i.appendChild(a),a.setAttribute("minx",s.envelope.minx),a.setAttribute("miny",s.envelope.miny),a.setAttribute("maxx",s.envelope.maxx),a.setAttribute("maxy",s.envelope.maxy)}var f=this.createElementNS("","IMAGESIZE");i.appendChild(f),f.setAttribute("height",s.imagesize.height),f.setAttribute("width",s.imagesize.width);if(s.imagesize.height!=s.imagesize.printheight||s.imagesize.width!=s.imagesize.printwidth)f.setAttribute("printheight",s.imagesize.printheight),f.setArrtibute("printwidth",s.imagesize.printwidth);if(s.background!=null){var l=this.createElementNS("","BACKGROUND");i.appendChild(l),l.setAttribute("color",s.background.color.r+","+s.background.color.g+","+s.background.color.b),s.background.transcolor!==null&&l.setAttribute("transcolor",s.background.transcolor.r+","+s.background.transcolor.g+","+s.background.transcolor.b)}if(s.layerlist!=null&&s.layerlist.length>0){var c=this.createElementNS("","LAYERLIST");i.appendChild(c);for(var h=0;h<s.layerlist.length;h++){var p=this.createElementNS("","LAYERDEF");c.appendChild(p),p.setAttribute("id",s.layerlist[h].id),p.setAttribute("visible",s.layerlist[h].visible);if(typeof s.layerlist[h].query=="object"){var d=s.layerlist[h].query;if(d.where.length<0)continue;var v=null;typeof d.spatialfilter=="boolean"&&d.spatialfilter?v=this.createElementNS("","SPATIALQUERY"):v=this.createElementNS("","QUERY"),v.setAttribute("where",d.where),typeof d.accuracy=="number"&&d.accuracy>0&&v.setAttribute("accuracy",d.accuracy),typeof d.featurelimit=="number"&&d.featurelimit<2e3&&v.setAttribute("featurelimit",d.featurelimit),typeof d.subfields=="string"&&d.subfields!="#ALL#"&&v.setAttribute("subfields",d.subfields),typeof d.joinexpression=="string"&&d.joinexpression.length>0&&v.setAttribute("joinexpression",d.joinexpression),typeof d.jointables=="string"&&d.jointables.length>0&&v.setAttribute("jointables",d.jointables),p.appendChild(v)}typeof s.layerlist[h].renderer=="object"&&this.addRenderer(p,s.layerlist[h].renderer)}}}else if(e.get_feature!=null){var r=this.createElementNS("","GET_FEATURES");r.setAttribute("outputmode","newxml"),r.setAttribute("checkesc","true"),e.get_feature.geometry?r.setAttribute("geometry",e.get_feature.geometry):r.setAttribute("geometry","false"),e.get_feature.compact&&r.setAttribute("compact",e.get_feature.compact),e.get_feature.featurelimit=="number"&&r.setAttribute("featurelimit",e.get_feature.featurelimit),r.setAttribute("globalenvelope","true"),n.appendChild(r);if(e.get_feature.layer!=null&&e.get_feature.layer.length>0){var m=this.createElementNS("","LAYER");m.setAttribute("id",e.get_feature.layer),r.appendChild(m)}var g=e.get_feature.query;if(g!=null){var y=null;g.isspatial?y=this.createElementNS("","SPATIALQUERY"):y=this.createElementNS("","QUERY"),r.appendChild(y),typeof g.accuracy=="number"&&y.setAttribute("accuracy",g.accuracy);if(g.featurecoordsys!=null){var b=this.createElementNS("","FEATURECOORDSYS");g.featurecoordsys.id==0?b.setAttribute("string",g.featurecoordsys.string):b.setAttribute("id",g.featurecoordsys.id),y.appendChild(b)}if(g.filtercoordsys!=null){var w=this.createElementNS("","FILTERCOORDSYS");g.filtercoordsys.id===0?w.setAttribute("string",g.filtercoordsys.string):w.setAttribute("id",g.filtercoordsys.id),y.appendChild(w)}if(g.buffer>0){var E=this.createElementNS("","BUFFER");E.setAttribute("distance",g.buffer),y.appendChild(E)}if(g.isspatial){var S=this.createElementNS("","SPATIALFILTER");S.setAttribute("relation",g.spatialfilter.relation),y.appendChild(S);if(g.spatialfilter.envelope){var x=this.createElementNS("","ENVELOPE");x.setAttribute("minx",g.spatialfilter.envelope.minx),x.setAttribute("miny",g.spatialfilter.envelope.miny),x.setAttribute("maxx",g.spatialfilter.envelope.maxx),x.setAttribute("maxy",g.spatialfilter.envelope.maxy),S.appendChild(x)}else typeof g.spatialfilter.polygon=="object"&&S.appendChild(this.writePolygonGeometry(g.spatialfilter.polygon))}g.where!=null&&g.where.length>0&&y.setAttribute("where",g.where)}}return t.appendChild(n),OpenLayers.Format.XML.prototype.write.apply(this,[t])},addGroupRenderer:function(e,t){var n=this.createElementNS("","GROUPRENDERER");e.appendChild(n);for(var r=0;r<t.length;r++){var i=t[r];this.addRenderer(n,i)}},addRenderer:function(e,t){if(OpenLayers.Util.isArray(t))this.addGroupRenderer(e,t);else{var n=this.createElementNS("",t.type.toUpperCase()+"RENDERER");e.appendChild(n),n.tagName=="VALUEMAPRENDERER"?this.addValueMapRenderer(n,t):n.tagName=="VALUEMAPLABELRENDERER"?this.addValueMapLabelRenderer(n,t):n.tagName=="SIMPLELABELRENDERER"?this.addSimpleLabelRenderer(n,t):n.tagName=="SCALEDEPENDENTRENDERER"&&this.addScaleDependentRenderer(n,t)}},addScaleDependentRenderer:function(e,t){(typeof t.lower=="string"||typeof t.lower=="number")&&e.setAttribute("lower",t.lower),(typeof t.upper=="string"||typeof t.upper=="number")&&e.setAttribute("upper",t.upper),this.addRenderer(e,t.renderer)},addValueMapLabelRenderer:function(e,t){e.setAttribute("lookupfield",t.lookupfield),e.setAttribute("labelfield",t.labelfield);if(typeof t.exacts=="object")for(var n=0,r=t.exacts.length;n<r;n++){var i=t.exacts[n],s=this.createElementNS("","EXACT");typeof i.value=="string"&&s.setAttribute("value",i.value),typeof i.label=="string"&&s.setAttribute("label",i.label),typeof i.method=="string"&&s.setAttribute("method",i.method),e.appendChild(s);if(typeof i.symbol=="object"){var o=null;i.symbol.type=="text"&&(o=this.createElementNS("","TEXTSYMBOL"));if(o!=null){var u=this.fontStyleKeys;for(var a=0,f=u.length;a<f;a++){var l=u[a];i.symbol[l]&&o.setAttribute(l,i.symbol[l])}s.appendChild(o)}}}},addValueMapRenderer:function(e,t){e.setAttribute("lookupfield",t.lookupfield);if(typeof t.ranges=="object")for(var n=0,r=t.ranges.length;n<r;n++){var i=t.ranges[n],s=this.createElementNS("","RANGE");s.setAttribute("lower",i.lower),s.setAttribute("upper",i.upper),e.appendChild(s);if(typeof i.symbol=="object"){var o=null;i.symbol.type=="simplepolygon"&&(o=this.createElementNS("","SIMPLEPOLYGONSYMBOL")),o!=null&&(typeof i.symbol.boundarycolor=="string"&&o.setAttribute("boundarycolor",i.symbol.boundarycolor),typeof i.symbol.fillcolor=="string"&&o.setAttribute("fillcolor",i.symbol.fillcolor),typeof i.symbol.filltransparency=="number"&&o.setAttribute("filltransparency",i.symbol.filltransparency),s.appendChild(o))}}else if(typeof t.exacts=="object")for(var u=0,a=t.exacts.length;u<a;u++){var f=t.exacts[u],l=this.createElementNS("","EXACT");typeof f.value=="string"&&l.setAttribute("value",f.value),typeof f.label=="string"&&l.setAttribute("label",f.label),typeof f.method=="string"&&l.setAttribute("method",f.method),e.appendChild(l);if(typeof f.symbol=="object"){var o=null;f.symbol.type=="simplemarker"&&(o=this.createElementNS("","SIMPLEMARKERSYMBOL")),o!=null&&(typeof f.symbol.antialiasing=="string"&&o.setAttribute("antialiasing",f.symbol.antialiasing),typeof f.symbol.color=="string"&&o.setAttribute("color",f.symbol.color),typeof f.symbol.outline=="string"&&o.setAttribute("outline",f.symbol.outline),typeof f.symbol.overlap=="string"&&o.setAttribute("overlap",f.symbol.overlap),typeof f.symbol.shadow=="string"&&o.setAttribute("shadow",f.symbol.shadow),typeof f.symbol.transparency=="number"&&o.setAttribute("transparency",f.symbol.transparency),typeof f.symbol.usecentroid=="string"&&o.setAttribute("usecentroid",f.symbol.usecentroid),typeof f.symbol.width=="number"&&o.setAttribute("width",f.symbol.width),l.appendChild(o))}}},addSimpleLabelRenderer:function(e,t){e.setAttribute("field",t.field);var n=["featureweight","howmanylabels","labelbufferratio","labelpriorities","labelweight","linelabelposition","rotationalangles"];for(var r=0,i=n.length;r<i;r++){var s=n[r];t[s]&&e.setAttribute(s,t[s])}if(t.symbol.type=="text"){var o=t.symbol,u=this.createElementNS("","TEXTSYMBOL");e.appendChild(u);var n=this.fontStyleKeys;for(var r=0,i=n.length;r<i;r++){var s=n[r];o[s]&&u.setAttribute(s,t[s])}}},writePolygonGeometry:function(e){if(e instanceof OpenLayers.Geometry.Polygon){var t=this.createElementNS("","POLYGON");for(var n=0,r=e.components.length;n<r;n++){var i=e.components[n],s=this.createElementNS("","RING");for(var o=0,u=i.components.length;o<u;o++){var a=i.components[o],f=this.createElementNS("","POINT");f.setAttribute("x",a.x),f.setAttribute("y",a.y),s.appendChild(f)}t.appendChild(s)}return t}throw{message:"Cannot write polygon geometry to ArcXML with an "+e.CLASS_NAME+" object.",geometry:e}},parseResponse:function(e){if(typeof e=="string"){var t=new OpenLayers.Format.XML;e=t.read(e)}var n=new OpenLayers.Format.ArcXML.Response,r=e.getElementsByTagName("ERROR");if(r!=null&&r.length>0)n.error=this.getChildValue(r,"Unknown error.");else{var i=e.getElementsByTagName("RESPONSE");if(i==null||i.length==0)return n.error="No RESPONSE tag found in ArcXML response.",n;var s=i[0].firstChild.nodeName;s=="#text"&&(s=i[0].firstChild.nextSibling.nodeName);if(s=="IMAGE"){var o=e.getElementsByTagName("ENVELOPE"),u=e.getElementsByTagName("OUTPUT");if(o==null||o.length==0)n.error="No ENVELOPE tag found in ArcXML response.";else if(u==null||u.length==0)n.error="No OUTPUT tag found in ArcXML response.";else{var a=this.parseAttributes(o[0]),f=this.parseAttributes(u[0]);typeof f.type=="string"?n.image={envelope:a,output:{type:f.type,data:this.getChildValue(u[0])}}:n.image={envelope:a,output:f}}}else if(s=="FEATURES"){var l=i[0].getElementsByTagName("FEATURES"),c=l[0].getElementsByTagName("FEATURECOUNT");n.features.featurecount=c[0].getAttribute("count");if(n.features.featurecount>0){var h=l[0].getElementsByTagName("ENVELOPE");n.features.envelope=this.parseAttributes(h[0],"number");var p=l[0].getElementsByTagName("FEATURE");for(var d=0;d<p.length;d++){var v=new OpenLayers.Feature.Vector,m=p[d].getElementsByTagName("FIELD");for(var g=0;g<m.length;g++){var y=m[g].getAttribute("name"),b=m[g].getAttribute("value");v.attributes[y]=b}var w=p[d].getElementsByTagName("POLYGON");if(w.length>0){var E=w[0].getElementsByTagName("RING"),S=[];for(var x=0;x<E.length;x++){var T=[];T.push(this.parsePointGeometry(E[x]));var N=E[x].getElementsByTagName("HOLE");for(var C=0;C<N.length;C++)T.push(this.parsePointGeometry(N[C]));N=null,S.push(new OpenLayers.Geometry.Polygon(T)),T=null}E=null,S.length==1?v.geometry=S[0]:v.geometry=new OpenLayers.Geometry.MultiPolygon(S)}n.features.feature.push(v)}}}else n.error="Unidentified response type."}return n},parseAttributes:function(e,t){var n={};for(var r=0;r<e.attributes.length;r++)t=="number"?n[e.attributes[r].nodeName]=parseFloat(e.attributes[r].nodeValue):n[e.attributes[r].nodeName]=e.attributes[r].nodeValue;return n},parsePointGeometry:function(e){var t=[],n=e.getElementsByTagName("COORDS");if(n.length>0){var r=this.getChildValue(n[0]);r=r.split(/;/);for(var i=0;i<r.length;i++){var s=r[i].split(/ /);t.push(new OpenLayers.Geometry.Point(s[0],s[1]))}n=null}else{var o=e.getElementsByTagName("POINT");if(o.length>0)for(var u=0;u<o.length;u++)t.push(new OpenLayers.Geometry.Point(parseFloat(o[u].getAttribute("x")),parseFloat(o[u].getAttribute("y"))));o=null}return new OpenLayers.Geometry.LinearRing(t)},CLASS_NAME:"OpenLayers.Format.ArcXML"}),OpenLayers.Format.ArcXML.Request=OpenLayers.Class({initialize:function(e){var t={get_image:{properties:{background:null,draw:!0,envelope:{minx:0,miny:0,maxx:0,maxy:0},featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},imagesize:{height:0,width:0,dpi:96,printheight:0,printwidth:0,scalesymbols:!1},layerlist:[],output:{baseurl:"",legendbaseurl:"",legendname:"",legendpath:"",legendurl:"",name:"",path:"",type:"jpg",url:""}}},get_feature:{layer:"",query:{isspatial:!1,featurecoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},filtercoordsys:{id:0,string:"",datumtransformid:0,datumtransformstring:""},buffer:0,where:"",spatialfilter:{relation:"envelope_intersection",envelope:null}}},environment:{separators:{cs:" ",ts:";"}},layer:[],workspaces:[]};return OpenLayers.Util.extend(this,t)},CLASS_NAME:"OpenLayers.Format.ArcXML.Request"}),OpenLayers.Format.ArcXML.Response=OpenLayers.Class({initialize:function(e){var t={image:{envelope:null,output:""},features:{featurecount:0,envelope:null,feature:[]},error:""};return OpenLayers.Util.extend(this,t)},CLASS_NAME:"OpenLayers.Format.ArcXML.Response"});