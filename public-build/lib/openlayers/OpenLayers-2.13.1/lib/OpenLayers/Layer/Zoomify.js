/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.Zoomify=OpenLayers.Class(OpenLayers.Layer.Grid,{size:null,isBaseLayer:!0,standardTileSize:256,tileOriginCorner:"tl",numberOfTiers:0,tileCountUpToTier:null,tierSizeInTiles:null,tierImageSize:null,initialize:function(e,t,n,r){this.initializeZoomify(n),OpenLayers.Layer.Grid.prototype.initialize.apply(this,[e,t,n,{},r])},initializeZoomify:function(e){var t=e.clone();this.size=e.clone();var n=new OpenLayers.Size(Math.ceil(t.w/this.standardTileSize),Math.ceil(t.h/this.standardTileSize));this.tierSizeInTiles=[n],this.tierImageSize=[t];while(t.w>this.standardTileSize||t.h>this.standardTileSize)t=new OpenLayers.Size(Math.floor(t.w/2),Math.floor(t.h/2)),n=new OpenLayers.Size(Math.ceil(t.w/this.standardTileSize),Math.ceil(t.h/this.standardTileSize)),this.tierSizeInTiles.push(n),this.tierImageSize.push(t);this.tierSizeInTiles.reverse(),this.tierImageSize.reverse(),this.numberOfTiers=this.tierSizeInTiles.length;var r=[1];this.tileCountUpToTier=[0];for(var i=1;i<this.numberOfTiers;i++)r.unshift(Math.pow(2,i)),this.tileCountUpToTier.push(this.tierSizeInTiles[i-1].w*this.tierSizeInTiles[i-1].h+this.tileCountUpToTier[i-1]);this.serverResolutions||(this.serverResolutions=r)},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments),this.tileCountUpToTier.length=0,this.tierSizeInTiles.length=0,this.tierImageSize.length=0},clone:function(e){return e==null&&(e=new OpenLayers.Layer.Zoomify(this.name,this.url,this.size,this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e]),e},getURL:function(e){e=this.adjustBounds(e);var t=this.getServerResolution(),n=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),r=Math.round((this.tileOrigin.lat-e.top)/(t*this.tileSize.h)),i=this.getZoomForResolution(t),s=n+r*this.tierSizeInTiles[i].w+this.tileCountUpToTier[i],o="TileGroup"+Math.floor(s/256)+"/"+i+"-"+n+"-"+r+".jpg",u=this.url;return OpenLayers.Util.isArray(u)&&(u=this.selectUrl(o,u)),u+o},getImageSize:function(){if(arguments.length>0){var e=this.adjustBounds(arguments[0]),t=this.getServerResolution(),n=Math.round((e.left-this.tileOrigin.lon)/(t*this.tileSize.w)),r=Math.round((this.tileOrigin.lat-e.top)/(t*this.tileSize.h)),i=this.getZoomForResolution(t),s=this.standardTileSize,o=this.standardTileSize;if(n==this.tierSizeInTiles[i].w-1)var s=this.tierImageSize[i].w%this.standardTileSize;if(r==this.tierSizeInTiles[i].h-1)var o=this.tierImageSize[i].h%this.standardTileSize;return new OpenLayers.Size(s,o)}return this.tileSize},setMap:function(e){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.tileOrigin=new OpenLayers.LonLat(this.map.maxExtent.left,this.map.maxExtent.top)},CLASS_NAME:"OpenLayers.Layer.Zoomify"});