/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.ArcGISCache=OpenLayers.Class(OpenLayers.Layer.XYZ,{url:null,tileOrigin:null,tileSize:new OpenLayers.Size(256,256),useArcGISServer:!0,type:"png",useScales:!1,overrideDPI:!1,initialize:function(e,t,n){OpenLayers.Layer.XYZ.prototype.initialize.apply(this,arguments),this.resolutions&&(this.serverResolutions=this.resolutions,this.maxExtent=this.getMaxExtentForResolution(this.resolutions[0]));if(this.layerInfo){var r=this.layerInfo,i=new OpenLayers.Bounds(r.fullExtent.xmin,r.fullExtent.ymin,r.fullExtent.xmax,r.fullExtent.ymax);this.projection="EPSG:"+r.spatialReference.wkid,this.sphericalMercator=r.spatialReference.wkid==102100,this.units=r.units=="esriFeet"?"ft":"m";if(!!r.tileInfo){this.tileSize=new OpenLayers.Size(r.tileInfo.width||r.tileInfo.cols,r.tileInfo.height||r.tileInfo.rows),this.tileOrigin=new OpenLayers.LonLat(r.tileInfo.origin.x,r.tileInfo.origin.y);var s=new OpenLayers.Geometry.Point(i.left,i.top),o=new OpenLayers.Geometry.Point(i.right,i.bottom);this.useScales?this.scales=[]:this.resolutions=[],this.lods=[];for(var u in r.tileInfo.lods)if(r.tileInfo.lods.hasOwnProperty(u)){var a=r.tileInfo.lods[u];this.useScales?this.scales.push(a.scale):this.resolutions.push(a.resolution);var f=this.getContainingTileCoords(s,a.resolution);a.startTileCol=f.x,a.startTileRow=f.y;var l=this.getContainingTileCoords(o,a.resolution);a.endTileCol=l.x,a.endTileRow=l.y,this.lods.push(a)}this.maxExtent=this.calculateMaxExtentWithLOD(this.lods[0]),this.serverResolutions=this.resolutions,this.overrideDPI&&r.tileInfo.dpi&&(OpenLayers.DOTS_PER_INCH=r.tileInfo.dpi)}}},getContainingTileCoords:function(e,t){return new OpenLayers.Pixel(Math.max(Math.floor((e.x-this.tileOrigin.lon)/(this.tileSize.w*t)),0),Math.max(Math.floor((this.tileOrigin.lat-e.y)/(this.tileSize.h*t)),0))},calculateMaxExtentWithLOD:function(e){var t=e.endTileCol-e.startTileCol+1,n=e.endTileRow-e.startTileRow+1,r=this.tileOrigin.lon+e.startTileCol*this.tileSize.w*e.resolution,i=r+t*this.tileSize.w*e.resolution,s=this.tileOrigin.lat-e.startTileRow*this.tileSize.h*e.resolution,o=s-n*this.tileSize.h*e.resolution;return new OpenLayers.Bounds(r,o,i,s)},calculateMaxExtentWithExtent:function(e,t){var n=new OpenLayers.Geometry.Point(e.left,e.top),r=new OpenLayers.Geometry.Point(e.right,e.bottom),i=this.getContainingTileCoords(n,t),s=this.getContainingTileCoords(r,t),o={resolution:t,startTileCol:i.x,startTileRow:i.y,endTileCol:s.x,endTileRow:s.y};return this.calculateMaxExtentWithLOD(o)},getUpperLeftTileCoord:function(e){var t=new OpenLayers.Geometry.Point(this.maxExtent.left,this.maxExtent.top);return this.getContainingTileCoords(t,e)},getLowerRightTileCoord:function(e){var t=new OpenLayers.Geometry.Point(this.maxExtent.right,this.maxExtent.bottom);return this.getContainingTileCoords(t,e)},getMaxExtentForResolution:function(e){var t=this.getUpperLeftTileCoord(e),n=this.getLowerRightTileCoord(e),r=n.x-t.x+1,i=n.y-t.y+1,s=this.tileOrigin.lon+t.x*this.tileSize.w*e,o=s+r*this.tileSize.w*e,u=this.tileOrigin.lat-t.y*this.tileSize.h*e,a=u-i*this.tileSize.h*e;return new OpenLayers.Bounds(s,a,o,u)},clone:function(e){return e==null&&(e=new OpenLayers.Layer.ArcGISCache(this.name,this.url,this.options)),OpenLayers.Layer.XYZ.prototype.clone.apply(this,[e])},initGriddedTiles:function(e){delete this._tileOrigin,OpenLayers.Layer.XYZ.prototype.initGriddedTiles.apply(this,arguments)},getMaxExtent:function(){var e=this.map.getResolution();return this.maxExtent=this.getMaxExtentForResolution(e)},getTileOrigin:function(){if(!this._tileOrigin){var e=this.getMaxExtent();this._tileOrigin=new OpenLayers.LonLat(e.left,e.bottom)}return this._tileOrigin},getURL:function(e){var t=this.getResolution(),n=this.tileOrigin.lon+t*this.tileSize.w/2,r=this.tileOrigin.lat-t*this.tileSize.h/2,i=e.getCenterLonLat(),s={x:i.lon,y:i.lat},o=Math.round(Math.abs((i.lon-n)/(t*this.tileSize.w))),u=Math.round(Math.abs((r-i.lat)/(t*this.tileSize.h))),a=this.map.getZoom();if(this.lods){var f=this.lods[this.map.getZoom()];if(o<f.startTileCol||o>f.endTileCol||u<f.startTileRow||u>f.endTileRow)return null}else{var l=this.getUpperLeftTileCoord(t),c=this.getLowerRightTileCoord(t);if(o<l.x||o>=c.x||u<l.y||u>=c.y)return null}var h=this.url,p=""+o+u+a;return OpenLayers.Util.isArray(h)&&(h=this.selectUrl(p,h)),this.useArcGISServer?h+="/tile/${z}/${y}/${x}":(o="C"+OpenLayers.Number.zeroPad(o,8,16),u="R"+OpenLayers.Number.zeroPad(u,8,16),a="L"+OpenLayers.Number.zeroPad(a,2,10),h=h+"/${z}/${y}/${x}."+this.type),h=OpenLayers.String.format(h,{x:o,y:u,z:a}),OpenLayers.Util.urlAppend(h,OpenLayers.Util.getParameterString(this.params))},CLASS_NAME:"OpenLayers.Layer.ArcGISCache"});