/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.Grid=OpenLayers.Class(OpenLayers.Layer.HTTPRequest,{tileSize:null,tileOriginCorner:"bl",tileOrigin:null,tileOptions:null,tileClass:OpenLayers.Tile.Image,grid:null,singleTile:!1,ratio:1.5,buffer:0,transitionEffect:"resize",numLoadingTiles:0,serverResolutions:null,loading:!1,backBuffer:null,gridResolution:null,backBufferResolution:null,backBufferLonLat:null,backBufferTimerId:null,removeBackBufferDelay:null,className:null,gridLayout:null,rowSign:null,transitionendEvents:["transitionend","webkitTransitionEnd","otransitionend","oTransitionEnd"],initialize:function(e,t,n,r){OpenLayers.Layer.HTTPRequest.prototype.initialize.apply(this,arguments),this.grid=[],this._removeBackBuffer=OpenLayers.Function.bind(this.removeBackBuffer,this),this.initProperties(),this.rowSign=this.tileOriginCorner.substr(0,1)==="t"?1:-1},initProperties:function(){this.options.removeBackBufferDelay===undefined&&(this.removeBackBufferDelay=this.singleTile?0:2500),this.options.className===undefined&&(this.className=this.singleTile?"olLayerGridSingleTile":"olLayerGrid")},setMap:function(e){OpenLayers.Layer.HTTPRequest.prototype.setMap.call(this,e),OpenLayers.Element.addClass(this.div,this.className)},removeMap:function(e){this.removeBackBuffer()},destroy:function(){this.removeBackBuffer(),this.clearGrid(),this.grid=null,this.tileSize=null,OpenLayers.Layer.HTTPRequest.prototype.destroy.apply(this,arguments)},clearGrid:function(){if(this.grid){for(var e=0,t=this.grid.length;e<t;e++){var n=this.grid[e];for(var r=0,i=n.length;r<i;r++){var s=n[r];this.destroyTile(s)}}this.grid=[],this.gridResolution=null,this.gridLayout=null}},addOptions:function(e,t){var n=e.singleTile!==undefined&&e.singleTile!==this.singleTile;OpenLayers.Layer.HTTPRequest.prototype.addOptions.apply(this,arguments),this.map&&n&&(this.initProperties(),this.clearGrid(),this.tileSize=this.options.tileSize,this.setTileSize(),this.moveTo(null,!0))},clone:function(e){return e==null&&(e=new OpenLayers.Layer.Grid(this.name,this.url,this.params,this.getOptions())),e=OpenLayers.Layer.HTTPRequest.prototype.clone.apply(this,[e]),this.tileSize!=null&&(e.tileSize=this.tileSize.clone()),e.grid=[],e.gridResolution=null,e.backBuffer=null,e.backBufferTimerId=null,e.loading=!1,e.numLoadingTiles=0,e},moveTo:function(e,t,n){OpenLayers.Layer.HTTPRequest.prototype.moveTo.apply(this,arguments),e=e||this.map.getExtent();if(e!=null){var r=!this.grid.length||t,i=this.getTilesBounds(),s=this.map.getResolution(),o=this.getServerResolution(s);if(this.singleTile){if(r||!n&&!i.containsBounds(e))t&&this.transitionEffect!=="resize"&&this.removeBackBuffer(),(!t||this.transitionEffect==="resize")&&this.applyBackBuffer(s),this.initSingleTile(e)}else r=r||!i.intersectsBounds(e,{worldBounds:this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent()}),r?(t&&(this.transitionEffect==="resize"||this.gridResolution===s)&&this.applyBackBuffer(s),this.initGriddedTiles(e)):this.moveGriddedTiles()}},getTileData:function(e){var t=null,n=e.lon,r=e.lat,i=this.grid.length;if(this.map&&i){var s=this.map.getResolution(),o=this.tileSize.w,u=this.tileSize.h,a=this.grid[0][0].bounds,f=a.left,l=a.top;if(n<f&&this.map.baseLayer.wrapDateLine){var c=this.map.getMaxExtent().getWidth(),h=Math.ceil((f-n)/c);n+=c*h}var p=(n-f)/(s*o),d=(l-r)/(s*u),v=Math.floor(p),m=Math.floor(d);if(m>=0&&m<i){var g=this.grid[m][v];g&&(t={tile:g,i:Math.floor((p-v)*o),j:Math.floor((d-m)*u)})}}return t},destroyTile:function(e){this.removeTileMonitoringHooks(e),e.destroy()},getServerResolution:function(e){var t=Number.POSITIVE_INFINITY;e=e||this.map.getResolution();if(this.serverResolutions&&OpenLayers.Util.indexOf(this.serverResolutions,e)===-1){var n,r,i,s;for(n=this.serverResolutions.length-1;n>=0;n--){i=this.serverResolutions[n],r=Math.abs(i-e);if(r>t)break;t=r,s=i}e=s}return e},getServerZoom:function(){var e=this.getServerResolution();return this.serverResolutions?OpenLayers.Util.indexOf(this.serverResolutions,e):this.map.getZoomForResolution(e)+(this.zoomOffset||0)},applyBackBuffer:function(e){this.backBufferTimerId!==null&&this.removeBackBuffer();var t=this.backBuffer;if(!t){t=this.createBackBuffer();if(!t)return;e===this.gridResolution?this.div.insertBefore(t,this.div.firstChild):this.map.baseLayer.div.parentNode.insertBefore(t,this.map.baseLayer.div),this.backBuffer=t;var n=this.grid[0][0].bounds;this.backBufferLonLat={lon:n.left,lat:n.top},this.backBufferResolution=this.gridResolution}var r=this.backBufferResolution/e,i=t.childNodes,s;for(var o=i.length-1;o>=0;--o)s=i[o],s.style.top=(r*s._i*s._h|0)+"px",s.style.left=(r*s._j*s._w|0)+"px",s.style.width=Math.round(r*s._w)+"px",s.style.height=Math.round(r*s._h)+"px";var u=this.getViewPortPxFromLonLat(this.backBufferLonLat,e),a=this.map.layerContainerOriginPx.x,f=this.map.layerContainerOriginPx.y;t.style.left=Math.round(u.x-a)+"px",t.style.top=Math.round(u.y-f)+"px"},createBackBuffer:function(){var e;if(this.grid.length>0){e=document.createElement("div"),e.id=this.div.id+"_bb",e.className="olBackBuffer",e.style.position="absolute";var t=this.map;e.style.zIndex=this.transitionEffect==="resize"?this.getZIndex()-1:t.Z_INDEX_BASE.BaseLayer-(t.getNumLayers()-t.getLayerIndex(this));for(var n=0,r=this.grid.length;n<r;n++)for(var i=0,s=this.grid[n].length;i<s;i++){var o=this.grid[n][i],u=this.grid[n][i].createBackBuffer();u&&(u._i=n,u._j=i,u._w=o.size.w,u._h=o.size.h,u.id=o.id+"_bb",e.appendChild(u))}}return e},removeBackBuffer:function(){if(this._transitionElement){for(var e=this.transitionendEvents.length-1;e>=0;--e)OpenLayers.Event.stopObserving(this._transitionElement,this.transitionendEvents[e],this._removeBackBuffer);delete this._transitionElement}this.backBuffer&&(this.backBuffer.parentNode&&this.backBuffer.parentNode.removeChild(this.backBuffer),this.backBuffer=null,this.backBufferResolution=null,this.backBufferTimerId!==null&&(window.clearTimeout(this.backBufferTimerId),this.backBufferTimerId=null))},moveByPx:function(e,t){this.singleTile||this.moveGriddedTiles()},setTileSize:function(e){this.singleTile&&(e=this.map.getSize(),e.h=parseInt(e.h*this.ratio,10),e.w=parseInt(e.w*this.ratio,10)),OpenLayers.Layer.HTTPRequest.prototype.setTileSize.apply(this,[e])},getTilesBounds:function(){var e=null,t=this.grid.length;if(t){var n=this.grid[t-1][0].bounds,r=this.grid[0].length*n.getWidth(),i=this.grid.length*n.getHeight();e=new OpenLayers.Bounds(n.left,n.bottom,n.left+r,n.bottom+i)}return e},initSingleTile:function(e){this.events.triggerEvent("retile");var t=e.getCenterLonLat(),n=e.getWidth()*this.ratio,r=e.getHeight()*this.ratio,i=new OpenLayers.Bounds(t.lon-n/2,t.lat-r/2,t.lon+n/2,t.lat+r/2),s=this.map.getLayerPxFromLonLat({lon:i.left,lat:i.top});this.grid.length||(this.grid[0]=[]);var o=this.grid[0][0];o?o.moveTo(i,s):(o=this.addTile(i,s),this.addTileMonitoringHooks(o),o.draw(),this.grid[0][0]=o),this.removeExcessTiles(1,1),this.gridResolution=this.getServerResolution()},calculateGridLayout:function(e,t,n){var r=n*this.tileSize.w,i=n*this.tileSize.h,s=e.left-t.lon,o=Math.floor(s/r)-this.buffer,u=this.rowSign,a=u*(t.lat-e.top+i),f=Math[~u?"floor":"ceil"](a/i)-this.buffer*u;return{tilelon:r,tilelat:i,startcol:o,startrow:f}},getTileOrigin:function(){var e=this.tileOrigin;if(!e){var t=this.getMaxExtent(),n={tl:["left","top"],tr:["right","top"],bl:["left","bottom"],br:["right","bottom"]}[this.tileOriginCorner];e=new OpenLayers.LonLat(t[n[0]],t[n[1]])}return e},getTileBoundsForGridIndex:function(e,t){var n=this.getTileOrigin(),r=this.gridLayout,i=r.tilelon,s=r.tilelat,o=r.startcol,u=r.startrow,a=this.rowSign;return new OpenLayers.Bounds(n.lon+(o+t)*i,n.lat-(u+e*a)*s*a,n.lon+(o+t+1)*i,n.lat-(u+(e-1)*a)*s*a)},initGriddedTiles:function(e){this.events.triggerEvent("retile");var t=this.map.getSize(),n=this.getTileOrigin(),r=this.map.getResolution(),i=this.getServerResolution(),s=r/i,o={w:this.tileSize.w/s,h:this.tileSize.h/s},u=Math.ceil(t.h/o.h)+2*this.buffer+1,a=Math.ceil(t.w/o.w)+2*this.buffer+1,f=this.calculateGridLayout(e,n,i);this.gridLayout=f;var l=f.tilelon,c=f.tilelat,h=this.map.layerContainerOriginPx.x,p=this.map.layerContainerOriginPx.y,d=this.getTileBoundsForGridIndex(0,0),v=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(d.left,d.top));v.x=Math.round(v.x)-h,v.y=Math.round(v.y)-p;var m=[],g=this.map.getCenter(),y=0;do{var b=this.grid[y];b||(b=[],this.grid.push(b));var w=0;do{d=this.getTileBoundsForGridIndex(y,w);var E=v.clone();E.x=E.x+w*Math.round(o.w),E.y=E.y+y*Math.round(o.h);var S=b[w];S?S.moveTo(d,E,!1):(S=this.addTile(d,E),this.addTileMonitoringHooks(S),b.push(S));var x=d.getCenterLonLat();m.push({tile:S,distance:Math.pow(x.lon-g.lon,2)+Math.pow(x.lat-g.lat,2)}),w+=1}while(d.right<=e.right+l*this.buffer||w<a);y+=1}while(d.bottom>=e.bottom-c*this.buffer||y<u);this.removeExcessTiles(y,w);var r=this.getServerResolution();this.gridResolution=r,m.sort(function(e,t){return e.distance-t.distance});for(var T=0,N=m.length;T<N;++T)m[T].tile.draw()},getMaxExtent:function(){return this.maxExtent},addTile:function(e,t){var n=new this.tileClass(this,t,e,null,this.tileSize,this.tileOptions);return this.events.triggerEvent("addtile",{tile:n}),n},addTileMonitoringHooks:function(e){var t="olTileReplacing";e.onLoadStart=function(){this.loading===!1&&(this.loading=!0,this.events.triggerEvent("loadstart")),this.events.triggerEvent("tileloadstart",{tile:e}),this.numLoadingTiles++,!this.singleTile&&this.backBuffer&&this.gridResolution===this.backBufferResolution&&OpenLayers.Element.addClass(e.getTile(),t)},e.onLoadEnd=function(n){this.numLoadingTiles--;var r=n.type==="unload";this.events.triggerEvent("tileloaded",{tile:e,aborted:r});if(!this.singleTile&&!r&&this.backBuffer&&this.gridResolution===this.backBufferResolution){var i=e.getTile();if(OpenLayers.Element.getStyle(i,"display")==="none"){var s=document.getElementById(e.id+"_bb");s&&s.parentNode.removeChild(s)}OpenLayers.Element.removeClass(i,t)}if(this.numLoadingTiles===0){if(this.backBuffer)if(this.backBuffer.childNodes.length===0)this.removeBackBuffer();else{this._transitionElement=r?this.div.lastChild:e.imgDiv;var o=this.transitionendEvents;for(var u=o.length-1;u>=0;--u)OpenLayers.Event.observe(this._transitionElement,o[u],this._removeBackBuffer);this.backBufferTimerId=window.setTimeout(this._removeBackBuffer,this.removeBackBufferDelay)}this.loading=!1,this.events.triggerEvent("loadend")}},e.onLoadError=function(){this.events.triggerEvent("tileerror",{tile:e})},e.events.on({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},removeTileMonitoringHooks:function(e){e.unload(),e.events.un({loadstart:e.onLoadStart,loadend:e.onLoadEnd,unload:e.onLoadEnd,loaderror:e.onLoadError,scope:this})},moveGriddedTiles:function(){var e=this.buffer+1;for(;;){var t=this.grid[0][0],n={x:t.position.x+this.map.layerContainerOriginPx.x,y:t.position.y+this.map.layerContainerOriginPx.y},r=this.getServerResolution()/this.map.getResolution(),i={w:Math.round(this.tileSize.w*r),h:Math.round(this.tileSize.h*r)};if(n.x>-i.w*(e-1))this.shiftColumn(!0,i);else if(n.x<-i.w*e)this.shiftColumn(!1,i);else if(n.y>-i.h*(e-1))this.shiftRow(!0,i);else{if(!(n.y<-i.h*e))break;this.shiftRow(!1,i)}}},shiftRow:function(e,t){var n=this.grid,r=e?0:n.length-1,i=e?-1:1,s=this.rowSign,o=this.gridLayout;o.startrow+=i*s;var u=n[r],a=n[e?"pop":"shift"]();for(var f=0,l=a.length;f<l;f++){var c=a[f],h=u[f].position.clone();h.y+=t.h*i,c.moveTo(this.getTileBoundsForGridIndex(r,f),h)}n[e?"unshift":"push"](a)},shiftColumn:function(e,t){var n=this.grid,r=e?0:n[0].length-1,i=e?-1:1,s=this.gridLayout;s.startcol+=i;for(var o=0,u=n.length;o<u;o++){var a=n[o],f=a[r].position.clone(),l=a[e?"pop":"shift"]();f.x+=t.w*i,l.moveTo(this.getTileBoundsForGridIndex(o,r),f),a[e?"unshift":"push"](l)}},removeExcessTiles:function(e,t){var n,r;while(this.grid.length>e){var i=this.grid.pop();for(n=0,r=i.length;n<r;n++){var s=i[n];this.destroyTile(s)}}for(n=0,r=this.grid.length;n<r;n++)while(this.grid[n].length>t){var i=this.grid[n],s=i.pop();this.destroyTile(s)}},onMapResize:function(){this.singleTile&&(this.clearGrid(),this.setTileSize())},getTileBounds:function(e){var t=this.maxExtent,n=this.getResolution(),r=n*this.tileSize.w,i=n*this.tileSize.h,s=this.getLonLatFromViewPortPx(e),o=t.left+r*Math.floor((s.lon-t.left)/r),u=t.bottom+i*Math.floor((s.lat-t.bottom)/i);return new OpenLayers.Bounds(o,u,o+r,u+i)},CLASS_NAME:"OpenLayers.Layer.Grid"});