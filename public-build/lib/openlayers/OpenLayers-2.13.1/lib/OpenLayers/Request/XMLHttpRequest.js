// XMLHttpRequest.js Copyright (C) 2010 Sergey Ilinsky (http://www.ilinsky.com)
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

(function(){function i(){this._object=e&&!r?new e:new window.ActiveXObject("Microsoft.XMLHTTP"),this._listeners=[]}function s(){return new i}function o(e){e._object.send(e._data);if(t&&!e._async){e.readyState=s.OPENED,f(e);while(e.readyState<s.DONE){e.readyState++,u(e);if(e._aborted)return}}}function u(e){s.onreadystatechange&&s.onreadystatechange.apply(e),e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function a(e){var t=e.responseXML,r=e.responseText;n&&r&&t&&!t.documentElement&&e.getResponseHeader("Content-Type").match(/[^\/]+\/[^\+]+\+xml/)&&(t=new window.ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.validateOnParse=!1,t.loadXML(r));if(t)if(n&&t.parseError!=0||!t.documentElement||t.documentElement&&t.documentElement.tagName=="parsererror")return null;return t}function f(e){try{e.responseText=e._object.responseText}catch(t){}try{e.responseXML=a(e._object)}catch(t){}try{e.status=e._object.status}catch(t){}try{e.statusText=e._object.statusText}catch(t){}}function l(e){e._object.onreadystatechange=new window.Function}var e=window.XMLHttpRequest,t=!!window.controllers,n=window.document.all&&!window.opera,r=n&&window.navigator.userAgent.match(/MSIE 7.0/);s.prototype=i.prototype,t&&e.wrapped&&(s.wrapped=e.wrapped),s.UNSENT=0,s.OPENED=1,s.HEADERS_RECEIVED=2,s.LOADING=3,s.DONE=4,s.prototype.readyState=s.UNSENT,s.prototype.responseText="",s.prototype.responseXML=null,s.prototype.status=0,s.prototype.statusText="",s.prototype.priority="NORMAL",s.prototype.onreadystatechange=null,s.onreadystatechange=null,s.onopen=null,s.onsend=null,s.onabort=null,s.prototype.open=function(e,r,i,o,a){delete this._headers,arguments.length<3&&(i=!0),this._async=i;var c=this,h=this.readyState,p;n&&i&&(p=function(){h!=s.DONE&&(l(c),c.abort())},window.attachEvent("onunload",p)),s.onopen&&s.onopen.apply(this,arguments),arguments.length>4?this._object.open(e,r,i,o,a):arguments.length>3?this._object.open(e,r,i,o):this._object.open(e,r,i),this.readyState=s.OPENED,u(this),this._object.onreadystatechange=function(){if(t&&!i)return;c.readyState=c._object.readyState,f(c);if(c._aborted){c.readyState=s.UNSENT;return}c.readyState==s.DONE&&(delete c._data,l(c),n&&i&&window.detachEvent("onunload",p)),h!=c.readyState&&u(c),h=c.readyState}},s.prototype.send=function(e){s.onsend&&s.onsend.apply(this,arguments),arguments.length||(e=null),e&&e.nodeType&&(e=window.XMLSerializer?(new window.XMLSerializer).serializeToString(e):e.xml,this._headers["Content-Type"]||this._object.setRequestHeader("Content-Type","application/xml")),this._data=e,o(this)},s.prototype.abort=function(){s.onabort&&s.onabort.apply(this,arguments),this.readyState>s.UNSENT&&(this._aborted=!0),this._object.abort(),l(this),this.readyState=s.UNSENT,delete this._data},s.prototype.getAllResponseHeaders=function(){return this._object.getAllResponseHeaders()},s.prototype.getResponseHeader=function(e){return this._object.getResponseHeader(e)},s.prototype.setRequestHeader=function(e,t){return this._headers||(this._headers={}),this._headers[e]=t,this._object.setRequestHeader(e,t)},s.prototype.addEventListener=function(e,t,n){for(var r=0,i;i=this._listeners[r];r++)if(i[0]==e&&i[1]==t&&i[2]==n)return;this._listeners.push([e,t,n])},s.prototype.removeEventListener=function(e,t,n){for(var r=0,i;i=this._listeners[r];r++)if(i[0]==e&&i[1]==t&&i[2]==n)break;i&&this._listeners.splice(r,1)},s.prototype.dispatchEvent=function(e){var t={type:e.type,target:this,currentTarget:this,eventPhase:2,bubbles:e.bubbles,cancelable:e.cancelable,timeStamp:e.timeStamp,stopPropagation:function(){},preventDefault:function(){},initEvent:function(){}};t.type=="readystatechange"&&this.onreadystatechange&&(this.onreadystatechange.handleEvent||this.onreadystatechange).apply(this,[t]);for(var n=0,r;r=this._listeners[n];n++)r[0]==t.type&&!r[2]&&(r[1].handleEvent||r[1]).apply(this,[t])},s.prototype.toString=function(){return"[object XMLHttpRequest]"},s.toString=function(){return"[XMLHttpRequest]"},window.Function.prototype.apply||(window.Function.prototype.apply=function(e,t){t||(t=[]),e.__func=this,e.__func(t[0],t[1],t[2],t[3],t[4]),delete e.__func}),OpenLayers.Request||(OpenLayers.Request={}),OpenLayers.Request.XMLHttpRequest=s})();