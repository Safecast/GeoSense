/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.Graticule=OpenLayers.Class(OpenLayers.Control,{autoActivate:!0,intervals:[45,30,20,10,5,2,1,.5,.2,.1,.05,.01,.005,.002,.001],displayInLayerSwitcher:!0,visible:!0,numPoints:50,targetSize:200,layerName:null,labelled:!0,labelFormat:"dm",lineSymbolizer:{strokeColor:"#333",strokeWidth:1,strokeOpacity:.5},labelSymbolizer:{},gratLayer:null,initialize:function(e){e=e||{},e.layerName=e.layerName||OpenLayers.i18n("Graticule"),OpenLayers.Control.prototype.initialize.apply(this,[e]),this.labelSymbolizer.stroke=!1,this.labelSymbolizer.fill=!1,this.labelSymbolizer.label="${label}",this.labelSymbolizer.labelAlign="${labelAlign}",this.labelSymbolizer.labelXOffset="${xOffset}",this.labelSymbolizer.labelYOffset="${yOffset}"},destroy:function(){this.deactivate(),OpenLayers.Control.prototype.destroy.apply(this,arguments),this.gratLayer&&(this.gratLayer.destroy(),this.gratLayer=null)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.gratLayer){var e=new OpenLayers.Style({},{rules:[new OpenLayers.Rule({symbolizer:{Point:this.labelSymbolizer,Line:this.lineSymbolizer}})]});this.gratLayer=new OpenLayers.Layer.Vector(this.layerName,{styleMap:new OpenLayers.StyleMap({"default":e}),visibility:this.visible,displayInLayerSwitcher:this.displayInLayerSwitcher})}return this.div},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.map.addLayer(this.gratLayer),this.map.events.register("moveend",this,this.update),this.update(),!0):!1},deactivate:function(){return OpenLayers.Control.prototype.deactivate.apply(this,arguments)?(this.map.events.unregister("moveend",this,this.update),this.map.removeLayer(this.gratLayer),!0):!1},update:function(){var e=this.map.getExtent();if(!e)return;this.gratLayer.destroyFeatures();var t=new OpenLayers.Projection("EPSG:4326"),n=this.map.getProjectionObject(),r=this.map.getResolution();n.proj&&n.proj.projName=="longlat"&&(this.numPoints=1);var i=this.map.getCenter(),s=new OpenLayers.Pixel(i.lon,i.lat);OpenLayers.Projection.transform(s,n,t);var o=this.targetSize*r;o*=o;var u;for(var a=0;a<this.intervals.length;++a){u=this.intervals[a];var f=u/2,l=s.offset({x:-f,y:-f}),c=s.offset({x:f,y:f});OpenLayers.Projection.transform(l,t,n),OpenLayers.Projection.transform(c,t,n);var h=(l.x-c.x)*(l.x-c.x)+(l.y-c.y)*(l.y-c.y);if(h<=o)break}s.x=Math.floor(s.x/u)*u,s.y=Math.floor(s.y/u)*u;var p=0,d=[s.clone()],v=s.clone(),m;do v=v.offset({x:0,y:u}),m=OpenLayers.Projection.transform(v.clone(),t,n),d.unshift(v);while(e.containsPixel(m)&&++p<1e3);v=s.clone();do v=v.offset({x:0,y:-u}),m=OpenLayers.Projection.transform(v.clone(),t,n),d.push(v);while(e.containsPixel(m)&&++p<1e3);p=0;var g=[s.clone()];v=s.clone();do v=v.offset({x:-u,y:0}),m=OpenLayers.Projection.transform(v.clone(),t,n),g.unshift(v);while(e.containsPixel(m)&&++p<1e3);v=s.clone();do v=v.offset({x:u,y:0}),m=OpenLayers.Projection.transform(v.clone(),t,n),g.push(v);while(e.containsPixel(m)&&++p<1e3);var y=[];for(var a=0;a<g.length;++a){var b=g[a].x,w=[],E=null,S=Math.min(d[0].y,90),x=Math.max(d[d.length-1].y,-90),T=(S-x)/this.numPoints,N=x;for(var C=0;C<=this.numPoints;++C){var k=new OpenLayers.Geometry.Point(b,N);k.transform(t,n),w.push(k),N+=T,k.y>=e.bottom&&!E&&(E=k)}if(this.labelled){var L=new OpenLayers.Geometry.Point(E.x,e.bottom),A={value:b,label:this.labelled?OpenLayers.Util.getFormattedLonLat(b,"lon",this.labelFormat):"",labelAlign:"cb",xOffset:0,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(L,A))}var O=new OpenLayers.Geometry.LineString(w);y.push(new OpenLayers.Feature.Vector(O))}for(var C=0;C<d.length;++C){N=d[C].y;if(N<-90||N>90)continue;var w=[],M=g[0].x,_=g[g.length-1].x,D=(_-M)/this.numPoints,b=M,E=null;for(var a=0;a<=this.numPoints;++a){var k=new OpenLayers.Geometry.Point(b,N);k.transform(t,n),w.push(k),b+=D,k.x<e.right&&(E=k)}if(this.labelled){var L=new OpenLayers.Geometry.Point(e.right,E.y),A={value:N,label:this.labelled?OpenLayers.Util.getFormattedLonLat(N,"lat",this.labelFormat):"",labelAlign:"rb",xOffset:-2,yOffset:2};this.gratLayer.addFeatures(new OpenLayers.Feature.Vector(L,A))}var O=new OpenLayers.Geometry.LineString(w);y.push(new OpenLayers.Feature.Vector(O))}this.gratLayer.addFeatures(y)},CLASS_NAME:"OpenLayers.Control.Graticule"});