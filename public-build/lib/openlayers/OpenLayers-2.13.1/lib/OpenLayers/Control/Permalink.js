/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.Permalink=OpenLayers.Class(OpenLayers.Control,{argParserClass:OpenLayers.Control.ArgParser,element:null,anchor:!1,base:"",displayProjection:null,initialize:function(e,t,n){e!==null&&typeof e=="object"&&!OpenLayers.Util.isElement(e)?(n=e,this.base=document.location.href,OpenLayers.Control.prototype.initialize.apply(this,[n]),this.element!=null&&(this.element=OpenLayers.Util.getElement(this.element))):(OpenLayers.Control.prototype.initialize.apply(this,[n]),this.element=OpenLayers.Util.getElement(e),this.base=t||document.location.href)},destroy:function(){this.element&&this.element.parentNode==this.div&&(this.div.removeChild(this.element),this.element=null),this.map&&this.map.events.unregister("moveend",this,this.updateLink),OpenLayers.Control.prototype.destroy.apply(this,arguments)},setMap:function(e){OpenLayers.Control.prototype.setMap.apply(this,arguments);for(var t=0,n=this.map.controls.length;t<n;t++){var r=this.map.controls[t];if(r.CLASS_NAME==this.argParserClass.CLASS_NAME){r.displayProjection!=this.displayProjection&&(this.displayProjection=r.displayProjection);break}}t==this.map.controls.length&&this.map.addControl(new this.argParserClass({displayProjection:this.displayProjection}))},draw:function(){return OpenLayers.Control.prototype.draw.apply(this,arguments),!this.element&&!this.anchor&&(this.element=document.createElement("a"),this.element.innerHTML=OpenLayers.i18n("Permalink"),this.element.href="",this.div.appendChild(this.element)),this.map.events.on({moveend:this.updateLink,changelayer:this.updateLink,changebaselayer:this.updateLink,scope:this}),this.updateLink(),this.div},updateLink:function(){var e=this.anchor?"#":"?",t=this.base,n=null;t.indexOf("#")!=-1&&this.anchor==0&&(n=t.substring(t.indexOf("#"),t.length)),t.indexOf(e)!=-1&&(t=t.substring(0,t.indexOf(e)));var r=t.split("#");t=r[0]+e+OpenLayers.Util.getParameterString(this.createParams()),n&&(t+=n),this.anchor&&!this.element?window.location.href=t:this.element.href=t},createParams:function(e,t,n){e=e||this.map.getCenter();var r=OpenLayers.Util.getParameters(this.base);if(e){r.zoom=t||this.map.getZoom();var i=e.lat,s=e.lon;if(this.displayProjection){var o=OpenLayers.Projection.transform({x:s,y:i},this.map.getProjectionObject(),this.displayProjection);s=o.x,i=o.y}r.lat=Math.round(i*1e5)/1e5,r.lon=Math.round(s*1e5)/1e5,n=n||this.map.layers,r.layers="";for(var u=0,a=n.length;u<a;u++){var f=n[u];f.isBaseLayer?r.layers+=f==this.map.baseLayer?"B":"0":r.layers+=f.getVisibility()?"T":"F"}}return r},CLASS_NAME:"OpenLayers.Control.Permalink"});