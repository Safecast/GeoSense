/* Copyright (c) 2006-2013 by OpenLayers Contributors (see authors.txt for
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.Split=OpenLayers.Class(OpenLayers.Control,{layer:null,source:null,sourceOptions:null,tolerance:null,edge:!0,deferDelete:!1,mutual:!0,targetFilter:null,sourceFilter:null,handler:null,initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,[e]),this.options=e||{},this.options.source&&this.setSource(this.options.source)},setSource:function(e){this.active?(this.deactivate(),this.handler&&(this.handler.destroy(),delete this.handler),this.source=e,this.activate()):this.source=e},activate:function(){var e=OpenLayers.Control.prototype.activate.call(this);return e&&(this.source?this.source.events&&this.source.events.on({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}):(this.handler||(this.handler=new OpenLayers.Handler.Path(this,{done:function(e){this.onSketchComplete({feature:new OpenLayers.Feature.Vector(e)})}},{layerOptions:this.sourceOptions})),this.handler.activate())),e},deactivate:function(){var e=OpenLayers.Control.prototype.deactivate.call(this);return e&&this.source&&this.source.events&&this.source.events.un({sketchcomplete:this.onSketchComplete,afterfeaturemodified:this.afterFeatureModified,scope:this}),e},onSketchComplete:function(e){return this.feature=null,!this.considerSplit(e.feature)},afterFeatureModified:function(e){if(e.modified){var t=e.feature;typeof t.geometry.split=="function"&&(this.feature=e.feature,this.considerSplit(e.feature))}},removeByGeometry:function(e,t){for(var n=0,r=e.length;n<r;++n)if(e[n].geometry===t){e.splice(n,1);break}},isEligible:function(e){return e.geometry?e.state!==OpenLayers.State.DELETE&&typeof e.geometry.split=="function"&&this.feature!==e&&(!this.targetFilter||this.targetFilter.evaluate(e.attributes)):!1},considerSplit:function(e){var t=!1,n=!1;if(!this.sourceFilter||this.sourceFilter.evaluate(e.attributes)){var r=this.layer&&this.layer.features||[],i,s,o,u=[],a=[],f=this.layer===this.source&&this.mutual,l={edge:this.edge,tolerance:this.tolerance,mutual:f},c=[e.geometry],h,p,d,v;for(var m=0,g=r.length;m<g;++m){h=r[m];if(this.isEligible(h)){p=[h.geometry];for(var y=0;y<c.length;++y){d=c[y];for(var b=0;b<p.length;++b)i=p[b],d.getBounds().intersectsBounds(i.getBounds())&&(s=d.split(i,l),s&&(o=this.events.triggerEvent("beforesplit",{source:e,target:h}),o!==!1&&(f&&(v=s[0],v.length>1&&(v.unshift(y,1),Array.prototype.splice.apply(c,v),y+=v.length-3),s=s[1]),s.length>1&&(s.unshift(b,1),Array.prototype.splice.apply(p,s),b+=s.length-3))))}p&&p.length>1&&(this.geomsToFeatures(h,p),this.events.triggerEvent("split",{original:h,features:p}),Array.prototype.push.apply(u,p),a.push(h),n=!0)}}c&&c.length>1&&(this.geomsToFeatures(e,c),this.events.triggerEvent("split",{original:e,features:c}),Array.prototype.push.apply(u,c),a.push(e),t=!0);if(t||n){if(this.deferDelete){var w,E=[];for(var m=0,g=a.length;m<g;++m)w=a[m],w.state===OpenLayers.State.INSERT?E.push(w):(w.state=OpenLayers.State.DELETE,this.layer.drawFeature(w));this.layer.destroyFeatures(E,{silent:!0});for(var m=0,g=u.length;m<g;++m)u[m].state=OpenLayers.State.INSERT}else this.layer.destroyFeatures(a,{silent:!0});this.layer.addFeatures(u,{silent:!0}),this.events.triggerEvent("aftersplit",{source:e,features:u})}}return t},geomsToFeatures:function(e,t){var n=e.clone();delete n.geometry;var r;for(var i=0,s=t.length;i<s;++i)r=n.clone(),r.geometry=t[i],r.state=OpenLayers.State.INSERT,t[i]=r},destroy:function(){this.active&&this.deactivate(),OpenLayers.Control.prototype.destroy.call(this)},CLASS_NAME:"OpenLayers.Control.Split"});