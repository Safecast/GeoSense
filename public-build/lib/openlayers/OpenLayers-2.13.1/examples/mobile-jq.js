function fixContentHeight(){var e=$("div[data-role='footer']:visible"),t=$("div[data-role='content']:visible:visible"),n=$(window).height(),r=n-e.outerHeight();t.outerHeight()+e.outerHeight()!==n&&(r-=t.outerHeight()-t.height()+1,t.height(r)),window.map&&window.map instanceof OpenLayers.Map?map.updateSize():(init(function(e){selectedFeature=e,$.mobile.changePage("#popup","pop")}),initLayerList())}function initLayerList(){$("#layerspage").page(),$("<li>",{"data-role":"list-divider",text:"Base Layers"}).appendTo("#layerslist");var e=map.getLayersBy("isBaseLayer",!0);$.each(e,function(){addLayerToList(this)}),$("<li>",{"data-role":"list-divider",text:"Overlay Layers"}).appendTo("#layerslist");var t=map.getLayersBy("isBaseLayer",!1);$.each(t,function(){addLayerToList(this)}),$("#layerslist").listview("refresh"),map.events.register("addlayer",this,function(e){addLayerToList(e.layer)})}function addLayerToList(e){var t=$("<li>",{"data-icon":"check","class":e.visibility?"checked":""}).append($("<a />",{text:e.name}).click(function(){$.mobile.changePage("#mappage"),e.isBaseLayer?e.map.setBaseLayer(e):e.setVisibility(!e.getVisibility())})).appendTo("#layerslist");e.events.on({visibilitychanged:function(){$(t).toggleClass("checked")}})}window.location.replace(window.location.href.split("#")[0]+"#mappage");var selectedFeature=null;$("#plus").live("click",function(){map.zoomIn()}),$("#minus").live("click",function(){map.zoomOut()}),$("#locate").live("click",function(){var e=map.getControlsBy("id","locate-control")[0];e.active?e.getCurrentLocation():e.activate()}),$("#mappage").live("pageshow",function(){fixContentHeight()}),$(window).bind("orientationchange resize pageshow",fixContentHeight),$("#popup").live("pageshow",function(e,t){var n="";for(var r in selectedFeature.attributes)n+="<li><div style='width:25%;float:left'>"+r+"</div><div style='width:75%;float:right'>"+selectedFeature.attributes[r]+"</div></li>";$("ul#details-list").empty().append(n).listview("refresh")}),$("#searchpage").live("pageshow",function(e,t){$("#query").bind("change",function(e){$("#search_results").empty();if($("#query")[0].value==="")return;$.mobile.showPageLoadingMsg(),e.preventDefault();var t="http://ws.geonames.org/searchJSON?featureClass=P&maxRows=10";t+="&name_startsWith="+$("#query")[0].value,$.getJSON(t,function(e){$.each(e.geonames,function(){var e=this;$("<li>").hide().append($("<h2 />",{text:e.name})).append($("<p />",{html:"<b>"+e.countryName+"</b> "+e.fcodeName})).appendTo("#search_results").click(function(){$.mobile.changePage("#mappage");var t=new OpenLayers.LonLat(e.lng,e.lat);map.setCenter(t.transform(gg,sm),10)}).show()}),$("#search_results").listview("refresh"),$.mobile.hidePageLoadingMsg()})}),$("#searchpage").die("pageshow",arguments.callee)});