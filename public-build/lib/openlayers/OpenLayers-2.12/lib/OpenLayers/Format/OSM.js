/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.OSM=OpenLayers.Class(OpenLayers.Format.XML,{checkTags:!1,interestingTagsExclude:null,areaTags:null,initialize:function(e){var t={interestingTagsExclude:["source","source_ref","source:ref","history","attribution","created_by"],areaTags:["area","building","leisure","tourism","ruins","historic","landuse","military","natural","sport"]};t=OpenLayers.Util.extend(t,e);var n={};for(var r=0;r<t.interestingTagsExclude.length;r++)n[t.interestingTagsExclude[r]]=!0;t.interestingTagsExclude=n;var i={};for(var r=0;r<t.areaTags.length;r++)i[t.areaTags[r]]=!0;t.areaTags=i,this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[t])},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=this.getNodes(e),n=this.getWays(e),r=new Array(n.length);for(var i=0;i<n.length;i++){var s=new Array(n[i].nodes.length),o=this.isWayArea(n[i])?1:0;for(var u=0;u<n[i].nodes.length;u++){var a=t[n[i].nodes[u]],f=new OpenLayers.Geometry.Point(a.lon,a.lat);f.osm_id=parseInt(n[i].nodes[u]),s[u]=f,a.used=!0}var l=null;o?l=new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(s)):l=new OpenLayers.Geometry.LineString(s),this.internalProjection&&this.externalProjection&&l.transform(this.externalProjection,this.internalProjection);var c=new OpenLayers.Feature.Vector(l,n[i].tags);c.osm_id=parseInt(n[i].id),c.fid="way."+c.osm_id,r[i]=c}for(var h in t){var a=t[h];if(!a.used||this.checkTags){var p=null;if(this.checkTags){var d=this.getTags(a.node,!0);if(a.used&&!d[1])continue;p=d[0]}else p=this.getTags(a.node);var c=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a.lon,a.lat),p);this.internalProjection&&this.externalProjection&&c.geometry.transform(this.externalProjection,this.internalProjection),c.osm_id=parseInt(h),c.fid="node."+c.osm_id,r.push(c)}a.node=null}return r},getNodes:function(e){var t=e.getElementsByTagName("node"),n={};for(var r=0;r<t.length;r++){var i=t[r],s=i.getAttribute("id");n[s]={lat:i.getAttribute("lat"),lon:i.getAttribute("lon"),node:i}}return n},getWays:function(e){var t=e.getElementsByTagName("way"),n=[];for(var r=0;r<t.length;r++){var i=t[r],s={id:i.getAttribute("id")};s.tags=this.getTags(i);var o=i.getElementsByTagName("nd");s.nodes=new Array(o.length);for(var u=0;u<o.length;u++)s.nodes[u]=o[u].getAttribute("ref");n.push(s)}return n},getTags:function(e,t){var n=e.getElementsByTagName("tag"),r={},i=!1;for(var s=0;s<n.length;s++){var o=n[s].getAttribute("k");r[o]=n[s].getAttribute("v"),t&&(this.interestingTagsExclude[o]||(i=!0))}return t?[r,i]:r},isWayArea:function(e){var t=!1,n=!1;e.nodes[0]==e.nodes[e.nodes.length-1]&&(t=!0);if(this.checkTags)for(var r in e.tags)if(this.areaTags[r]){n=!0;break}return t&&(this.checkTags?n:!0)},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]),this.osm_id=1,this.created_nodes={};var t=this.createElementNS(null,"osm");t.setAttribute("version","0.5"),t.setAttribute("generator","OpenLayers "+OpenLayers.VERSION_NUMBER);for(var n=e.length-1;n>=0;n--){var r=this.createFeatureNodes(e[n]);for(var i=0;i<r.length;i++)t.appendChild(r[i])}return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureNodes:function(e){var t=[],n=e.geometry.CLASS_NAME,r=n.substring(n.lastIndexOf(".")+1);r=r.toLowerCase();var i=this.createXML[r];return i&&(t=i.apply(this,[e])),t},createXML:{point:function(e){var t=null,n=e.geometry?e.geometry:e;this.internalProjection&&this.externalProjection&&(n=n.clone(),n.transform(this.internalProjection,this.externalProjection));var r=!1;e.osm_id?(t=e.osm_id,this.created_nodes[t]&&(r=!0)):(t=-this.osm_id,this.osm_id++);if(r)i=this.created_nodes[t];else var i=this.createElementNS(null,"node");return this.created_nodes[t]=i,i.setAttribute("id",t),i.setAttribute("lon",n.x),i.setAttribute("lat",n.y),e.attributes&&this.serializeTags(e,i),this.setState(e,i),r?[]:[i]},linestring:function(e){var t,n=[],r=e.geometry;e.osm_id?t=e.osm_id:(t=-this.osm_id,this.osm_id++);var i=this.createElementNS(null,"way");i.setAttribute("id",t);for(var s=0;s<r.components.length;s++){var o=this.createXML.point.apply(this,[r.components[s]]);if(o.length){o=o[0];var u=o.getAttribute("id");n.push(o)}else u=r.components[s].osm_id,o=this.created_nodes[u];this.setState(e,o);var a=this.createElementNS(null,"nd");a.setAttribute("ref",u),i.appendChild(a)}return this.serializeTags(e,i),n.push(i),n},polygon:function(e){var t=OpenLayers.Util.extend({area:"yes"},e.attributes),n=new OpenLayers.Feature.Vector(e.geometry.components[0],t);return n.osm_id=e.osm_id,this.createXML.linestring.apply(this,[n])}},serializeTags:function(e,t){for(var n in e.attributes){var r=this.createElementNS(null,"tag");r.setAttribute("k",n),r.setAttribute("v",e.attributes[n]),t.appendChild(r)}},setState:function(e,t){if(e.state){var n=null;switch(e.state){case OpenLayers.State.UPDATE:n="modify";case OpenLayers.State.DELETE:n="delete"}n&&t.setAttribute("action",n)}},CLASS_NAME:"OpenLayers.Format.OSM"});