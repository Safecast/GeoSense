/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.Atom=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{atom:"http://www.w3.org/2005/Atom",georss:"http://www.georss.org/georss"},feedTitle:"untitled",defaultEntryTitle:"untitled",gmlParser:null,xy:!1,read:function(e){return typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),this.parseFeatures(e)},write:function(e){var t;if(OpenLayers.Util.isArray(e)){t=this.createElementNSPlus("atom:feed"),t.appendChild(this.createElementNSPlus("atom:title",{value:this.feedTitle}));for(var n=0,r=e.length;n<r;n++)t.appendChild(this.buildEntryNode(e[n]))}else t=this.buildEntryNode(e);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},buildContentNode:function(e){var t=this.createElementNSPlus("atom:content",{attributes:{type:e.type||null}});if(e.src)t.setAttribute("src",e.src);else if(e.type=="text"||e.type==null)t.appendChild(this.createTextNode(e.value));else if(e.type=="html"){if(typeof e.value!="string")throw"HTML content must be in form of an escaped string";t.appendChild(this.createTextNode(e.value))}else e.type=="xhtml"?t.appendChild(e.value):e.type=="xhtml"||e.type.match(/(\+|\/)xml$/)?t.appendChild(e.value):t.appendChild(this.createTextNode(e.value));return t},buildEntryNode:function(e){var t=e.attributes,n=t.atom||{},r=this.createElementNSPlus("atom:entry");if(n.authors){var i=OpenLayers.Util.isArray(n.authors)?n.authors:[n.authors];for(var s=0,o=i.length;s<o;s++)r.appendChild(this.buildPersonConstructNode("author",i[s]))}if(n.categories){var u=OpenLayers.Util.isArray(n.categories)?n.categories:[n.categories],a;for(var s=0,o=u.length;s<o;s++)a=u[s],r.appendChild(this.createElementNSPlus("atom:category",{attributes:{term:a.term,scheme:a.scheme||null,label:a.label||null}}))}n.content&&r.appendChild(this.buildContentNode(n.content));if(n.contributors){var f=OpenLayers.Util.isArray(n.contributors)?n.contributors:[n.contributors];for(var s=0,o=f.length;s<o;s++)r.appendChild(this.buildPersonConstructNode("contributor",f[s]))}e.fid&&r.appendChild(this.createElementNSPlus("atom:id",{value:e.fid}));if(n.links){var l=OpenLayers.Util.isArray(n.links)?n.links:[n.links],c;for(var s=0,o=l.length;s<o;s++)c=l[s],r.appendChild(this.createElementNSPlus("atom:link",{attributes:{href:c.href,rel:c.rel||null,type:c.type||null,hreflang:c.hreflang||null,title:c.title||null,length:c.length||null}}))}n.published&&r.appendChild(this.createElementNSPlus("atom:published",{value:n.published})),n.rights&&r.appendChild(this.createElementNSPlus("atom:rights",{value:n.rights})),(n.summary||t.description)&&r.appendChild(this.createElementNSPlus("atom:summary",{value:n.summary||t.description})),r.appendChild(this.createElementNSPlus("atom:title",{value:n.title||t.title||this.defaultEntryTitle})),n.updated&&r.appendChild(this.createElementNSPlus("atom:updated",{value:n.updated}));if(e.geometry){var h=this.createElementNSPlus("georss:where");h.appendChild(this.buildGeometryNode(e.geometry)),r.appendChild(h)}return r},initGmlParser:function(){this.gmlParser=new OpenLayers.Format.GML.v3({xy:this.xy,featureNS:"http://example.com#feature",internalProjection:this.internalProjection,externalProjection:this.externalProjection})},buildGeometryNode:function(e){this.gmlParser||this.initGmlParser();var t=this.gmlParser.writeNode("feature:_geometry",e);return t.firstChild},buildPersonConstructNode:function(e,t){var n=["uri","email"],r=this.createElementNSPlus("atom:"+e);r.appendChild(this.createElementNSPlus("atom:name",{value:t.name}));for(var i=0,s=n.length;i<s;i++)t[n[i]]&&r.appendChild(this.createElementNSPlus("atom:"+n[i],{value:t[n[i]]}));return r},getFirstChildValue:function(e,t,n,r){var i,s=this.getElementsByTagNameNS(e,t,n);return s&&s.length>0?i=this.getChildValue(s[0],r):i=r,i},parseFeature:function(e){var t={},n=null,r=null,i=null,s=this.namespaces.atom;this.parsePersonConstructs(e,"author",t),r=this.getElementsByTagNameNS(e,s,"category"),r.length>0&&(t.categories=[]);for(var o=0,u=r.length;o<u;o++)n={},n.term=r[o].getAttribute("term"),i=r[o].getAttribute("scheme"),i&&(n.scheme=i),i=r[o].getAttribute("label"),i&&(n.label=i),t.categories.push(n);r=this.getElementsByTagNameNS(e,s,"content"),r.length>0&&(n={},i=r[0].getAttribute("type"),i&&(n.type=i),i=r[0].getAttribute("src"),i?n.src=i:(n.type=="text"||n.type=="html"||n.type==null?n.value=this.getFirstChildValue(e,s,"content",null):n.type=="xhtml"||n.type.match(/(\+|\/)xml$/)?n.value=this.getChildEl(r[0]):n.value=this.getFirstChildValue(e,s,"content",null),t.content=n)),this.parsePersonConstructs(e,"contributor",t),t.id=this.getFirstChildValue(e,s,"id",null),r=this.getElementsByTagNameNS(e,s,"link"),r.length>0&&(t.links=new Array(r.length));var a=["rel","type","hreflang","title","length"];for(var o=0,u=r.length;o<u;o++){n={},n.href=r[o].getAttribute("href");for(var f=0,l=a.length;f<l;f++)i=r[o].getAttribute(a[f]),i&&(n[a[f]]=i);t.links[o]=n}n=this.getFirstChildValue(e,s,"published",null),n&&(t.published=n),n=this.getFirstChildValue(e,s,"rights",null),n&&(t.rights=n),n=this.getFirstChildValue(e,s,"summary",null),n&&(t.summary=n),t.title=this.getFirstChildValue(e,s,"title",null),t.updated=this.getFirstChildValue(e,s,"updated",null);var c={title:t.title,description:t.summary,atom:t},h=this.parseLocations(e)[0],p=new OpenLayers.Feature.Vector(h,c);return p.fid=t.id,p},parseFeatures:function(e){var t=[],n=this.getElementsByTagNameNS(e,this.namespaces.atom,"entry");n.length==0&&(n=[e]);for(var r=0,i=n.length;r<i;r++)t.push(this.parseFeature(n[r]));return t},parseLocations:function(e){var t=this.namespaces.georss,n={components:[]},r=this.getElementsByTagNameNS(e,t,"where");if(r&&r.length>0){this.gmlParser||this.initGmlParser();for(var i=0,s=r.length;i<s;i++)this.gmlParser.readChildNodes(r[i],n)}var o=n.components,u=this.getElementsByTagNameNS(e,t,"point");if(u&&u.length>0)for(var i=0,s=u.length;i<s;i++){var a=OpenLayers.String.trim(u[i].firstChild.nodeValue).split(/\s+/);a.length!=2&&(a=OpenLayers.String.trim(u[i].firstChild.nodeValue).split(/\s*,\s*/)),o.push(new OpenLayers.Geometry.Point(a[1],a[0]))}var f=this.getElementsByTagNameNS(e,t,"line");if(f&&f.length>0){var l,c,h;for(var i=0,s=f.length;i<s;i++){l=OpenLayers.String.trim(f[i].firstChild.nodeValue).split(/\s+/),h=[];for(var p=0,d=l.length;p<d;p+=2)c=new OpenLayers.Geometry.Point(l[p+1],l[p]),h.push(c);o.push(new OpenLayers.Geometry.LineString(h))}}var v=this.getElementsByTagNameNS(e,t,"polygon");if(v&&v.length>0){var l,c,h;for(var i=0,s=v.length;i<s;i++){l=OpenLayers.String.trim(v[i].firstChild.nodeValue).split(/\s+/),h=[];for(var p=0,d=l.length;p<d;p+=2)c=new OpenLayers.Geometry.Point(l[p+1],l[p]),h.push(c);o.push(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(o)]))}}if(this.internalProjection&&this.externalProjection)for(var i=0,s=o.length;i<s;i++)o[i]&&o[i].transform(this.externalProjection,this.internalProjection);return o},parsePersonConstructs:function(e,t,n){var r=[],i=this.namespaces.atom,s=this.getElementsByTagNameNS(e,i,t),o=["uri","email"];for(var u=0,a=s.length;u<a;u++){var f={};f.name=this.getFirstChildValue(s[u],i,"name",null);for(var l=0,c=o.length;l<c;l++){var h=this.getFirstChildValue(s[u],i,o[l],null);h&&(f[o[l]]=h)}r.push(f)}r.length>0&&(n[t+"s"]=r)},CLASS_NAME:"OpenLayers.Format.Atom"});