/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.GML=OpenLayers.Class(OpenLayers.Format.XML,{featureNS:"http://mapserver.gis.umn.edu/mapserver",featurePrefix:"feature",featureName:"featureMember",layerName:"features",geometryName:"geometry",collectionName:"FeatureCollection",gmlns:"http://www.opengis.net/gml",extractAttributes:!0,xy:!0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=this.getElementsByTagNameNS(e.documentElement,this.gmlns,this.featureName),n=[];for(var r=0;r<t.length;r++){var i=this.parseFeature(t[r]);i&&n.push(i)}return n},parseFeature:function(e){var t=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],n,r,i,s;for(var o=0;o<t.length;++o){n=t[o],r=this.getElementsByTagNameNS(e,this.gmlns,n);if(r.length>0){s=this.parseGeometry[n.toLowerCase()];if(!s)throw new TypeError("Unsupported geometry type: "+n);i=s.apply(this,[r[0]]),this.internalProjection&&this.externalProjection&&i.transform(this.externalProjection,this.internalProjection);break}}var u,a=this.getElementsByTagNameNS(e,this.gmlns,"Box");for(o=0;o<a.length;++o){var f=a[o],l=this.parseGeometry.box.apply(this,[f]),c=f.parentNode,h=c.localName||c.nodeName.split(":").pop();h==="boundedBy"?u=l:i=l.toGeometry()}var p;this.extractAttributes&&(p=this.parseAttributes(e));var d=new OpenLayers.Feature.Vector(i,p);d.bounds=u,d.gml={featureType:e.firstChild.nodeName.split(":")[1],featureNS:e.firstChild.namespaceURI,featureNSPrefix:e.firstChild.prefix};var v=e.firstChild,m;while(v){if(v.nodeType==1){m=v.getAttribute("fid")||v.getAttribute("id");if(m)break}v=v.nextSibling}return d.fid=m,d},parseGeometry:{point:function(e){var t,n,r=[],t=this.getElementsByTagNameNS(e,this.gmlns,"pos");t.length>0&&(n=t[0].firstChild.nodeValue,n=n.replace(this.regExes.trimSpace,""),r=n.split(this.regExes.splitSpace)),r.length==0&&(t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),t.length>0&&(n=t[0].firstChild.nodeValue,n=n.replace(this.regExes.removeSpace,""),r=n.split(",")));if(r.length==0){t=this.getElementsByTagNameNS(e,this.gmlns,"coord");if(t.length>0){var i=this.getElementsByTagNameNS(t[0],this.gmlns,"X"),s=this.getElementsByTagNameNS(t[0],this.gmlns,"Y");i.length>0&&s.length>0&&(r=[i[0].firstChild.nodeValue,s[0].firstChild.nodeValue])}}return r.length==2&&(r[2]=null),this.xy?new OpenLayers.Geometry.Point(r[0],r[1],r[2]):new OpenLayers.Geometry.Point(r[1],r[0],r[2])},multipoint:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Point"),n=[];if(t.length>0){var r;for(var i=0;i<t.length;++i)r=this.parseGeometry.point.apply(this,[t[i]]),r&&n.push(r)}return new OpenLayers.Geometry.MultiPoint(n)},linestring:function(e,t){var n,r,i=[],s=[];n=this.getElementsByTagNameNS(e,this.gmlns,"posList");if(n.length>0){r=this.getChildValue(n[0]),r=r.replace(this.regExes.trimSpace,""),i=r.split(this.regExes.splitSpace);var o=parseInt(n[0].getAttribute("dimension")),u,a,f,l;for(var c=0;c<i.length/o;++c)u=c*o,a=i[u],f=i[u+1],l=o==2?null:i[u+2],this.xy?s.push(new OpenLayers.Geometry.Point(a,f,l)):s.push(new OpenLayers.Geometry.Point(f,a,l))}if(i.length==0){n=this.getElementsByTagNameNS(e,this.gmlns,"coordinates");if(n.length>0){r=this.getChildValue(n[0]),r=r.replace(this.regExes.trimSpace,""),r=r.replace(this.regExes.trimComma,",");var h=r.split(this.regExes.splitSpace);for(var c=0;c<h.length;++c)i=h[c].split(","),i.length==2&&(i[2]=null),this.xy?s.push(new OpenLayers.Geometry.Point(i[0],i[1],i[2])):s.push(new OpenLayers.Geometry.Point(i[1],i[0],i[2]))}}var p=null;return s.length!=0&&(t?p=new OpenLayers.Geometry.LinearRing(s):p=new OpenLayers.Geometry.LineString(s)),p},multilinestring:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LineString"),n=[];if(t.length>0){var r;for(var i=0;i<t.length;++i)r=this.parseGeometry.linestring.apply(this,[t[i]]),r&&n.push(r)}return new OpenLayers.Geometry.MultiLineString(n)},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"LinearRing"),n=[];if(t.length>0){var r;for(var i=0;i<t.length;++i)r=this.parseGeometry.linestring.apply(this,[t[i],!0]),r&&n.push(r)}return new OpenLayers.Geometry.Polygon(n)},multipolygon:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"Polygon"),n=[];if(t.length>0){var r;for(var i=0;i<t.length;++i)r=this.parseGeometry.polygon.apply(this,[t[i]]),r&&n.push(r)}return new OpenLayers.Geometry.MultiPolygon(n)},envelope:function(e){var t=[],n,r,i=this.getElementsByTagNameNS(e,this.gmlns,"lowerCorner");if(i.length>0){var s=[];i.length>0&&(n=i[0].firstChild.nodeValue,n=n.replace(this.regExes.trimSpace,""),s=n.split(this.regExes.splitSpace)),s.length==2&&(s[2]=null);if(this.xy)var o=new OpenLayers.Geometry.Point(s[0],s[1],s[2]);else var o=new OpenLayers.Geometry.Point(s[1],s[0],s[2])}var u=this.getElementsByTagNameNS(e,this.gmlns,"upperCorner");if(u.length>0){var s=[];u.length>0&&(n=u[0].firstChild.nodeValue,n=n.replace(this.regExes.trimSpace,""),s=n.split(this.regExes.splitSpace)),s.length==2&&(s[2]=null);if(this.xy)var a=new OpenLayers.Geometry.Point(s[0],s[1],s[2]);else var a=new OpenLayers.Geometry.Point(s[1],s[0],s[2])}if(o&&a){t.push(new OpenLayers.Geometry.Point(o.x,o.y)),t.push(new OpenLayers.Geometry.Point(a.x,o.y)),t.push(new OpenLayers.Geometry.Point(a.x,a.y)),t.push(new OpenLayers.Geometry.Point(o.x,a.y)),t.push(new OpenLayers.Geometry.Point(o.x,o.y));var f=new OpenLayers.Geometry.LinearRing(t);r=new OpenLayers.Geometry.Polygon([f])}return r},box:function(e){var t=this.getElementsByTagNameNS(e,this.gmlns,"coordinates"),n,r,i=null,s=null;t.length>0&&(n=t[0].firstChild.nodeValue,r=n.split(" "),r.length==2&&(i=r[0].split(","),s=r[1].split(",")));if(i!==null&&s!==null)return new OpenLayers.Bounds(parseFloat(i[0]),parseFloat(i[1]),parseFloat(s[0]),parseFloat(s[1]))}},parseAttributes:function(e){var t={},n=e.firstChild,r,i,s,o,u,a,f;while(n){if(n.nodeType==1){r=n.childNodes;for(i=0;i<r.length;++i){s=r[i];if(s.nodeType==1){o=s.childNodes;if(o.length==1){u=o[0];if(u.nodeType==3||u.nodeType==4)a=s.prefix?s.nodeName.split(":")[1]:s.nodeName,f=u.nodeValue.replace(this.regExes.trimSpace,""),t[a]=f}else t[s.nodeName.split(":").pop()]=null}}break}n=n.nextSibling}return t},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);var t=this.createElementNS("http://www.opengis.net/wfs","wfs:"+this.collectionName);for(var n=0;n<e.length;n++)t.appendChild(this.createFeatureXML(e[n]));return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=e.geometry,n=this.buildGeometryNode(t),r=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.geometryName);r.appendChild(n);var i=this.createElementNS(this.gmlns,"gml:"+this.featureName),s=this.createElementNS(this.featureNS,this.featurePrefix+":"+this.layerName),o=e.fid||e.id;s.setAttribute("fid",o),s.appendChild(r);for(var u in e.attributes){var a=this.createTextNode(e.attributes[u]),f=u.substring(u.lastIndexOf(":")+1),l=this.createElementNS(this.featureNS,this.featurePrefix+":"+f);l.appendChild(a),s.appendChild(l)}return i.appendChild(s),i},buildGeometryNode:function(e){this.externalProjection&&this.internalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t=e.CLASS_NAME,n=t.substring(t.lastIndexOf(".")+1),r=this.buildGeometry[n.toLowerCase()];return r.apply(this,[e])},buildGeometry:{point:function(e){var t=this.createElementNS(this.gmlns,"gml:Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){var t=this.createElementNS(this.gmlns,"gml:MultiPoint"),n=e.components,r,i;for(var s=0;s<n.length;s++)r=this.createElementNS(this.gmlns,"gml:pointMember"),i=this.buildGeometry.point.apply(this,[n[s]]),r.appendChild(i),t.appendChild(r);return t},linestring:function(e){var t=this.createElementNS(this.gmlns,"gml:LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){var t=this.createElementNS(this.gmlns,"gml:MultiLineString"),n=e.components,r,i;for(var s=0;s<n.length;++s)r=this.createElementNS(this.gmlns,"gml:lineStringMember"),i=this.buildGeometry.linestring.apply(this,[n[s]]),r.appendChild(i),t.appendChild(r);return t},linearring:function(e){var t=this.createElementNS(this.gmlns,"gml:LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){var t=this.createElementNS(this.gmlns,"gml:Polygon"),n=e.components,r,i,s;for(var o=0;o<n.length;++o)s=o==0?"outerBoundaryIs":"innerBoundaryIs",r=this.createElementNS(this.gmlns,"gml:"+s),i=this.buildGeometry.linearring.apply(this,[n[o]]),r.appendChild(i),t.appendChild(r);return t},multipolygon:function(e){var t=this.createElementNS(this.gmlns,"gml:MultiPolygon"),n=e.components,r,i;for(var s=0;s<n.length;++s)r=this.createElementNS(this.gmlns,"gml:polygonMember"),i=this.buildGeometry.polygon.apply(this,[n[s]]),r.appendChild(i),t.appendChild(r);return t},bounds:function(e){var t=this.createElementNS(this.gmlns,"gml:Box");return t.appendChild(this.buildCoordinatesNode(e)),t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.gmlns,"gml:coordinates");t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," ");var n=[];if(e instanceof OpenLayers.Bounds)n.push(e.left+","+e.bottom),n.push(e.right+","+e.top);else{var r=e.components?e.components:[e];for(var i=0;i<r.length;i++)n.push(r[i].x+","+r[i].y)}var s=this.createTextNode(n.join(" "));return t.appendChild(s),t},CLASS_NAME:"OpenLayers.Format.GML"});