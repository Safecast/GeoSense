/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.GeoRSS=OpenLayers.Class(OpenLayers.Format.XML,{rssns:"http://backend.userland.com/rss2",featureNS:"http://mapserver.gis.umn.edu/mapserver",georssns:"http://www.georss.org/georss",geons:"http://www.w3.org/2003/01/geo/wgs84_pos#",featureTitle:"Untitled",featureDescription:"No Description",gmlParser:null,xy:!1,createGeometryFromItem:function(e){var t=this.getElementsByTagNameNS(e,this.georssns,"point"),n=this.getElementsByTagNameNS(e,this.geons,"lat"),r=this.getElementsByTagNameNS(e,this.geons,"long"),i=this.getElementsByTagNameNS(e,this.georssns,"line"),s=this.getElementsByTagNameNS(e,this.georssns,"polygon"),o=this.getElementsByTagNameNS(e,this.georssns,"where"),u=this.getElementsByTagNameNS(e,this.georssns,"box");if(t.length>0||n.length>0&&r.length>0){var a;t.length>0?(a=OpenLayers.String.trim(t[0].firstChild.nodeValue).split(/\s+/),a.length!=2&&(a=OpenLayers.String.trim(t[0].firstChild.nodeValue).split(/\s*,\s*/))):a=[parseFloat(n[0].firstChild.nodeValue),parseFloat(r[0].firstChild.nodeValue)];var f=new OpenLayers.Geometry.Point(a[1],a[0])}else if(i.length>0){var l=OpenLayers.String.trim(this.getChildValue(i[0])).split(/\s+/),c=[],t;for(var h=0,p=l.length;h<p;h+=2)t=new OpenLayers.Geometry.Point(l[h+1],l[h]),c.push(t);f=new OpenLayers.Geometry.LineString(c)}else if(s.length>0){var l=OpenLayers.String.trim(this.getChildValue(s[0])).split(/\s+/),c=[],t;for(var h=0,p=l.length;h<p;h+=2)t=new OpenLayers.Geometry.Point(l[h+1],l[h]),c.push(t);f=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(c)])}else if(o.length>0){this.gmlParser||(this.gmlParser=new OpenLayers.Format.GML({xy:this.xy}));var d=this.gmlParser.parseFeature(o[0]);f=d.geometry}else if(u.length>0){var l=OpenLayers.String.trim(u[0].firstChild.nodeValue).split(/\s+/),c=[],t;l.length>3&&(t=new OpenLayers.Geometry.Point(l[1],l[0]),c.push(t),t=new OpenLayers.Geometry.Point(l[1],l[2]),c.push(t),t=new OpenLayers.Geometry.Point(l[3],l[2]),c.push(t),t=new OpenLayers.Geometry.Point(l[3],l[0]),c.push(t),t=new OpenLayers.Geometry.Point(l[1],l[0]),c.push(t)),f=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(c)])}return f&&this.internalProjection&&this.externalProjection&&f.transform(this.externalProjection,this.internalProjection),f},createFeatureFromItem:function(e){var t=this.createGeometryFromItem(e),n=this._getChildValue(e,"*","title",this.featureTitle),r=this._getChildValue(e,"*","description",this._getChildValue(e,"*","content",this._getChildValue(e,"*","summary",this.featureDescription))),i=this._getChildValue(e,"*","link");if(!i)try{i=this.getElementsByTagNameNS(e,"*","link")[0].getAttribute("href")}catch(s){i=null}var o=this._getChildValue(e,"*","id",null),u={title:n,description:r,link:i},a=new OpenLayers.Feature.Vector(t,u);return a.fid=o,a},_getChildValue:function(e,t,n,r){var i,s=this.getElementsByTagNameNS(e,t,n);return s&&s[0]&&s[0].firstChild&&s[0].firstChild.nodeValue?i=this.getChildValue(s[0]):i=r==undefined?"":r,i},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=null;t=this.getElementsByTagNameNS(e,"*","item"),t.length==0&&(t=this.getElementsByTagNameNS(e,"*","entry"));var n=t.length,r=new Array(n);for(var i=0;i<n;i++)r[i]=this.createFeatureFromItem(t[i]);return r},write:function(e){var t;if(OpenLayers.Util.isArray(e)){t=this.createElementNS(this.rssns,"rss");for(var n=0,r=e.length;n<r;n++)t.appendChild(this.createFeatureXML(e[n]))}else t=this.createFeatureXML(e);return OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFeatureXML:function(e){var t=this.buildGeometryNode(e.geometry),n=this.createElementNS(this.rssns,"item"),r=this.createElementNS(this.rssns,"title");r.appendChild(this.createTextNode(e.attributes.title?e.attributes.title:""));var i=this.createElementNS(this.rssns,"description");i.appendChild(this.createTextNode(e.attributes.description?e.attributes.description:"")),n.appendChild(r),n.appendChild(i);if(e.attributes.link){var s=this.createElementNS(this.rssns,"link");s.appendChild(this.createTextNode(e.attributes.link)),n.appendChild(s)}for(var o in e.attributes){if(o=="link"||o=="title"||o=="description")continue;var u=this.createTextNode(e.attributes[o]),a=o;o.search(":")!=-1&&(a=o.split(":")[1]);var f=this.createElementNS(this.featureNS,"feature:"+a);f.appendChild(u),n.appendChild(f)}return n.appendChild(t),n},buildGeometryNode:function(e){this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var t;if(e.CLASS_NAME=="OpenLayers.Geometry.Polygon")t=this.createElementNS(this.georssns,"georss:polygon"),t.appendChild(this.buildCoordinatesNode(e.components[0]));else if(e.CLASS_NAME=="OpenLayers.Geometry.LineString")t=this.createElementNS(this.georssns,"georss:line"),t.appendChild(this.buildCoordinatesNode(e));else{if(e.CLASS_NAME!="OpenLayers.Geometry.Point")throw"Couldn't parse "+e.CLASS_NAME;t=this.createElementNS(this.georssns,"georss:point"),t.appendChild(this.buildCoordinatesNode(e))}return t},buildCoordinatesNode:function(e){var t=null;e.components&&(t=e.components);var n;if(t){var r=t.length,i=new Array(r);for(var s=0;s<r;s++)i[s]=t[s].y+" "+t[s].x;n=i.join(" ")}else n=e.y+" "+e.x;return this.createTextNode(n)},CLASS_NAME:"OpenLayers.Format.GeoRSS"});