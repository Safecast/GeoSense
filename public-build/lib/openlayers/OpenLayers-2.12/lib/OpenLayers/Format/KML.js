/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.KML=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{kml:"http://www.opengis.net/kml/2.2",gx:"http://www.google.com/kml/ext/2.2"},kmlns:"http://earth.google.com/kml/2.0",placemarksDesc:"No description available",foldersName:"OpenLayers export",foldersDesc:"Exported on "+new Date,extractAttributes:!0,kvpAttributes:!1,extractStyles:!1,extractTracks:!1,trackAttributes:null,internalns:null,features:null,styles:null,styleBaseUrl:"",fetched:null,maxDepth:0,initialize:function(e){this.regExes={trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g,kmlColor:/(\w{2})(\w{2})(\w{2})(\w{2})/,kmlIconPalette:/root:\/\/icons\/palette-(\d+)(\.\w+)/,straightBracket:/\$\[(.*?)\]/g},this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){this.features=[],this.styles={},this.fetched={};var t={depth:0,styleBaseUrl:this.styleBaseUrl};return this.parseData(e,t)},parseData:function(e,t){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var n=["Link","NetworkLink","Style","StyleMap","Placemark"];for(var r=0,i=n.length;r<i;++r){var s=n[r],o=this.getElementsByTagNameNS(e,"*",s);if(o.length==0)continue;switch(s.toLowerCase()){case"link":case"networklink":this.parseLinks(o,t);break;case"style":this.extractStyles&&this.parseStyles(o,t);break;case"stylemap":this.extractStyles&&this.parseStyleMaps(o,t);break;case"placemark":this.parseFeatures(o,t)}}return this.features},parseLinks:function(e,t){if(t.depth>=this.maxDepth)return!1;var n=OpenLayers.Util.extend({},t);n.depth++;for(var r=0,i=e.length;r<i;r++){var s=this.parseProperty(e[r],"*","href");if(s&&!this.fetched[s]){this.fetched[s]=!0;var o=this.fetchLink(s);o&&this.parseData(o,n)}}},fetchLink:function(e){var t=OpenLayers.Request.GET({url:e,async:!1});if(t)return t.responseText},parseStyles:function(e,t){for(var n=0,r=e.length;n<r;n++){var i=this.parseStyle(e[n]);if(i){var s=(t.styleBaseUrl||"")+"#"+i.id;this.styles[s]=i}}},parseKmlColor:function(e){var t=null;if(e){var n=e.match(this.regExes.kmlColor);n&&(t={color:"#"+n[4]+n[3]+n[2],opacity:parseInt(n[1],16)/255})}return t},parseStyle:function(e){var t={},n=["LineStyle","PolyStyle","IconStyle","BalloonStyle","LabelStyle"],r,i,s,o,u;for(var a=0,f=n.length;a<f;++a){r=n[a],i=this.getElementsByTagNameNS(e,"*",r)[0];if(!i)continue;switch(r.toLowerCase()){case"linestyle":var l=this.parseProperty(i,"*","color"),c=this.parseKmlColor(l);c&&(t.strokeColor=c.color,t.strokeOpacity=c.opacity);var h=this.parseProperty(i,"*","width");h&&(t.strokeWidth=h);break;case"polystyle":var l=this.parseProperty(i,"*","color"),c=this.parseKmlColor(l);c&&(t.fillOpacity=c.opacity,t.fillColor=c.color);var p=this.parseProperty(i,"*","fill");p=="0"&&(t.fillColor="none");var d=this.parseProperty(i,"*","outline");d=="0"&&(t.strokeWidth="0");break;case"iconstyle":var v=parseFloat(this.parseProperty(i,"*","scale")||1),h=32*v,m=32*v,g=this.getElementsByTagNameNS(i,"*","Icon")[0];if(g){var y=this.parseProperty(g,"*","href");if(y){var b=this.parseProperty(g,"*","w"),w=this.parseProperty(g,"*","h"),E="http://maps.google.com/mapfiles/kml";OpenLayers.String.startsWith(y,E)&&!b&&!w&&(b=64,w=64,v/=2),b=b||w,w=w||b,b&&(h=parseInt(b)*v),w&&(m=parseInt(w)*v);var S=y.match(this.regExes.kmlIconPalette);if(S){var x=S[1],T=S[2],N=this.parseProperty(g,"*","x"),C=this.parseProperty(g,"*","y"),k=N?N/32:0,L=C?7-C/32:7,A=L*8+k;y="http://maps.google.com/mapfiles/kml/pal"+x+"/icon"+A+T}t.graphicOpacity=1,t.externalGraphic=y}}var O=this.getElementsByTagNameNS(i,"*","hotSpot")[0];if(O){var N=parseFloat(O.getAttribute("x")),C=parseFloat(O.getAttribute("y")),M=O.getAttribute("xunits");M=="pixels"?t.graphicXOffset=-N*v:M=="insetPixels"?t.graphicXOffset=-h+N*v:M=="fraction"&&(t.graphicXOffset=-h*N);var _=O.getAttribute("yunits");_=="pixels"?t.graphicYOffset=-m+C*v+1:_=="insetPixels"?t.graphicYOffset=-(C*v)+1:_=="fraction"&&(t.graphicYOffset=-m*(1-C)+1)}t.graphicWidth=h,t.graphicHeight=m;break;case"balloonstyle":var D=OpenLayers.Util.getXmlNodeValue(i);D&&(t.balloonStyle=D.replace(this.regExes.straightBracket,"${$1}"));break;case"labelstyle":var l=this.parseProperty(i,"*","color"),c=this.parseKmlColor(l);c&&(t.fontColor=c.color,t.fontOpacity=c.opacity);break;default:}}!t.strokeColor&&t.fillColor&&(t.strokeColor=t.fillColor);var P=e.getAttribute("id");return P&&t&&(t.id=P),t},parseStyleMaps:function(e,t){for(var n=0,r=e.length;n<r;n++){var i=e[n],s=this.getElementsByTagNameNS(i,"*","Pair"),o=i.getAttribute("id");for(var u=0,a=s.length;u<a;u++){var f=s[u],l=this.parseProperty(f,"*","key"),c=this.parseProperty(f,"*","styleUrl");c&&l=="normal"&&(this.styles[(t.styleBaseUrl||"")+"#"+o]=this.styles[(t.styleBaseUrl||"")+c])}}},parseFeatures:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++){var s=e[r],o=this.parseFeature.apply(this,[s]);if(!o)throw"Bad Placemark: "+r;this.extractStyles&&o.attributes&&o.attributes.styleUrl&&(o.style=this.getStyle(o.attributes.styleUrl,t));if(this.extractStyles){var u=this.getElementsByTagNameNS(s,"*","Style")[0];if(u){var a=this.parseStyle(u);a&&(o.style=OpenLayers.Util.extend(o.style,a))}}if(this.extractTracks){var f=this.getElementsByTagNameNS(s,this.namespaces.gx,"Track");if(f&&f.length>0){var l=f[0],c={features:[],feature:o};this.readNode(l,c),c.features.length>0&&n.push.apply(n,c.features)}}else n.push(o)}this.features=this.features.concat(n)},readers:{kml:{when:function(e,t){t.whens.push(OpenLayers.Date.parse(this.getChildValue(e)))},_trackPointAttribute:function(e,t){var n=e.nodeName.split(":").pop();t.attributes[n].push(this.getChildValue(e))}},gx:{Track:function(e,t){var n={whens:[],points:[],angles:[]};if(this.trackAttributes){var r;n.attributes={};for(var i=0,s=this.trackAttributes.length;i<s;++i)r=this.trackAttributes[i],n.attributes[r]=[],r in this.readers.kml||(this.readers.kml[r]=this.readers.kml._trackPointAttribute)}this.readChildNodes(e,n);if(n.whens.length!==n.points.length)throw new Error("gx:Track with unequal number of when ("+n.whens.length+") and gx:coord ("+n.points.length+") elements.");var o=n.angles.length>0;if(o&&n.whens.length!==n.angles.length)throw new Error("gx:Track with unequal number of when ("+n.whens.length+") and gx:angles ("+n.angles.length+") elements.");var u,a,f;for(var i=0,s=n.whens.length;i<s;++i){u=t.feature.clone(),u.fid=t.feature.fid||t.feature.id,a=n.points[i],u.geometry=a,"z"in a&&(u.attributes.altitude=a.z),this.internalProjection&&this.externalProjection&&u.geometry.transform(this.externalProjection,this.internalProjection);if(this.trackAttributes)for(var l=0,c=this.trackAttributes.length;l<c;++l)u.attributes[r]=n.attributes[this.trackAttributes[l]][i];u.attributes.when=n.whens[i],u.attributes.trackId=t.feature.id,o&&(f=n.angles[i],u.attributes.heading=parseFloat(f[0]),u.attributes.tilt=parseFloat(f[1]),u.attributes.roll=parseFloat(f[2])),t.features.push(u)}},coord:function(e,t){var n=this.getChildValue(e),r=n.replace(this.regExes.trimSpace,"").split(/\s+/),i=new OpenLayers.Geometry.Point(r[0],r[1]);r.length>2&&(i.z=parseFloat(r[2])),t.points.push(i)},angles:function(e,t){var n=this.getChildValue(e),r=n.replace(this.regExes.trimSpace,"").split(/\s+/);t.angles.push(r)}}},parseFeature:function(e){var t=["MultiGeometry","Polygon","LineString","Point"],n,r,i,s;for(var o=0,u=t.length;o<u;++o){n=t[o],this.internalns=e.namespaceURI?e.namespaceURI:this.kmlns,r=this.getElementsByTagNameNS(e,this.internalns,n);if(r.length>0){var s=this.parseGeometry[n.toLowerCase()];if(!s)throw new TypeError("Unsupported geometry type: "+n);i=s.apply(this,[r[0]]),this.internalProjection&&this.externalProjection&&i.transform(this.externalProjection,this.internalProjection);break}}var a;this.extractAttributes&&(a=this.parseAttributes(e));var f=new OpenLayers.Feature.Vector(i,a),l=e.getAttribute("id")||e.getAttribute("name");return l!=null&&(f.fid=l),f},getStyle:function(e,t){var n=OpenLayers.Util.removeTail(e),r=OpenLayers.Util.extend({},t);r.depth++,r.styleBaseUrl=n;if(!this.styles[e]&&!OpenLayers.String.startsWith(e,"#")&&r.depth<=this.maxDepth&&!this.fetched[n]){var i=this.fetchLink(n);i&&this.parseData(i,r)}var s=OpenLayers.Util.extend({},this.styles[e]);return s},parseGeometry:{point:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),n=[];if(t.length>0){var r=t[0].firstChild.nodeValue;r=r.replace(this.regExes.removeSpace,""),n=r.split(",")}var i=null;if(n.length>1)return n.length==2&&(n[2]=null),i=new OpenLayers.Geometry.Point(n[0],n[1],n[2]),i;throw"Bad coordinate string: "+r},linestring:function(e,t){var n=this.getElementsByTagNameNS(e,this.internalns,"coordinates"),r=null;if(n.length>0){var i=this.getChildValue(n[0]);i=i.replace(this.regExes.trimSpace,""),i=i.replace(this.regExes.trimComma,",");var s=i.split(this.regExes.splitSpace),o=s.length,u=new Array(o),a,f;for(var l=0;l<o;++l){a=s[l].split(","),f=a.length;if(!(f>1))throw"Bad LineString point coordinates: "+s[l];a.length==2&&(a[2]=null),u[l]=new OpenLayers.Geometry.Point(a[0],a[1],a[2])}if(!o)throw"Bad LineString coordinates: "+i;t?r=new OpenLayers.Geometry.LinearRing(u):r=new OpenLayers.Geometry.LineString(u)}return r},polygon:function(e){var t=this.getElementsByTagNameNS(e,this.internalns,"LinearRing"),n=t.length,r=new Array(n);if(n>0){var i;for(var s=0,o=t.length;s<o;++s){i=this.parseGeometry.linestring.apply(this,[t[s],!0]);if(!i)throw"Bad LinearRing geometry: "+s;r[s]=i}}return new OpenLayers.Geometry.Polygon(r)},multigeometry:function(e){var t,n,r=[],i=e.childNodes;for(var s=0,o=i.length;s<o;++s){t=i[s];if(t.nodeType==1){var u=t.prefix?t.nodeName.split(":")[1]:t.nodeName,n=this.parseGeometry[u.toLowerCase()];n&&r.push(n.apply(this,[t]))}}return new OpenLayers.Geometry.Collection(r)}},parseAttributes:function(e){var t={},n=e.getElementsByTagName("ExtendedData");n.length&&(t=this.parseExtendedData(n[0]));var r,i,s,o=e.childNodes;for(var u=0,a=o.length;u<a;++u){r=o[u];if(r.nodeType==1){i=r.childNodes;if(i.length>=1&&i.length<=3){var s;switch(i.length){case 1:s=i[0];break;case 2:var f=i[0],l=i[1];s=f.nodeType==3||f.nodeType==4?f:l;break;case 3:default:s=i[1]}if(s.nodeType==3||s.nodeType==4){var c=r.prefix?r.nodeName.split(":")[1]:r.nodeName,h=OpenLayers.Util.getXmlNodeValue(s);h&&(h=h.replace(this.regExes.trimSpace,""),t[c]=h)}}}}return t},parseExtendedData:function(e){var t={},n,r,i,s,o=e.getElementsByTagName("Data");for(n=0,r=o.length;n<r;n++){i=o[n],s=i.getAttribute("name");var u={},a=i.getElementsByTagName("value");a.length&&(u.value=this.getChildValue(a[0]));if(this.kvpAttributes)t[s]=u.value;else{var f=i.getElementsByTagName("displayName");f.length&&(u.displayName=this.getChildValue(f[0])),t[s]=u}}var l=e.getElementsByTagName("SimpleData");for(n=0,r=l.length;n<r;n++){var u={};i=l[n],s=i.getAttribute("name"),u.value=this.getChildValue(i),this.kvpAttributes?t[s]=u.value:(u.displayName=s,t[s]=u)}return t},parseProperty:function(e,t,n){var r,i=this.getElementsByTagNameNS(e,t,n);try{r=OpenLayers.Util.getXmlNodeValue(i[0])}catch(s){r=null}return r},write:function(e){OpenLayers.Util.isArray(e)||(e=[e]);var t=this.createElementNS(this.kmlns,"kml"),n=this.createFolderXML();for(var r=0,i=e.length;r<i;++r)n.appendChild(this.createPlacemarkXML(e[r]));return t.appendChild(n),OpenLayers.Format.XML.prototype.write.apply(this,[t])},createFolderXML:function(){var e=this.createElementNS(this.kmlns,"Folder");if(this.foldersName){var t=this.createElementNS(this.kmlns,"name"),n=this.createTextNode(this.foldersName);t.appendChild(n),e.appendChild(t)}if(this.foldersDesc){var r=this.createElementNS(this.kmlns,"description"),i=this.createTextNode(this.foldersDesc);r.appendChild(i),e.appendChild(r)}return e},createPlacemarkXML:function(e){var t=this.createElementNS(this.kmlns,"name"),n=e.style&&e.style.label?e.style.label:e.attributes.name||e.id;t.appendChild(this.createTextNode(n));var r=this.createElementNS(this.kmlns,"description"),i=e.attributes.description||this.placemarksDesc;r.appendChild(this.createTextNode(i));var s=this.createElementNS(this.kmlns,"Placemark");e.fid!=null&&s.setAttribute("id",e.fid),s.appendChild(t),s.appendChild(r);var o=this.buildGeometryNode(e.geometry);s.appendChild(o);if(e.attributes){var u=this.buildExtendedData(e.attributes);u&&s.appendChild(u)}return s},buildGeometryNode:function(e){var t=e.CLASS_NAME,n=t.substring(t.lastIndexOf(".")+1),r=this.buildGeometry[n.toLowerCase()],i=null;return r&&(i=r.apply(this,[e])),i},buildGeometry:{point:function(e){var t=this.createElementNS(this.kmlns,"Point");return t.appendChild(this.buildCoordinatesNode(e)),t},multipoint:function(e){return this.buildGeometry.collection.apply(this,[e])},linestring:function(e){var t=this.createElementNS(this.kmlns,"LineString");return t.appendChild(this.buildCoordinatesNode(e)),t},multilinestring:function(e){return this.buildGeometry.collection.apply(this,[e])},linearring:function(e){var t=this.createElementNS(this.kmlns,"LinearRing");return t.appendChild(this.buildCoordinatesNode(e)),t},polygon:function(e){var t=this.createElementNS(this.kmlns,"Polygon"),n=e.components,r,i,s;for(var o=0,u=n.length;o<u;++o)s=o==0?"outerBoundaryIs":"innerBoundaryIs",r=this.createElementNS(this.kmlns,s),i=this.buildGeometry.linearring.apply(this,[n[o]]),r.appendChild(i),t.appendChild(r);return t},multipolygon:function(e){return this.buildGeometry.collection.apply(this,[e])},collection:function(e){var t=this.createElementNS(this.kmlns,"MultiGeometry"),n;for(var r=0,i=e.components.length;r<i;++r)n=this.buildGeometryNode.apply(this,[e.components[r]]),n&&t.appendChild(n);return t}},buildCoordinatesNode:function(e){var t=this.createElementNS(this.kmlns,"coordinates"),n,r=e.components;if(r){var i,s=r.length,o=new Array(s);for(var u=0;u<s;++u)i=r[u],o[u]=this.buildCoordinates(i);n=o.join(" ")}else n=this.buildCoordinates(e);var a=this.createTextNode(n);return t.appendChild(a),t},buildCoordinates:function(e){return this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection)),e.x+","+e.y},buildExtendedData:function(e){var t=this.createElementNS(this.kmlns,"ExtendedData");for(var n in e)if(e[n]&&n!="name"&&n!="description"&&n!="styleUrl"){var r=this.createElementNS(this.kmlns,"Data");r.setAttribute("name",n);var i=this.createElementNS(this.kmlns,"value");if(typeof e[n]=="object"){e[n].value&&i.appendChild(this.createTextNode(e[n].value));if(e[n].displayName){var s=this.createElementNS(this.kmlns,"displayName");s.appendChild(this.getXMLDoc().createCDATASection(e[n].displayName)),r.appendChild(s)}}else i.appendChild(this.createTextNode(e[n]));r.appendChild(i),t.appendChild(r)}return this.isSimpleContent(t)?null:t},CLASS_NAME:"OpenLayers.Format.KML"});