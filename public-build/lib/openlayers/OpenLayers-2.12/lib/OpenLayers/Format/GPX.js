/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.GPX=OpenLayers.Class(OpenLayers.Format.XML,{defaultDesc:"No description available",extractWaypoints:!0,extractTracks:!0,extractRoutes:!0,extractAttributes:!0,namespaces:{gpx:"http://www.topografix.com/GPX/1/1",xsi:"http://www.w3.org/2001/XMLSchema-instance"},schemaLocation:"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",creator:"OpenLayers",initialize:function(e){this.externalProjection=new OpenLayers.Projection("EPSG:4326"),OpenLayers.Format.XML.prototype.initialize.apply(this,[e])},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var t=[];if(this.extractTracks){var n=e.getElementsByTagName("trk");for(var r=0,i=n.length;r<i;r++){var s={};this.extractAttributes&&(s=this.parseAttributes(n[r]));var o=this.getElementsByTagNameNS(n[r],n[r].namespaceURI,"trkseg");for(var u=0,a=o.length;u<a;u++){var f=this.extractSegment(o[u],"trkpt");t.push(new OpenLayers.Feature.Vector(f,s))}}}if(this.extractRoutes){var l=e.getElementsByTagName("rte");for(var c=0,h=l.length;c<h;c++){var s={};this.extractAttributes&&(s=this.parseAttributes(l[c]));var p=this.extractSegment(l[c],"rtept");t.push(new OpenLayers.Feature.Vector(p,s))}}if(this.extractWaypoints){var d=e.getElementsByTagName("wpt");for(var v=0,i=d.length;v<i;v++){var s={};this.extractAttributes&&(s=this.parseAttributes(d[v]));var m=new OpenLayers.Geometry.Point(d[v].getAttribute("lon"),d[v].getAttribute("lat"));t.push(new OpenLayers.Feature.Vector(m,s))}}if(this.internalProjection&&this.externalProjection)for(var g=0,y=t.length;g<y;g++)t[g].geometry.transform(this.externalProjection,this.internalProjection);return t},extractSegment:function(e,t){var n=this.getElementsByTagNameNS(e,e.namespaceURI,t),r=[];for(var i=0,s=n.length;i<s;i++)r.push(new OpenLayers.Geometry.Point(n[i].getAttribute("lon"),n[i].getAttribute("lat")));return new OpenLayers.Geometry.LineString(r)},parseAttributes:function(e){var t={},n=e.firstChild,r,i;while(n){if(n.nodeType==1&&n.firstChild){r=n.firstChild;if(r.nodeType==3||r.nodeType==4)i=n.prefix?n.nodeName.split(":")[1]:n.nodeName,i!="trkseg"&&i!="rtept"&&(t[i]=r.nodeValue)}n=n.nextSibling}return t},write:function(e,t){e=OpenLayers.Util.isArray(e)?e:[e];var n=this.createElementNS(this.namespaces.gpx,"gpx");n.setAttribute("version","1.1"),n.setAttribute("creator",this.creator),this.setAttributes(n,{"xsi:schemaLocation":this.schemaLocation}),t&&typeof t=="object"&&n.appendChild(this.buildMetadataNode(t));for(var r=0,i=e.length;r<i;r++)n.appendChild(this.buildFeatureNode(e[r]));return OpenLayers.Format.XML.prototype.write.apply(this,[n])},buildMetadataNode:function(e){var t=["name","desc","author"],n=this.createElementNSPlus("gpx:metadata");for(var r=0;r<t.length;r++){var i=t[r];if(e[i]){var s=this.createElementNSPlus("gpx:"+i);s.appendChild(this.createTextNode(e[i])),n.appendChild(s)}}return n},buildFeatureNode:function(e){var t=e.geometry;t=t.clone(),this.internalProjection&&this.externalProjection&&t.transform(this.internalProjection,this.externalProjection);if(t.CLASS_NAME=="OpenLayers.Geometry.Point"){var n=this.buildWptNode(t);return this.appendAttributesNode(n,e),n}var r=this.createElementNSPlus("gpx:trk");this.appendAttributesNode(r,e);var i=this.buildTrkSegNode(t);i=OpenLayers.Util.isArray(i)?i:[i];for(var s=0,o=i.length;s<o;s++)r.appendChild(i[s]);return r},buildTrkSegNode:function(e){var t,n,r,i,s;if(e.CLASS_NAME=="OpenLayers.Geometry.LineString"||e.CLASS_NAME=="OpenLayers.Geometry.LinearRing"){t=this.createElementNSPlus("gpx:trkseg");for(n=0,r=e.components.length;n<r;n++)i=e.components[n],t.appendChild(this.buildTrkPtNode(i));return t}s=[];for(n=0,r=e.components.length;n<r;n++)s.push(this.buildTrkSegNode(e.components[n]));return s},buildTrkPtNode:function(e){var t=this.createElementNSPlus("gpx:trkpt");return t.setAttribute("lon",e.x),t.setAttribute("lat",e.y),t},buildWptNode:function(e){var t=this.createElementNSPlus("gpx:wpt");return t.setAttribute("lon",e.x),t.setAttribute("lat",e.y),t},appendAttributesNode:function(e,t){var n=this.createElementNSPlus("gpx:name");n.appendChild(this.createTextNode(t.attributes.name||t.id)),e.appendChild(n);var r=this.createElementNSPlus("gpx:desc");r.appendChild(this.createTextNode(t.attributes.description||this.defaultDesc)),e.appendChild(r)},CLASS_NAME:"OpenLayers.Format.GPX"});