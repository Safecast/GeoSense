/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Format.WKT=OpenLayers.Class(OpenLayers.Format,{initialize:function(e){this.regExes={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},OpenLayers.Format.prototype.initialize.apply(this,[e])},read:function(e){var t,n,r;e=e.replace(/[\n\r]/g," ");var i=this.regExes.typeStr.exec(e);if(i){n=i[1].toLowerCase(),r=i[2],this.parse[n]&&(t=this.parse[n].apply(this,[r]));if(this.internalProjection&&this.externalProjection)if(t&&t.CLASS_NAME=="OpenLayers.Feature.Vector")t.geometry.transform(this.externalProjection,this.internalProjection);else if(t&&n!="geometrycollection"&&typeof t=="object")for(var s=0,o=t.length;s<o;s++){var u=t[s];u.geometry.transform(this.externalProjection,this.internalProjection)}}return t},write:function(e){var t,n,r,i,s;e.constructor==Array?(t=e,s=!0):(t=[e],s=!1);var o=[];s&&o.push("GEOMETRYCOLLECTION(");for(var u=0,a=t.length;u<a;++u)s&&u>0&&o.push(","),n=t[u].geometry,o.push(this.extractGeometry(n));return s&&o.push(")"),o.join("")},extractGeometry:function(e){var t=e.CLASS_NAME.split(".")[2].toLowerCase();if(!this.extract[t])return null;this.internalProjection&&this.externalProjection&&(e=e.clone(),e.transform(this.internalProjection,this.externalProjection));var n=t=="collection"?"GEOMETRYCOLLECTION":t.toUpperCase(),r=n+"("+this.extract[t].apply(this,[e])+")";return r},extract:{point:function(e){return e.x+" "+e.y},multipoint:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push("("+this.extract.point.apply(this,[e.components[n]])+")");return t.join(",")},linestring:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push(this.extract.point.apply(this,[e.components[n]]));return t.join(",")},multilinestring:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push("("+this.extract.linestring.apply(this,[e.components[n]])+")");return t.join(",")},polygon:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push("("+this.extract.linestring.apply(this,[e.components[n]])+")");return t.join(",")},multipolygon:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push("("+this.extract.polygon.apply(this,[e.components[n]])+")");return t.join(",")},collection:function(e){var t=[];for(var n=0,r=e.components.length;n<r;++n)t.push(this.extractGeometry.apply(this,[e.components[n]]));return t.join(",")}},parse:{point:function(e){var t=OpenLayers.String.trim(e).split(this.regExes.spaces);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(t[0],t[1]))},multipoint:function(e){var t,n=OpenLayers.String.trim(e).split(","),r=[];for(var i=0,s=n.length;i<s;++i)t=n[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.point.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPoint(r))},linestring:function(e){var t=OpenLayers.String.trim(e).split(","),n=[];for(var r=0,i=t.length;r<i;++r)n.push(this.parse.point.apply(this,[t[r]]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(n))},multilinestring:function(e){var t,n=OpenLayers.String.trim(e).split(this.regExes.parenComma),r=[];for(var i=0,s=n.length;i<s;++i)t=n[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.linestring.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(r))},polygon:function(e){var t,n,r,i=OpenLayers.String.trim(e).split(this.regExes.parenComma),s=[];for(var o=0,u=i.length;o<u;++o)t=i[o].replace(this.regExes.trimParens,"$1"),n=this.parse.linestring.apply(this,[t]).geometry,r=new OpenLayers.Geometry.LinearRing(n.components),s.push(r);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(s))},multipolygon:function(e){var t,n=OpenLayers.String.trim(e).split(this.regExes.doubleParenComma),r=[];for(var i=0,s=n.length;i<s;++i)t=n[i].replace(this.regExes.trimParens,"$1"),r.push(this.parse.polygon.apply(this,[t]).geometry);return new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(r))},geometrycollection:function(e){e=e.replace(/,\s*([A-Za-z])/g,"|$1");var t=OpenLayers.String.trim(e).split("|"),n=[];for(var r=0,i=t.length;r<i;++r)n.push(OpenLayers.Format.WKT.prototype.read.apply(this,[t[r]]));return n}},CLASS_NAME:"OpenLayers.Format.WKT"});