/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.OverviewMap=OpenLayers.Class(OpenLayers.Control,{element:null,ovmap:null,size:{w:180,h:90},layers:null,minRectSize:15,minRectDisplayClass:"RectReplacement",minRatio:8,maxRatio:32,mapOptions:null,autoPan:!1,handlers:null,resolutionFactor:1,maximized:!1,initialize:function(e){this.layers=[],this.handlers={},OpenLayers.Control.prototype.initialize.apply(this,[e])},destroy:function(){if(!this.mapDiv)return;this.handlers.click&&this.handlers.click.destroy(),this.handlers.drag&&this.handlers.drag.destroy(),this.ovmap&&this.ovmap.viewPortDiv.removeChild(this.extentRectangle),this.extentRectangle=null,this.rectEvents&&(this.rectEvents.destroy(),this.rectEvents=null),this.ovmap&&(this.ovmap.destroy(),this.ovmap=null),this.element.removeChild(this.mapDiv),this.mapDiv=null,this.div.removeChild(this.element),this.element=null,this.maximizeDiv&&(this.div.removeChild(this.maximizeDiv),this.maximizeDiv=null),this.minimizeDiv&&(this.div.removeChild(this.minimizeDiv),this.minimizeDiv=null),this.map.events.un({buttonclick:this.onButtonClick,moveend:this.update,changebaselayer:this.baseLayerDraw,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(this.layers.length===0){if(!this.map.baseLayer)return this.map.events.register("changebaselayer",this,this.baseLayerDraw),this.div;var e=this.map.baseLayer.clone();this.layers=[e]}this.element=document.createElement("div"),this.element.className=this.displayClass+"Element",this.element.style.display="none",this.mapDiv=document.createElement("div"),this.mapDiv.style.width=this.size.w+"px",this.mapDiv.style.height=this.size.h+"px",this.mapDiv.style.position="relative",this.mapDiv.style.overflow="hidden",this.mapDiv.id=OpenLayers.Util.createUniqueID("overviewMap"),this.extentRectangle=document.createElement("div"),this.extentRectangle.style.position="absolute",this.extentRectangle.style.zIndex=1e3,this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.element.appendChild(this.mapDiv),this.div.appendChild(this.element);if(!this.outsideViewport){this.div.className+=" "+this.displayClass+"Container";var t=OpenLayers.Util.getImageLocation("layer-switcher-maximize.png");this.maximizeDiv=OpenLayers.Util.createAlphaImageDiv(this.displayClass+"MaximizeButton",null,null,t,"absolute"),this.maximizeDiv.style.display="none",this.maximizeDiv.className=this.displayClass+"MaximizeButton olButton",this.div.appendChild(this.maximizeDiv);var t=OpenLayers.Util.getImageLocation("layer-switcher-minimize.png");this.minimizeDiv=OpenLayers.Util.createAlphaImageDiv("OpenLayers_Control_minimizeDiv",null,null,t,"absolute"),this.minimizeDiv.style.display="none",this.minimizeDiv.className=this.displayClass+"MinimizeButton olButton",this.div.appendChild(this.minimizeDiv),this.minimizeControl()}else this.element.style.display="";return this.map.getExtent()&&this.update(),this.map.events.on({buttonclick:this.onButtonClick,moveend:this.update,scope:this}),this.maximized&&this.maximizeControl(),this.div},baseLayerDraw:function(){this.draw(),this.map.events.unregister("changebaselayer",this,this.baseLayerDraw)},rectDrag:function(e){var t=this.handlers.drag.last.x-e.x,n=this.handlers.drag.last.y-e.y;if(t!=0||n!=0){var r=this.rectPxBounds.top,i=this.rectPxBounds.left,s=Math.abs(this.rectPxBounds.getHeight()),o=this.rectPxBounds.getWidth(),u=Math.max(0,r-n);u=Math.min(u,this.ovmap.size.h-this.hComp-s);var a=Math.max(0,i-t);a=Math.min(a,this.ovmap.size.w-this.wComp-o),this.setRectPxBounds(new OpenLayers.Bounds(a,u+s,a+o,u))}},mapDivClick:function(e){var t=this.rectPxBounds.getCenterPixel(),n=e.xy.x-t.x,r=e.xy.y-t.y,i=this.rectPxBounds.top,s=this.rectPxBounds.left,o=Math.abs(this.rectPxBounds.getHeight()),u=this.rectPxBounds.getWidth(),a=Math.max(0,i+r);a=Math.min(a,this.ovmap.size.h-o);var f=Math.max(0,s+n);f=Math.min(f,this.ovmap.size.w-u),this.setRectPxBounds(new OpenLayers.Bounds(f,a+o,f+u,a)),this.updateMapToRect()},onButtonClick:function(e){e.buttonElement===this.minimizeDiv?this.minimizeControl():e.buttonElement===this.maximizeDiv&&this.maximizeControl()},maximizeControl:function(e){this.element.style.display="",this.showToggle(!1),e!=null&&OpenLayers.Event.stop(e)},minimizeControl:function(e){this.element.style.display="none",this.showToggle(!0),e!=null&&OpenLayers.Event.stop(e)},showToggle:function(e){this.maximizeDiv.style.display=e?"":"none",this.minimizeDiv.style.display=e?"none":""},update:function(){this.ovmap==null&&this.createMap(),(this.autoPan||!this.isSuitableOverview())&&this.updateOverview(),this.updateRectToMap()},isSuitableOverview:function(){var e=this.map.getExtent(),t=this.map.maxExtent,n=new OpenLayers.Bounds(Math.max(e.left,t.left),Math.max(e.bottom,t.bottom),Math.min(e.right,t.right),Math.min(e.top,t.top));this.ovmap.getProjection()!=this.map.getProjection()&&(n=n.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()));var r=this.ovmap.getResolution()/this.map.getResolution();return r>this.minRatio&&r<=this.maxRatio&&this.ovmap.getExtent().containsBounds(n)},updateOverview:function(){var e=this.map.getResolution(),t=this.ovmap.getResolution(),n=t/e;n>this.maxRatio?t=this.minRatio*e:n<=this.minRatio&&(t=this.maxRatio*e);var r;this.ovmap.getProjection()!=this.map.getProjection()?(r=this.map.center.clone(),r.transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject())):r=this.map.center,this.ovmap.setCenter(r,this.ovmap.getZoomForResolution(t*this.resolutionFactor)),this.updateRectToMap()},createMap:function(){var e=OpenLayers.Util.extend({controls:[],maxResolution:"auto",fallThrough:!1},this.mapOptions);this.ovmap=new OpenLayers.Map(this.mapDiv,e),this.ovmap.viewPortDiv.appendChild(this.extentRectangle),OpenLayers.Event.stopObserving(window,"unload",this.ovmap.unloadDestroy),this.ovmap.addLayers(this.layers),this.ovmap.zoomToMaxExtent(),this.wComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-left-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-right-width")),this.wComp=this.wComp?this.wComp:2,this.hComp=parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-top-width"))+parseInt(OpenLayers.Element.getStyle(this.extentRectangle,"border-bottom-width")),this.hComp=this.hComp?this.hComp:2,this.handlers.drag=new OpenLayers.Handler.Drag(this,{move:this.rectDrag,done:this.updateMapToRect},{map:this.ovmap}),this.handlers.click=new OpenLayers.Handler.Click(this,{click:this.mapDivClick},{single:!0,"double":!1,stopSingle:!0,stopDouble:!0,pixelTolerance:1,map:this.ovmap}),this.handlers.click.activate(),this.rectEvents=new OpenLayers.Events(this,this.extentRectangle,null,!0),this.rectEvents.register("mouseover",this,function(e){!this.handlers.drag.active&&!this.map.dragging&&this.handlers.drag.activate()}),this.rectEvents.register("mouseout",this,function(e){this.handlers.drag.dragging||this.handlers.drag.deactivate()});if(this.ovmap.getProjection()!=this.map.getProjection()){var t=this.map.getProjectionObject().getUnits()||this.map.units||this.map.baseLayer.units,n=this.ovmap.getProjectionObject().getUnits()||this.ovmap.units||this.ovmap.baseLayer.units;this.resolutionFactor=t&&n?OpenLayers.INCHES_PER_UNIT[t]/OpenLayers.INCHES_PER_UNIT[n]:1}},updateRectToMap:function(){var e;this.ovmap.getProjection()!=this.map.getProjection()?e=this.map.getExtent().transform(this.map.getProjectionObject(),this.ovmap.getProjectionObject()):e=this.map.getExtent();var t=this.getRectBoundsFromMapBounds(e);t&&this.setRectPxBounds(t)},updateMapToRect:function(){var e=this.getMapBoundsFromRectBounds(this.rectPxBounds);this.ovmap.getProjection()!=this.map.getProjection()&&(e=e.transform(this.ovmap.getProjectionObject(),this.map.getProjectionObject())),this.map.panTo(e.getCenterLonLat())},setRectPxBounds:function(e){var t=Math.max(e.top,0),n=Math.max(e.left,0),r=Math.min(e.top+Math.abs(e.getHeight()),this.ovmap.size.h-this.hComp),i=Math.min(e.left+e.getWidth(),this.ovmap.size.w-this.wComp),s=Math.max(i-n,0),o=Math.max(r-t,0);if(s<this.minRectSize||o<this.minRectSize){this.extentRectangle.className=this.displayClass+this.minRectDisplayClass;var u=n+s/2-this.minRectSize/2,a=t+o/2-this.minRectSize/2;this.extentRectangle.style.top=Math.round(a)+"px",this.extentRectangle.style.left=Math.round(u)+"px",this.extentRectangle.style.height=this.minRectSize+"px",this.extentRectangle.style.width=this.minRectSize+"px"}else this.extentRectangle.className=this.displayClass+"ExtentRectangle",this.extentRectangle.style.top=Math.round(t)+"px",this.extentRectangle.style.left=Math.round(n)+"px",this.extentRectangle.style.height=Math.round(o)+"px",this.extentRectangle.style.width=Math.round(s)+"px";this.rectPxBounds=new OpenLayers.Bounds(Math.round(n),Math.round(r),Math.round(i),Math.round(t))},getRectBoundsFromMapBounds:function(e){var t=this.getOverviewPxFromLonLat({lon:e.left,lat:e.bottom}),n=this.getOverviewPxFromLonLat({lon:e.right,lat:e.top}),r=null;return t&&n&&(r=new OpenLayers.Bounds(t.x,t.y,n.x,n.y)),r},getMapBoundsFromRectBounds:function(e){var t=this.getLonLatFromOverviewPx({x:e.left,y:e.bottom}),n=this.getLonLatFromOverviewPx({x:e.right,y:e.top});return new OpenLayers.Bounds(t.lon,t.lat,n.lon,n.lat)},getLonLatFromOverviewPx:function(e){var t=this.ovmap.size,n=this.ovmap.getResolution(),r=this.ovmap.getExtent().getCenterLonLat(),i=e.x-t.w/2,s=e.y-t.h/2;return{lon:r.lon+i*n,lat:r.lat-s*n}},getOverviewPxFromLonLat:function(e){var t=this.ovmap.getResolution(),n=this.ovmap.getExtent();if(n)return{x:Math.round(1/t*(e.lon-n.left)),y:Math.round(1/t*(n.top-e.lat))}},CLASS_NAME:"OpenLayers.Control.OverviewMap"});