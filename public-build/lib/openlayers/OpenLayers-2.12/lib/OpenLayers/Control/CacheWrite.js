/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.CacheWrite=OpenLayers.Class(OpenLayers.Control,{layers:null,imageFormat:"image/png",quotaRegEx:/quota/i,setMap:function(e){OpenLayers.Control.prototype.setMap.apply(this,arguments);var t,n=this.layers||e.layers;for(t=n.length-1;t>=0;--t)this.addLayer({layer:n[t]});this.layers||e.events.on({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this})},addLayer:function(e){e.layer.events.on({tileloadstart:this.makeSameOrigin,tileloaded:this.cache,scope:this})},removeLayer:function(e){e.layer.events.un({tileloadstart:this.makeSameOrigin,tileloaded:this.cache,scope:this})},makeSameOrigin:function(e){if(this.active){var t=e.tile;if(t instanceof OpenLayers.Tile.Image&&!t.crossOriginKeyword&&t.url.substr(0,5)!=="data:"){var n=OpenLayers.Request.makeSameOrigin(t.url,OpenLayers.ProxyHost);OpenLayers.Control.CacheWrite.urlMap[n]=t.url,t.url=n}}},cache:function(e){if(this.active&&window.localStorage){var t=e.tile;if(t instanceof OpenLayers.Tile.Image&&t.url.substr(0,5)!=="data:")try{var n=t.getCanvasContext();if(n){var r=OpenLayers.Control.CacheWrite.urlMap,i=r[t.url]||t.url;window.localStorage.setItem("olCache_"+i,n.canvas.toDataURL(this.imageFormat)),delete r[t.url]}}catch(s){var o=s.name||s.message;o&&this.quotaRegEx.test(o)?this.events.triggerEvent("cachefull",{tile:t}):OpenLayers.Console.error(s.toString())}}},destroy:function(){if(this.layers||this.map){var e,t=this.layers||this.map.layers;for(e=t.length-1;e>=0;--e)this.removeLayer({layer:t[e]})}this.map&&this.map.events.un({addlayer:this.addLayer,removeLayer:this.removeLayer,scope:this}),OpenLayers.Control.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.CacheWrite"}),OpenLayers.Control.CacheWrite.clearCache=function(){if(!window.localStorage)return;var e,t;for(e=window.localStorage.length-1;e>=0;--e)t=window.localStorage.key(e),t.substr(0,8)==="olCache_"&&window.localStorage.removeItem(t)},OpenLayers.Control.CacheWrite.urlMap={};