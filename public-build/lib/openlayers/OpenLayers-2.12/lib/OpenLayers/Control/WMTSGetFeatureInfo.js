/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.WMTSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,requestEncoding:"KVP",drillDown:!1,maxFeatures:10,clickCallback:"click",layers:null,queryVisible:!0,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handlerOptions:null,handler:null,hoverRequest:null,pending:0,initialize:function(e){e=e||{},e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),this.drillDown===!0&&(this.hover=!1);if(this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.request(e.xy,{})},getInfoForHover:function(e){this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(--this.pending,this.pending<=0&&(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0),this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){var e=this.layers||this.map.layers,t=[],n;for(var r=e.length-1;r>=0;--r){n=e[r];if(n instanceof OpenLayers.Layer.WMTS&&n.requestEncoding===this.requestEncoding&&(!this.queryVisible||n.getVisibility())){t.push(n);if(!this.drillDown||this.hover)break}}return t},buildRequestOptions:function(e,t){var n=this.map.getLonLatFromPixel(t),r=e.getURL(new OpenLayers.Bounds(n.lon,n.lat,n.lon,n.lat)),i=OpenLayers.Util.getParameters(r),s=e.getTileInfo(n);return OpenLayers.Util.extend(i,{service:"WMTS",version:e.version,request:"GetFeatureInfo",infoFormat:this.infoFormat,i:s.i,j:s.j}),OpenLayers.Util.applyDefaults(i,this.vendorParams),{url:OpenLayers.Util.isArray(e.url)?e.url[0]:e.url,params:OpenLayers.Util.upperCaseObject(i),callback:function(n){this.handleResponse(t,n,e)},scope:this}},request:function(e,t){t=t||{};var n=this.findLayers();if(n.length>0){var r,i;for(var s=0,o=n.length;s<o;s++){i=n[s],r=this.events.triggerEvent("beforegetfeatureinfo",{xy:e,layer:i});if(r!==!1){++this.pending;var u=this.buildRequestOptions(i,e),a=OpenLayers.Request.GET(u);t.hover===!0&&(this.hoverRequest=a)}}this.pending>0&&OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait")}},handleResponse:function(e,t,n){--this.pending,this.pending<=0&&(OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait"),this.pending=0);if(t.status&&(t.status<200||t.status>=300))this.events.triggerEvent("exception",{xy:e,request:t,layer:n});else{var r=t.responseXML;if(!r||!r.documentElement)r=t.responseText;var i,s;try{i=this.format.read(r)}catch(o){s=!0,this.events.triggerEvent("exception",{xy:e,request:t,error:o,layer:n})}s||this.events.triggerEvent("getfeatureinfo",{text:t.responseText,features:i,request:t,xy:e,layer:n})}},CLASS_NAME:"OpenLayers.Control.WMTSGetFeatureInfo"});