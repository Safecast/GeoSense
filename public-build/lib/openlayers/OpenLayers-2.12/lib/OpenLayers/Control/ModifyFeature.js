/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertices:null,virtualVertices:null,selectControl:null,dragControl:null,handlers:null,deleteCodes:null,virtualStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(e,t){t=t||{},this.layer=e,this.vertices=[],this.virtualVertices=[],this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,t.vertexRenderIntent)),this.virtualStyle.fillOpacity=.3,this.virtualStyle.strokeOpacity=.3,this.deleteCodes=[46,68],this.mode=OpenLayers.Control.ModifyFeature.RESHAPE,OpenLayers.Control.prototype.initialize.apply(this,[t]),OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var n=this,r={geometryTypes:this.geometryTypes,clickout:this.clickout,toggle:this.toggle,onBeforeSelect:this.beforeSelectFeature,onSelect:this.selectFeature,onUnselect:this.unselectFeature,scope:this};this.standalone===!1&&(this.selectControl=new OpenLayers.Control.SelectFeature(e,r));var i={geometryTypes:["OpenLayers.Geometry.Point"],onStart:function(e,t){n.dragStart.apply(n,[e,t])},onDrag:function(e,t){n.dragVertex.apply(n,[e,t])},onComplete:function(e){n.dragComplete.apply(n,[e])},featureCallbacks:{over:function(e){(n.standalone!==!0||e._sketch||n.feature===e)&&n.dragControl.overFeature.apply(n.dragControl,[e])}}};this.dragControl=new OpenLayers.Control.DragFeature(e,i);var s={keydown:this.handleKeypress};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,s)}},destroy:function(){this.layer=null,this.standalone||this.selectControl.destroy(),this.dragControl.destroy(),OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return(this.standalone||this.selectControl.activate())&&this.handlers.keyboard.activate()&&OpenLayers.Control.prototype.activate.apply(this,arguments)},deactivate:function(){var e=!1;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.dragControl.deactivate();var t=this.feature,n=t&&t.geometry&&t.layer;this.standalone===!1?(n&&this.selectControl.unselect.apply(this.selectControl,[t]),this.selectControl.deactivate()):n&&this.unselectFeature(t),this.handlers.keyboard.deactivate(),e=!0}return e},beforeSelectFeature:function(e){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:e})},selectFeature:function(e){if(!this.standalone||this.beforeSelectFeature(e)!==!1)this.feature=e,this.modified=!1,this.resetVertices(),this.dragControl.activate(),this.onModificationStart(this.feature);var t=e.modified;e.geometry&&(!t||!t.geometry)&&(this._originalGeometry=e.geometry.clone())},unselectFeature:function(e){this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[],this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle),this.feature=null,this.dragControl.deactivate(),this.onModificationEnd(e),this.layer.events.triggerEvent("afterfeaturemodified",{feature:e,modified:this.modified}),this.modified=!1},dragStart:function(e,t){if(e!=this.feature&&!e.geometry.parent&&e!=this.dragHandle&&e!=this.radiusHandle){this.standalone===!1&&this.feature&&this.selectControl.clickFeature.apply(this.selectControl,[this.feature]);if(this.geometryTypes==null||OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME)!=-1)this.standalone||this.selectControl.clickFeature.apply(this.selectControl,[e]),this.dragControl.overFeature.apply(this.dragControl,[e]),this.dragControl.lastPixel=t,this.dragControl.handlers.drag.started=!0,this.dragControl.handlers.drag.start=t,this.dragControl.handlers.drag.last=t}},dragVertex:function(e,t){this.modified=!0,this.feature.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"?(this.feature!=e&&(this.feature=e),this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t})):(e._index?(e.geometry.parent.addComponent(e.geometry,e._index),delete e._index,OpenLayers.Util.removeItem(this.virtualVertices,e),this.vertices.push(e)):e==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):e!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t}),this.virtualVertices.length>0&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?undefined:this.selectControl.renderIntent)),this.layer.drawFeature(e)},dragComplete:function(e){this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE){this.feature.state=OpenLayers.State.UPDATE;if(this.modified&&this._originalGeometry){var e=this.feature;e.modified=OpenLayers.Util.extend(e.modified,{geometry:this._originalGeometry}),delete this._originalGeometry}}},resetVertices:function(){this.dragControl.feature&&this.dragControl.outFeature(this.dragControl.feature),this.vertices.length>0&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]),this.virtualVertices.length>0&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null),this.feature&&this.feature.geometry.CLASS_NAME!="OpenLayers.Geometry.Point"&&(this.mode&OpenLayers.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&OpenLayers.Control.ModifyFeature.RESHAPE&&(this.mode&OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(e){var t=e.keyCode;if(this.feature&&OpenLayers.Util.indexOf(this.deleteCodes,t)!=-1){var n=this.dragControl.feature;n&&OpenLayers.Util.indexOf(this.vertices,n)!=-1&&!this.dragControl.handlers.drag.dragging&&n.geometry.parent&&(n.geometry.parent.removeComponent(n.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:n.geometry,feature:this.feature,pixel:e.xy}),this.layer.drawFeature(this.feature,this.standalone?undefined:this.selectControl.renderIntent),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))}},collectVertices:function(){function t(n){var r,i,s,o;if(n.CLASS_NAME=="OpenLayers.Geometry.Point")i=new OpenLayers.Feature.Vector(n),i._sketch=!0,i.renderIntent=e.vertexRenderIntent,e.vertices.push(i);else{var u=n.components.length;n.CLASS_NAME=="OpenLayers.Geometry.LinearRing"&&(u-=1);for(r=0;r<u;++r)s=n.components[r],s.CLASS_NAME=="OpenLayers.Geometry.Point"?(i=new OpenLayers.Feature.Vector(s),i._sketch=!0,i.renderIntent=e.vertexRenderIntent,e.vertices.push(i)):t(s);if(e.createVertices&&n.CLASS_NAME!="OpenLayers.Geometry.MultiPoint")for(r=0,o=n.components.length;r<o-1;++r){var a=n.components[r],f=n.components[r+1];if(a.CLASS_NAME=="OpenLayers.Geometry.Point"&&f.CLASS_NAME=="OpenLayers.Geometry.Point"){var l=(a.x+f.x)/2,c=(a.y+f.y)/2,h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(l,c),null,e.virtualStyle);h.geometry.parent=n,h._index=r+1,h._sketch=!0,e.virtualVertices.push(h)}}}}this.vertices=[],this.virtualVertices=[];var e=this;t.call(this,this.feature.geometry),this.layer.addFeatures(this.virtualVertices,{silent:!0}),this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var e=this.feature.geometry,t=e.getBounds().getCenterLonLat(),n=new OpenLayers.Geometry.Point(t.lon,t.lat),r=new OpenLayers.Feature.Vector(n);n.move=function(t,n){OpenLayers.Geometry.Point.prototype.move.call(this,t,n),e.move(t,n)},r._sketch=!0,this.dragHandle=r,this.dragHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var e=this.feature.geometry,t=e.getBounds(),n=t.getCenterLonLat(),r=new OpenLayers.Geometry.Point(n.lon,n.lat),i=new OpenLayers.Geometry.Point(t.right,t.bottom),s=new OpenLayers.Feature.Vector(i),o=this.mode&OpenLayers.Control.ModifyFeature.RESIZE,u=this.mode&OpenLayers.Control.ModifyFeature.RESHAPE,a=this.mode&OpenLayers.Control.ModifyFeature.ROTATE;i.move=function(t,n){OpenLayers.Geometry.Point.prototype.move.call(this,t,n);var i=this.x-r.x,s=this.y-r.y,f=i-t,l=s-n;if(a){var c=Math.atan2(l,f),h=Math.atan2(s,i),p=h-c;p*=180/Math.PI,e.rotate(p,r)}if(o){var d,v;if(u)d=s/l,v=i/f/d;else{var m=Math.sqrt(f*f+l*l),g=Math.sqrt(i*i+s*s);d=g/m}e.resize(d,r,v)}},s._sketch=!0,this.radiusHandle=s,this.radiusHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(e){this.standalone||this.selectControl.setMap(e),this.dragControl.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.ModifyFeature"}),OpenLayers.Control.ModifyFeature.RESHAPE=1,OpenLayers.Control.ModifyFeature.RESIZE=2,OpenLayers.Control.ModifyFeature.ROTATE=4,OpenLayers.Control.ModifyFeature.DRAG=8;