/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Renderer.Canvas=OpenLayers.Class(OpenLayers.Renderer,{hitDetection:!0,hitOverflow:0,canvas:null,features:null,pendingRedraw:!1,cachedSymbolBounds:{},initialize:function(e,t){OpenLayers.Renderer.prototype.initialize.apply(this,arguments),this.root=document.createElement("canvas"),this.container.appendChild(this.root),this.canvas=this.root.getContext("2d"),this.features={},this.hitDetection&&(this.hitCanvas=document.createElement("canvas"),this.hitContext=this.hitCanvas.getContext("2d"))},setExtent:function(){return OpenLayers.Renderer.prototype.setExtent.apply(this,arguments),!1},eraseGeometry:function(e,t){this.eraseFeatures(this.features[t][0])},supported:function(){return OpenLayers.CANVAS_SUPPORTED},setSize:function(e){this.size=e.clone();var t=this.root;t.style.width=e.w+"px",t.style.height=e.h+"px",t.width=e.w,t.height=e.h,this.resolution=null;if(this.hitDetection){var n=this.hitCanvas;n.style.width=e.w+"px",n.style.height=e.h+"px",n.width=e.w,n.height=e.h}},drawFeature:function(e,t){var n;if(e.geometry){t=this.applyDefaultSymbolizer(t||e.style);var r=e.geometry.getBounds(),i;this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&(i=this.map.getMaxExtent());var s=r&&r.intersectsBounds(this.extent,{worldBounds:i});n=t.display!=="none"&&!!r&&s,n?this.features[e.id]=[e,t]:delete this.features[e.id],this.pendingRedraw=!0}return this.pendingRedraw&&!this.locked&&(this.redraw(),this.pendingRedraw=!1),n},drawGeometry:function(e,t,n){var r=e.CLASS_NAME;if(r=="OpenLayers.Geometry.Collection"||r=="OpenLayers.Geometry.MultiPoint"||r=="OpenLayers.Geometry.MultiLineString"||r=="OpenLayers.Geometry.MultiPolygon"){for(var i=0;i<e.components.length;i++)this.drawGeometry(e.components[i],t,n);return}switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":this.drawPoint(e,t,n);break;case"OpenLayers.Geometry.LineString":this.drawLineString(e,t,n);break;case"OpenLayers.Geometry.LinearRing":this.drawLinearRing(e,t,n);break;case"OpenLayers.Geometry.Polygon":this.drawPolygon(e,t,n);break;default:}},drawExternalGraphic:function(e,t,n){var r=new Image;t.graphicTitle&&(r.title=t.graphicTitle);var i=t.graphicWidth||t.graphicHeight,s=t.graphicHeight||t.graphicWidth;i=i?i:t.pointRadius*2,s=s?s:t.pointRadius*2;var o=t.graphicXOffset!=undefined?t.graphicXOffset:-(.5*i),u=t.graphicYOffset!=undefined?t.graphicYOffset:-(.5*s),a=t.graphicOpacity||t.fillOpacity,f=function(){if(!this.features[n])return;var t=this.getLocalXY(e),f=t[0],l=t[1];if(!isNaN(f)&&!isNaN(l)){var c=f+o|0,h=l+u|0,p=this.canvas;p.globalAlpha=a;var d=OpenLayers.Renderer.Canvas.drawImageScaleFactor||(OpenLayers.Renderer.Canvas.drawImageScaleFactor=/android 2.1/.test(navigator.userAgent.toLowerCase())?320/window.screen.width:1);p.drawImage(r,c*d,h*d,i*d,s*d),this.hitDetection&&(this.setHitContextStyle("fill",n),this.hitContext.fillRect(c,h,i,s))}};r.onload=OpenLayers.Function.bind(f,this),r.src=t.externalGraphic},drawNamedSymbol:function(e,t,n){var r,i,s,o,u,a,f,l,c,h=Math.PI/180,p=OpenLayers.Renderer.symbol[t.graphicName];if(!p)throw new Error(t.graphicName+" is not a valid symbol name");if(!p.length||p.length<2)return;var d=this.getLocalXY(e),v=d[0],m=d[1];if(isNaN(v)||isNaN(m))return;this.canvas.lineCap="round",this.canvas.lineJoin="round",this.hitDetection&&(this.hitContext.lineCap="round",this.hitContext.lineJoin="round");if(t.graphicName in this.cachedSymbolBounds)a=this.cachedSymbolBounds[t.graphicName];else{a=new OpenLayers.Bounds;for(u=0;u<p.length;u+=2)a.extend(new OpenLayers.LonLat(p[u],p[u+1]));this.cachedSymbolBounds[t.graphicName]=a}this.canvas.save(),this.hitDetection&&this.hitContext.save(),this.canvas.translate(v,m),this.hitDetection&&this.hitContext.translate(v,m),l=h*t.rotation,isNaN(l)||(this.canvas.rotate(l),this.hitDetection&&this.hitContext.rotate(l)),f=2*t.pointRadius/Math.max(a.getWidth(),a.getHeight()),this.canvas.scale(f,f),this.hitDetection&&this.hitContext.scale(f,f),s=a.getCenterLonLat().lon,o=a.getCenterLonLat().lat,this.canvas.translate(-s,-o),this.hitDetection&&this.hitContext.translate(-s,-o),c=t.strokeWidth,t.strokeWidth=c/f;if(t.fill!==!1){this.setCanvasStyle("fill",t),this.canvas.beginPath();for(u=0;u<p.length;u+=2)r=p[u],i=p[u+1],u==0&&this.canvas.moveTo(r,i),this.canvas.lineTo(r,i);this.canvas.closePath(),this.canvas.fill();if(this.hitDetection){this.setHitContextStyle("fill",n,t),this.hitContext.beginPath();for(u=0;u<p.length;u+=2)r=p[u],i=p[u+1],u==0&&this.canvas.moveTo(r,i),this.hitContext.lineTo(r,i);this.hitContext.closePath(),this.hitContext.fill()}}if(t.stroke!==!1){this.setCanvasStyle("stroke",t),this.canvas.beginPath();for(u=0;u<p.length;u+=2)r=p[u],i=p[u+1],u==0&&this.canvas.moveTo(r,i),this.canvas.lineTo(r,i);this.canvas.closePath(),this.canvas.stroke();if(this.hitDetection){this.setHitContextStyle("stroke",n,t,f),this.hitContext.beginPath();for(u=0;u<p.length;u+=2)r=p[u],i=p[u+1],u==0&&this.hitContext.moveTo(r,i),this.hitContext.lineTo(r,i);this.hitContext.closePath(),this.hitContext.stroke()}}t.strokeWidth=c,this.canvas.restore(),this.hitDetection&&this.hitContext.restore(),this.setCanvasStyle("reset")},setCanvasStyle:function(e,t){e==="fill"?(this.canvas.globalAlpha=t.fillOpacity,this.canvas.fillStyle=t.fillColor):e==="stroke"?(this.canvas.globalAlpha=t.strokeOpacity,this.canvas.strokeStyle=t.strokeColor,this.canvas.lineWidth=t.strokeWidth):(this.canvas.globalAlpha=0,this.canvas.lineWidth=1)},featureIdToHex:function(e){var t=Number(e.split("_").pop())+1;t>=16777216&&(this.hitOverflow=t-16777215,t=t%16777216+1);var n="000000"+t.toString(16),r=n.length;return n="#"+n.substring(r-6,r),n},setHitContextStyle:function(e,t,n,r){var i=this.featureIdToHex(t);e=="fill"?(this.hitContext.globalAlpha=1,this.hitContext.fillStyle=i):e=="stroke"?(this.hitContext.globalAlpha=1,this.hitContext.strokeStyle=i,typeof r=="undefined"?this.hitContext.lineWidth=n.strokeWidth+2:isNaN(r)||(this.hitContext.lineWidth=n.strokeWidth+2/r)):(this.hitContext.globalAlpha=0,this.hitContext.lineWidth=1)},drawPoint:function(e,t,n){if(t.graphic!==!1)if(t.externalGraphic)this.drawExternalGraphic(e,t,n);else if(t.graphicName&&t.graphicName!="circle")this.drawNamedSymbol(e,t,n);else{var r=this.getLocalXY(e),i=r[0],s=r[1];if(!isNaN(i)&&!isNaN(s)){var o=Math.PI*2,u=t.pointRadius;t.fill!==!1&&(this.setCanvasStyle("fill",t),this.canvas.beginPath(),this.canvas.arc(i,s,u,0,o,!0),this.canvas.fill(),this.hitDetection&&(this.setHitContextStyle("fill",n,t),this.hitContext.beginPath(),this.hitContext.arc(i,s,u,0,o,!0),this.hitContext.fill())),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.canvas.beginPath(),this.canvas.arc(i,s,u,0,o,!0),this.canvas.stroke(),this.hitDetection&&(this.setHitContextStyle("stroke",n,t),this.hitContext.beginPath(),this.hitContext.arc(i,s,u,0,o,!0),this.hitContext.stroke()),this.setCanvasStyle("reset"))}}},drawLineString:function(e,t,n){t=OpenLayers.Util.applyDefaults({fill:!1},t),this.drawLinearRing(e,t,n)},drawLinearRing:function(e,t,n){t.fill!==!1&&(this.setCanvasStyle("fill",t),this.renderPath(this.canvas,e,t,n,"fill"),this.hitDetection&&(this.setHitContextStyle("fill",n,t),this.renderPath(this.hitContext,e,t,n,"fill"))),t.stroke!==!1&&(this.setCanvasStyle("stroke",t),this.renderPath(this.canvas,e,t,n,"stroke"),this.hitDetection&&(this.setHitContextStyle("stroke",n,t),this.renderPath(this.hitContext,e,t,n,"stroke"))),this.setCanvasStyle("reset")},renderPath:function(e,t,n,r,i){var s=t.components,o=s.length;e.beginPath();var u=this.getLocalXY(s[0]),a=u[0],f=u[1];if(!isNaN(a)&&!isNaN(f)){e.moveTo(u[0],u[1]);for(var l=1;l<o;++l){var c=this.getLocalXY(s[l]);e.lineTo(c[0],c[1])}i==="fill"?e.fill():e.stroke()}},drawPolygon:function(e,t,n){var r=e.components,i=r.length;this.drawLinearRing(r[0],t,n);for(var s=1;s<i;++s)this.canvas.globalCompositeOperation="destination-out",this.hitDetection&&(this.hitContext.globalCompositeOperation="destination-out"),this.drawLinearRing(r[s],OpenLayers.Util.applyDefaults({stroke:!1,fillOpacity:1},t),n),this.canvas.globalCompositeOperation="source-over",this.hitDetection&&(this.hitContext.globalCompositeOperation="source-over"),this.drawLinearRing(r[s],OpenLayers.Util.applyDefaults({fill:!1},t),n)},drawText:function(e,t){var n=this.getLocalXY(e);this.setCanvasStyle("reset"),this.canvas.fillStyle=t.fontColor,this.canvas.globalAlpha=t.fontOpacity||1;var r=[t.fontStyle?t.fontStyle:"normal","normal",t.fontWeight?t.fontWeight:"normal",t.fontSize?t.fontSize:"1em",t.fontFamily?t.fontFamily:"sans-serif"].join(" "),i=t.label.split("\n"),s=i.length;if(this.canvas.fillText){this.canvas.font=r,this.canvas.textAlign=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[0]]||"center",this.canvas.textBaseline=OpenLayers.Renderer.Canvas.LABEL_ALIGN[t.labelAlign[1]]||"middle";var o=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];o==null&&(o=-0.5);var u=this.canvas.measureText("Mg").height||this.canvas.measureText("xx").width;n[1]+=u*o*(s-1);for(var a=0;a<s;a++)t.labelOutlineWidth&&(this.canvas.save(),this.canvas.strokeStyle=t.labelOutlineColor,this.canvas.lineWidth=t.labelOutlineWidth,this.canvas.strokeText(i[a],n[0],n[1]+u*a+1),this.canvas.restore()),this.canvas.fillText(i[a],n[0],n[1]+u*a)}else if(this.canvas.mozDrawText){this.canvas.mozTextStyle=r;var f=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[0]];f==null&&(f=-0.5);var o=OpenLayers.Renderer.Canvas.LABEL_FACTOR[t.labelAlign[1]];o==null&&(o=-0.5);var u=this.canvas.mozMeasureText("xx");n[1]+=u*(1+o*s);for(var a=0;a<s;a++){var l=n[0]+f*this.canvas.mozMeasureText(i[a]),c=n[1]+a*u;this.canvas.translate(l,c),this.canvas.mozDrawText(i[a]),this.canvas.translate(-l,-c)}}this.setCanvasStyle("reset")},getLocalXY:function(e){var t=this.getResolution(),n=this.extent,r=(e.x-this.featureDx)/t+ -n.left/t,i=n.top/t-e.y/t;return[r,i]},clear:function(){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.features={},this.hitDetection&&this.hitContext.clearRect(0,0,t,e)},getFeatureIdFromEvent:function(e){var t,n;if(this.hitDetection&&this.root.style.display!=="none"&&!this.map.dragging){var r=e.xy,i=r.x|0,s=r.y|0,o=this.hitContext.getImageData(i,s,1,1).data;if(o[3]===255){var u=o[2]+256*(o[1]+256*o[0]);if(u){t="OpenLayers.Feature.Vector_"+(u-1+this.hitOverflow);try{n=this.features[t][0]}catch(a){}}}}return n},eraseFeatures:function(e){OpenLayers.Util.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t)delete this.features[e[t].id];this.redraw()},redraw:function(){if(!this.locked){var e=this.root.height,t=this.root.width;this.canvas.clearRect(0,0,t,e),this.hitDetection&&this.hitContext.clearRect(0,0,t,e);var n=[],r,i,s,o=this.map.baseLayer&&this.map.baseLayer.wrapDateLine&&this.map.getMaxExtent();for(var u in this.features){if(!this.features.hasOwnProperty(u))continue;r=this.features[u][0],i=r.geometry,this.calculateFeatureDx(i.getBounds(),o),s=this.features[u][1],this.drawGeometry(i,s,r.id),s.label&&n.push([r,s])}var a;for(var f=0,l=n.length;f<l;++f)a=n[f],this.drawText(a[0].geometry.getCentroid(),a[1])}},CLASS_NAME:"OpenLayers.Renderer.Canvas"}),OpenLayers.Renderer.Canvas.LABEL_ALIGN={l:"left",r:"right",t:"top",b:"bottom"},OpenLayers.Renderer.Canvas.LABEL_FACTOR={l:0,r:-1,t:0,b:-1},OpenLayers.Renderer.Canvas.drawImageScaleFactor=null;