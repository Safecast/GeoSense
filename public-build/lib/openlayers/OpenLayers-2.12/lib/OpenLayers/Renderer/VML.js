/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Renderer.VML=OpenLayers.Class(OpenLayers.Renderer.Elements,{xmlns:"urn:schemas-microsoft-com:vml",symbolCache:{},offset:null,initialize:function(e){if(!this.supported())return;if(!document.namespaces.olv){document.namespaces.add("olv",this.xmlns);var t=document.createStyleSheet(),n=["shape","rect","oval","fill","stroke","imagedata","group","textbox"];for(var r=0,i=n.length;r<i;r++)t.addRule("olv\\:"+n[r],"behavior: url(#default#VML); position: absolute; display: inline-block;")}OpenLayers.Renderer.Elements.prototype.initialize.apply(this,arguments)},supported:function(){return!!document.namespaces},setExtent:function(e,t){var n=OpenLayers.Renderer.Elements.prototype.setExtent.apply(this,arguments),r=this.getResolution(),i=e.left/r|0,s=e.top/r-this.size.h|0;t||!this.offset?(this.offset={x:i,y:s},i=0,s=0):(i-=this.offset.x,s-=this.offset.y);var o=i-this.xOffset+" "+s;this.root.coordorigin=o;var u=[this.root,this.vectorRoot,this.textRoot],a;for(var f=0,l=u.length;f<l;++f){a=u[f];var c=this.size.w+" "+this.size.h;a.coordsize=c}return this.root.style.flip="y",n},setSize:function(e){OpenLayers.Renderer.prototype.setSize.apply(this,arguments);var t=[this.rendererRoot,this.root,this.vectorRoot,this.textRoot],n=this.size.w+"px",r=this.size.h+"px",i;for(var s=0,o=t.length;s<o;++s)i=t[s],i.style.width=n,i.style.height=r},getNodeType:function(e,t){var n=null;switch(e.CLASS_NAME){case"OpenLayers.Geometry.Point":t.externalGraphic?n="olv:rect":this.isComplexSymbol(t.graphicName)?n="olv:shape":n="olv:oval";break;case"OpenLayers.Geometry.Rectangle":n="olv:rect";break;case"OpenLayers.Geometry.LineString":case"OpenLayers.Geometry.LinearRing":case"OpenLayers.Geometry.Polygon":case"OpenLayers.Geometry.Curve":n="olv:shape";break;default:}return n},setStyle:function(e,t,n,r){t=t||e._style,n=n||e._options;var i=t.fillColor;if(e._geometryClass==="OpenLayers.Geometry.Point")if(t.externalGraphic){n.isFilled=!0,t.graphicTitle&&(e.title=t.graphicTitle);var s=t.graphicWidth||t.graphicHeight,o=t.graphicHeight||t.graphicWidth;s=s?s:t.pointRadius*2,o=o?o:t.pointRadius*2;var u=this.getResolution(),a=t.graphicXOffset!=undefined?t.graphicXOffset:-(.5*s),f=t.graphicYOffset!=undefined?t.graphicYOffset:-(.5*o);e.style.left=((r.x-this.featureDx)/u-this.offset.x+a|0)+"px",e.style.top=(r.y/u-this.offset.y-(f+o)|0)+"px",e.style.width=s+"px",e.style.height=o+"px",e.style.flip="y",i="none",n.isStroked=!1}else if(this.isComplexSymbol(t.graphicName)){var l=this.importSymbol(t.graphicName);e.path=l.path,e.coordorigin=l.left+","+l.bottom;var c=l.size;e.coordsize=c+","+c,this.drawCircle(e,r,t.pointRadius),e.style.flip="y"}else this.drawCircle(e,r,t.pointRadius);n.isFilled?e.fillcolor=i:e.filled="false";var h=e.getElementsByTagName("fill"),p=h.length==0?null:h[0];if(!n.isFilled)p&&e.removeChild(p);else{p||(p=this.createNode("olv:fill",e.id+"_fill")),p.opacity=t.fillOpacity;if(e._geometryClass==="OpenLayers.Geometry.Point"&&t.externalGraphic){t.graphicOpacity&&(p.opacity=t.graphicOpacity),p.src=t.externalGraphic,p.type="frame";if(!t.graphicWidth||!t.graphicHeight)p.aspect="atmost"}p.parentNode!=e&&e.appendChild(p)}var d=t.rotation;if(d!==undefined||e._rotation!==undefined)e._rotation=d,t.externalGraphic?(this.graphicRotate(e,a,f,t),p.opacity=0):e._geometryClass==="OpenLayers.Geometry.Point"&&(e.style.rotation=d||0);var v=e.getElementsByTagName("stroke"),m=v.length==0?null:v[0];return n.isStroked?(m||(m=this.createNode("olv:stroke",e.id+"_stroke"),e.appendChild(m)),m.on=!0,m.color=t.strokeColor,m.weight=t.strokeWidth+"px",m.opacity=t.strokeOpacity,m.endcap=t.strokeLinecap=="butt"?"flat":t.strokeLinecap||"round",t.strokeDashstyle&&(m.dashstyle=this.dashStyle(t))):(e.stroked=!1,m&&(m.on=!1)),t.cursor!="inherit"&&t.cursor!=null&&(e.style.cursor=t.cursor),e},graphicRotate:function(e,t,n,r){var r=r||e._style,i=r.rotation||0,s,o;if(!r.graphicWidth||!r.graphicHeight){var u=new Image;u.onreadystatechange=OpenLayers.Function.bind(function(){if(u.readyState=="complete"||u.readyState=="interactive")s=u.width/u.height,o=Math.max(r.pointRadius*2,r.graphicWidth||0,r.graphicHeight||0),t*=s,r.graphicWidth=o*s,r.graphicHeight=o,this.graphicRotate(e,t,n,r)},this),u.src=r.externalGraphic;return}o=Math.max(r.graphicWidth,r.graphicHeight),s=r.graphicWidth/r.graphicHeight;var a=Math.round(r.graphicWidth||o*s),f=Math.round(r.graphicHeight||o);e.style.width=a+"px",e.style.height=f+"px";var l=document.getElementById(e.id+"_image");l||(l=this.createNode("olv:imagedata",e.id+"_image"),e.appendChild(l)),l.style.width=a+"px",l.style.height=f+"px",l.src=r.externalGraphic,l.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='', sizingMethod='scale')";var c=i*Math.PI/180,h=Math.sin(c),p=Math.cos(c),d="progid:DXImageTransform.Microsoft.Matrix(M11="+p+",M12="+ -h+",M21="+h+",M22="+p+",SizingMethod='auto expand')\n",v=r.graphicOpacity||r.fillOpacity;v&&v!=1&&(d+="progid:DXImageTransform.Microsoft.BasicImage(opacity="+v+")\n"),e.style.filter=d;var m=new OpenLayers.Geometry.Point(-t,-n),g=(new OpenLayers.Bounds(0,0,a,f)).toGeometry();g.rotate(r.rotation,m);var y=g.getBounds();e.style.left=Math.round(parseInt(e.style.left)+y.left)+"px",e.style.top=Math.round(parseInt(e.style.top)-y.bottom)+"px"},postDraw:function(e){e.style.visibility="visible";var t=e._style.fillColor,n=e._style.strokeColor;t=="none"&&e.fillcolor!=t&&(e.fillcolor=t),n=="none"&&e.strokecolor!=n&&(e.strokecolor=n)},setNodeDimension:function(e,t){var n=t.getBounds();if(n){var r=this.getResolution(),i=new OpenLayers.Bounds((n.left-this.featureDx)/r-this.offset.x|0,n.bottom/r-this.offset.y|0,(n.right-this.featureDx)/r-this.offset.x|0,n.top/r-this.offset.y|0);e.style.left=i.left+"px",e.style.top=i.top+"px",e.style.width=i.getWidth()+"px",e.style.height=i.getHeight()+"px",e.coordorigin=i.left+" "+i.top,e.coordsize=i.getWidth()+" "+i.getHeight()}},dashStyle:function(e){var t=e.strokeDashstyle;switch(t){case"solid":case"dot":case"dash":case"dashdot":case"longdash":case"longdashdot":return t;default:var n=t.split(/[ ,]/);if(n.length==2)return 1*n[0]>=2*n[1]?"longdash":n[0]==1||n[1]==1?"dot":"dash";if(n.length==4)return 1*n[0]>=2*n[1]?"longdashdot":"dashdot";return"solid"}},createNode:function(e,t){var n=document.createElement(e);return t&&(n.id=t),n.unselectable="on",n.onselectstart=OpenLayers.Function.False,n},nodeTypeCompare:function(e,t){var n=t,r=n.indexOf(":");r!=-1&&(n=n.substr(r+1));var i=e.nodeName;return r=i.indexOf(":"),r!=-1&&(i=i.substr(r+1)),n==i},createRenderRoot:function(){return this.nodeFactory(this.container.id+"_vmlRoot","div")},createRoot:function(e){return this.nodeFactory(this.container.id+e,"olv:group")},drawPoint:function(e,t){return this.drawCircle(e,t,1)},drawCircle:function(e,t,n){if(!isNaN(t.x)&&!isNaN(t.y)){var r=this.getResolution();e.style.left=((t.x-this.featureDx)/r-this.offset.x|0)-n+"px",e.style.top=(t.y/r-this.offset.y|0)-n+"px";var i=n*2;return e.style.width=i+"px",e.style.height=i+"px",e}return!1},drawLineString:function(e,t){return this.drawLine(e,t,!1)},drawLinearRing:function(e,t){return this.drawLine(e,t,!0)},drawLine:function(e,t,n){this.setNodeDimension(e,t);var r=this.getResolution(),i=t.components.length,s=new Array(i),o,u,a;for(var f=0;f<i;f++)o=t.components[f],u=(o.x-this.featureDx)/r-this.offset.x|0,a=o.y/r-this.offset.y|0,s[f]=" "+u+","+a+" l ";var l=n?" x e":" e";return e.path="m"+s.join("")+l,e},drawPolygon:function(e,t){this.setNodeDimension(e,t);var n=this.getResolution(),r=[],i,s,o,u,a,f,l,c,h,p,d,v;for(i=0,s=t.components.length;i<s;i++){r.push("m"),o=t.components[i].components,u=i===0,a=null,f=null;for(l=0,c=o.length;l<c;l++)h=o[l],d=(h.x-this.featureDx)/n-this.offset.x|0,v=h.y/n-this.offset.y|0,p=" "+d+","+v,r.push(p),l==0&&r.push(" l"),u||(a?a!=p&&(f?f!=p&&(u=!0):f=p):a=p);r.push(u?" x ":" ")}return r.push("e"),e.path=r.join(""),e},drawRectangle:function(e,t){var n=this.getResolution();return e.style.left=((t.x-this.featureDx)/n-this.offset.x|0)+"px",e.style.top=(t.y/n-this.offset.y|0)+"px",e.style.width=(t.width/n|0)+"px",e.style.height=(t.height/n|0)+"px",e},drawText:function(e,t,n){var r=this.nodeFactory(e+this.LABEL_ID_SUFFIX,"olv:rect"),i=this.nodeFactory(e+this.LABEL_ID_SUFFIX+"_textbox","olv:textbox"),s=this.getResolution();r.style.left=((n.x-this.featureDx)/s-this.offset.x|0)+"px",r.style.top=(n.y/s-this.offset.y|0)+"px",r.style.flip="y",i.innerText=t.label,t.cursor!="inherit"&&t.cursor!=null&&(i.style.cursor=t.cursor),t.fontColor&&(i.style.color=t.fontColor),t.fontOpacity&&(i.style.filter="alpha(opacity="+t.fontOpacity*100+")"),t.fontFamily&&(i.style.fontFamily=t.fontFamily),t.fontSize&&(i.style.fontSize=t.fontSize),t.fontWeight&&(i.style.fontWeight=t.fontWeight),t.fontStyle&&(i.style.fontStyle=t.fontStyle),t.labelSelect===!0&&(r._featureId=e,i._featureId=e,i._geometry=n,i._geometryClass=n.CLASS_NAME),i.style.whiteSpace="nowrap",i.inset="1px,0px,0px,0px",r.parentNode||(r.appendChild(i),this.textRoot.appendChild(r));var o=t.labelAlign||"cm";o.length==1&&(o+="m");var u=i.clientWidth*OpenLayers.Renderer.VML.LABEL_SHIFT[o.substr(0,1)],a=i.clientHeight*OpenLayers.Renderer.VML.LABEL_SHIFT[o.substr(1,1)];r.style.left=parseInt(r.style.left)-u-1+"px",r.style.top=parseInt(r.style.top)+a+"px"},moveRoot:function(e){var t=this.map.getLayer(e.container.id);t instanceof OpenLayers.Layer.Vector.RootContainer&&(t=this.map.getLayer(this.container.id)),t&&t.renderer.clear(),OpenLayers.Renderer.Elements.prototype.moveRoot.apply(this,arguments),t&&t.redraw()},importSymbol:function(e){var t=this.container.id+"-"+e,n=this.symbolCache[t];if(n)return n;var r=OpenLayers.Renderer.symbol[e];if(!r)throw new Error(e+" is not a valid symbol name");var i=new OpenLayers.Bounds(Number.MAX_VALUE,Number.MAX_VALUE,0,0),s=["m"];for(var o=0;o<r.length;o+=2){var u=r[o],a=r[o+1];i.left=Math.min(i.left,u),i.bottom=Math.min(i.bottom,a),i.right=Math.max(i.right,u),i.top=Math.max(i.top,a),s.push(u),s.push(a),o==0&&s.push("l")}s.push("x e");var f=s.join(" "),l=(i.getWidth()-i.getHeight())/2;return l>0?(i.bottom=i.bottom-l,i.top=i.top+l):(i.left=i.left+l,i.right=i.right-l),n={path:f,size:i.getWidth(),left:i.left,bottom:i.bottom},this.symbolCache[t]=n,n},CLASS_NAME:"OpenLayers.Renderer.VML"}),OpenLayers.Renderer.VML.LABEL_SHIFT={l:0,c:.5,r:1,t:0,m:.5,b:1};