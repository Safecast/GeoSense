/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.Google.v3={DEFAULTS:{sphericalMercator:!0,projection:"EPSG:900913"},animationEnabled:!0,loadMapObject:function(){this.type||(this.type=google.maps.MapTypeId.ROADMAP);var e,t=OpenLayers.Layer.Google.cache[this.map.id];if(t)e=t.mapObject,++t.count;else{var n=this.map.viewPortDiv,r=document.createElement("div");r.id=this.map.id+"_GMapContainer",r.style.position="absolute",r.style.width="100%",r.style.height="100%",n.appendChild(r);var i=this.map.getCenter();e=new google.maps.Map(r,{center:i?new google.maps.LatLng(i.lat,i.lon):new google.maps.LatLng(0,0),zoom:this.map.getZoom()||0,mapTypeId:this.type,disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1}),t={mapObject:e,count:1},OpenLayers.Layer.Google.cache[this.map.id]=t,this.repositionListener=google.maps.event.addListenerOnce(e,"center_changed",OpenLayers.Function.bind(this.repositionMapElements,this))}this.mapObject=e,this.setGMapVisibility(this.visibility)},repositionMapElements:function(){google.maps.event.trigger(this.mapObject,"resize");var e=this.mapObject.getDiv().firstChild;if(!e||e.childNodes.length<3)return this.repositionTimer=window.setTimeout(OpenLayers.Function.bind(this.repositionMapElements,this),250),!1;var t=OpenLayers.Layer.Google.cache[this.map.id],n=this.map.viewPortDiv;for(var r=e.children.length-1;r>=0;--r){if(e.children[r].style.zIndex==1000001){var i=e.children[r];n.appendChild(i),i.style.zIndex="1100",i.style.bottom="",i.className="olLayerGoogleCopyright olLayerGoogleV3",i.style.display="",t.termsOfUse=i}if(e.children[r].style.zIndex==1e6){var s=e.children[r];n.appendChild(s),s.style.zIndex="1100",s.style.bottom="",s.className="olLayerGooglePoweredBy olLayerGoogleV3 gmnoprint",s.style.display="",t.poweredBy=s}e.children[r].style.zIndex==10000002&&n.appendChild(e.children[r])}this.setGMapVisibility(this.visibility)},onMapResize:function(){if(this.visibility)google.maps.event.trigger(this.mapObject,"resize");else{var e=OpenLayers.Layer.Google.cache[this.map.id];if(!e.resized){var t=this;google.maps.event.addListenerOnce(this.mapObject,"tilesloaded",function(){google.maps.event.trigger(t.mapObject,"resize"),t.moveTo(t.map.getCenter(),t.map.getZoom()),delete e.resized})}e.resized=!0}},setGMapVisibility:function(e){var t=OpenLayers.Layer.Google.cache[this.map.id];if(t){var n=this.type,r=this.map.layers,i;for(var s=r.length-1;s>=0;--s){i=r[s];if(i instanceof OpenLayers.Layer.Google&&i.visibility===!0&&i.inRange===!0){n=i.type,e=!0;break}}var o=this.mapObject.getDiv();e===!0?(this.mapObject.setMapTypeId(n),o.style.left="",t.termsOfUse&&t.termsOfUse.style&&(t.termsOfUse.style.left="",t.termsOfUse.style.display="",t.poweredBy.style.display=""),t.displayed=this.id):(delete t.displayed,o.style.left="-9999px",t.termsOfUse&&t.termsOfUse.style&&(t.termsOfUse.style.display="none",t.termsOfUse.style.left="-9999px",t.poweredBy.style.display="none"))}},getMapContainer:function(){return this.mapObject.getDiv()},getMapObjectBoundsFromOLBounds:function(e){var t=null;if(e!=null){var n=this.sphericalMercator?this.inverseMercator(e.bottom,e.left):new OpenLayers.LonLat(e.bottom,e.left),r=this.sphericalMercator?this.inverseMercator(e.top,e.right):new OpenLayers.LonLat(e.top,e.right);t=new google.maps.LatLngBounds(new google.maps.LatLng(n.lat,n.lon),new google.maps.LatLng(r.lat,r.lon))}return t},getMapObjectLonLatFromMapObjectPixel:function(e){var t=this.map.getSize(),n=this.getLongitudeFromMapObjectLonLat(this.mapObject.center),r=this.getLatitudeFromMapObjectLonLat(this.mapObject.center),i=this.map.getResolution(),s=e.x-t.w/2,o=e.y-t.h/2,u=new OpenLayers.LonLat(n+s*i,r-o*i);return this.wrapDateLine&&(u=u.wrapDateLine(this.maxExtent)),this.getMapObjectLonLatFromLonLat(u.lon,u.lat)},getMapObjectPixelFromMapObjectLonLat:function(e){var t=this.getLongitudeFromMapObjectLonLat(e),n=this.getLatitudeFromMapObjectLonLat(e),r=this.map.getResolution(),i=this.map.getExtent();return this.getMapObjectPixelFromXY(1/r*(t-i.left),1/r*(i.top-n))},setMapObjectCenter:function(e,t){if(this.animationEnabled===!1&&t!=this.mapObject.zoom){var n=this.getMapContainer();google.maps.event.addListenerOnce(this.mapObject,"idle",function(){n.style.visibility=""}),n.style.visibility="hidden"}this.mapObject.setOptions({center:e,zoom:t})},getMapObjectZoomFromMapObjectBounds:function(e){return this.mapObject.getBoundsZoomLevel(e)},getMapObjectLonLatFromLonLat:function(e,t){var n;if(this.sphericalMercator){var r=this.inverseMercator(e,t);n=new google.maps.LatLng(r.lat,r.lon)}else n=new google.maps.LatLng(t,e);return n},getMapObjectPixelFromXY:function(e,t){return new google.maps.Point(e,t)},destroy:function(){this.repositionListener&&google.maps.event.removeListener(this.repositionListener),this.repositionTimer&&window.clearTimeout(this.repositionTimer),OpenLayers.Layer.Google.prototype.destroy.apply(this,arguments)}};