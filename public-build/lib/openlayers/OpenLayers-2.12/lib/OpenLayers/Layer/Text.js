/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.Text=OpenLayers.Class(OpenLayers.Layer.Markers,{location:null,features:null,formatOptions:null,selectedFeature:null,initialize:function(e,t){OpenLayers.Layer.Markers.prototype.initialize.apply(this,arguments),this.features=[]},destroy:function(){OpenLayers.Layer.Markers.prototype.destroy.apply(this,arguments),this.clearFeatures(),this.features=null},loadText:function(){if(!this.loaded&&this.location!=null){var e=function(e){this.events.triggerEvent("loadend")};this.events.triggerEvent("loadstart"),OpenLayers.Request.GET({url:this.location,success:this.parseData,failure:e,scope:this}),this.loaded=!0}},moveTo:function(e,t,n){OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments),this.visibility&&!this.loaded&&this.loadText()},parseData:function(e){var t=e.responseText,n={};OpenLayers.Util.extend(n,this.formatOptions),this.map&&!this.projection.equals(this.map.getProjectionObject())&&(n.externalProjection=this.projection,n.internalProjection=this.map.getProjectionObject());var r=new OpenLayers.Format.Text(n),i=r.read(t);for(var s=0,o=i.length;s<o;s++){var u={},a=i[s],f,l,c;f=new OpenLayers.LonLat(a.geometry.x,a.geometry.y),a.style.graphicWidth&&a.style.graphicHeight&&(l=new OpenLayers.Size(a.style.graphicWidth,a.style.graphicHeight)),a.style.graphicXOffset!==undefined&&a.style.graphicYOffset!==undefined&&(c=new OpenLayers.Pixel(a.style.graphicXOffset,a.style.graphicYOffset)),a.style.externalGraphic!=null?u.icon=new OpenLayers.Icon(a.style.externalGraphic,l,c):(u.icon=OpenLayers.Marker.defaultIcon(),l!=null&&u.icon.setSize(l)),a.attributes.title!=null&&a.attributes.description!=null&&(u.popupContentHTML="<h2>"+a.attributes.title+"</h2>"+"<p>"+a.attributes.description+"</p>"),u.overflow=a.attributes.overflow||"auto";var h=new OpenLayers.Feature(this,f,u);this.features.push(h);var p=h.createMarker();a.attributes.title!=null&&a.attributes.description!=null&&p.events.register("click",h,this.markerClick),this.addMarker(p)}this.events.triggerEvent("loadend")},markerClick:function(e){var t=this==this.layer.selectedFeature;this.layer.selectedFeature=t?null:this;for(var n=0,r=this.layer.map.popups.length;n<r;n++)this.layer.map.removePopup(this.layer.map.popups[n]);t||this.layer.map.addPopup(this.createPopup()),OpenLayers.Event.stop(e)},clearFeatures:function(){if(this.features!=null)while(this.features.length>0){var e=this.features[0];OpenLayers.Util.removeItem(this.features,e),e.destroy()}},CLASS_NAME:"OpenLayers.Layer.Text"});