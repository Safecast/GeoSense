/* Copyright (c) 2006-2012 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the 2-clause BSD license.
 * See license.txt in the OpenLayers distribution or repository for the
 * full text of the license. */

OpenLayers.Layer.GeoRSS=OpenLayers.Class(OpenLayers.Layer.Markers,{location:null,features:null,formatOptions:null,selectedFeature:null,icon:null,popupSize:null,useFeedTitle:!0,initialize:function(e,t,n){OpenLayers.Layer.Markers.prototype.initialize.apply(this,[e,n]),this.location=t,this.features=[]},destroy:function(){OpenLayers.Layer.Markers.prototype.destroy.apply(this,arguments),this.clearFeatures(),this.features=null},loadRSS:function(){this.loaded||(this.events.triggerEvent("loadstart"),OpenLayers.Request.GET({url:this.location,success:this.parseData,scope:this}),this.loaded=!0)},moveTo:function(e,t,n){OpenLayers.Layer.Markers.prototype.moveTo.apply(this,arguments),this.visibility&&!this.loaded&&this.loadRSS()},parseData:function(e){var t=e.responseXML;if(!t||!t.documentElement)t=OpenLayers.Format.XML.prototype.read(e.responseText);if(this.useFeedTitle){var n=null;try{n=t.getElementsByTagNameNS("*","title")[0].firstChild.nodeValue}catch(r){n=t.getElementsByTagName("title")[0].firstChild.nodeValue}n&&this.setName(n)}var i={};OpenLayers.Util.extend(i,this.formatOptions),this.map&&!this.projection.equals(this.map.getProjectionObject())&&(i.externalProjection=this.projection,i.internalProjection=this.map.getProjectionObject());var s=new OpenLayers.Format.GeoRSS(i),o=s.read(t);for(var u=0,a=o.length;u<a;u++){var f={},l=o[u];if(!l.geometry)continue;var c=l.attributes.title?l.attributes.title:"Untitled",h=l.attributes.description?l.attributes.description:"No description.",p=l.attributes.link?l.attributes.link:"",d=l.geometry.getBounds().getCenterLonLat();f.icon=this.icon==null?OpenLayers.Marker.defaultIcon():this.icon.clone(),f.popupSize=this.popupSize?this.popupSize.clone():new OpenLayers.Size(250,120);if(c||h){f.title=c,f.description=h;var v='<div class="olLayerGeoRSSClose">[x]</div>';v+='<div class="olLayerGeoRSSTitle">',p&&(v+='<a class="link" href="'+p+'" target="_blank">'),v+=c,p&&(v+="</a>"),v+="</div>",v+='<div style="" class="olLayerGeoRSSDescription">',v+=h,v+="</div>",f.popupContentHTML=v}var l=new OpenLayers.Feature(this,d,f);this.features.push(l);var m=l.createMarker();m.events.register("click",l,this.markerClick),this.addMarker(m)}this.events.triggerEvent("loadend")},markerClick:function(e){var t=this==this.layer.selectedFeature;this.layer.selectedFeature=t?null:this;for(var n=0,r=this.layer.map.popups.length;n<r;n++)this.layer.map.removePopup(this.layer.map.popups[n]);if(!t){var i=this.createPopup();OpenLayers.Event.observe(i.div,"click",OpenLayers.Function.bind(function(){for(var e=0,t=this.layer.map.popups.length;e<t;e++)this.layer.map.removePopup(this.layer.map.popups[e])},this)),this.layer.map.addPopup(i)}OpenLayers.Event.stop(e)},clearFeatures:function(){if(this.features!=null)while(this.features.length>0){var e=this.features[0];OpenLayers.Util.removeItem(this.features,e),e.destroy()}},CLASS_NAME:"OpenLayers.Layer.GeoRSS"});