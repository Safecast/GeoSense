(function(e){typeof define=="function"&&define.amd?define(["underscore","backbone"],e):e(_,Backbone)})(function(e,t){function n(t){var r={},i=o.keyPathSeparator;for(var s in t){var u=t[s];if(u&&u.constructor===Object&&!e.isEmpty(u)){var a=n(u);for(var f in a){var l=a[f];r[s+i+f]=l}}else r[s]=u}return r}function r(t,n,r){var i=o.keyPathSeparator,s=n.split(i),u=t;r||r===!1;for(var a=0,f=s.length;a<f;a++){if(r&&!e.has(u,s[a]))return!1;u=u[s[a]],u==null&&a<f-1&&(u={});if(typeof u=="undefined")return r?!0:u}return r?!0:u}function i(t,n,r,i){i=i||{};var s=o.keyPathSeparator,u=n.split(s),a=t;for(var f=0,l=u.length;f<l&&a!==undefined;f++){var c=u[f];if(f===l-1)i.unset?delete a[c]:a[c]=r;else{if(typeof a[c]=="undefined"||!e.isObject(a[c]))a[c]={};a=a[c]}}}function s(e,t){i(e,t,null,{unset:!0})}var o=t.Model.extend({constructor:function(t,n){var r,i=t||{};this.cid=e.uniqueId("c"),this.changed={},this.attributes={},this._changes=[],n&&n.collection&&(this.collection=n.collection),n&&n.parse&&(i=this.parse(i));if(r=e.result(this,"defaults"))i=e.deepExtend({},r,t);this.set(i,{silent:!0}),this._currentAttributes=e.deepClone(this.attributes),this._previousAttributes=e.deepClone(this.attributes),this.initialize.apply(this,arguments)},toJSON:function(t){return e.deepClone(this.attributes)},clear:function(t){var r={},i=n(this.attributes);for(var s in i)r[s]=void 0;return this.set(r,e.extend({},t,{unset:!0}))},get:function(e){return r(this.attributes,e)},set:function(t,r,o){var u,a;if(t==null)return this;e.isObject(t)?(a=t,o=r):(a={})[t]=r;var f=o&&o.silent,l=o&&o.unset;if(!this._validate(a,o))return!1;this.idAttribute in a&&(this.id=a[this.idAttribute]);var c=this.attributes;a=n(a);for(u in a)r=a[u],l?s(c,u):i(c,u,r),this._changes.push(u,r);return this._hasComputed=!1,f||this.change(o),this},_computeChanges:function(t){this.changed={};var n={},s=[],u=this._currentAttributes,a=this._changes;for(var f=a.length-2;f>=0;f-=2){var l=a[f],c=a[f+1];if(n[l])continue;n[l]=!0;if(r(u,l)!==c){this.changed[l]=c;if(!t)continue;i(u,l,c);var h=o.keyPathSeparator,p=l.split(h);for(var d=1;d<p.length;d++){var v=e.first(p,d).join(h);if(n[v])continue;n[v]=!0;var m=r(u,v);v+=h+"*",s.push(v,m)}s.push(l,c)}}return t&&(this._changes=[]),this._hasComputed=!0,s},change:function(t){var n=this._changing;this._changing=!0;var r=this._computeChanges(!0);this._pending=!!r.length;for(var i=r.length-2;i>=0;i-=2)this.trigger("change:"+r[i],this,r[i+1],t);if(n)return this;while(this._pending)this._pending=!1,this.trigger("change",this,t),this._previousAttributes=e.deepClone(this.attributes);return this._changing=!1,this.changed=!1,this},changedAttributes:function(t){if(!t)return this.hasChanged()?e.clone(this.changed):!1;t=n(t);var r=n(this._previousAttributes),i,s=!1;for(var o in t){if(e.isEqual(r[o],i=t[o]))continue;(s||(s={}))[o]=i}return s}});return o.keyPathSeparator=".",t.DeepModel=o,typeof module!="undefined"&&(module.exports=o),t});