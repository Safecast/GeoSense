<!DOCTYPE html>  <html> <head>   <title>threex.sparks.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="THREEx.CelShader.html">                 THREEx.CelShader.js               </a>                                           <a class="source" href="THREEx.DeviceOrientationState.html">                 THREEx.DeviceOrientationState.js               </a>                                           <a class="source" href="THREEx.FullScreen.html">                 THREEx.FullScreen.js               </a>                                           <a class="source" href="THREEx.GeometryUtils.html">                 THREEx.GeometryUtils.js               </a>                                           <a class="source" href="THREEx.GeometryWobble.html">                 THREEx.GeometryWobble.js               </a>                                           <a class="source" href="THREEx.KeyboardState.html">                 THREEx.KeyboardState.js               </a>                                           <a class="source" href="THREEx.LogoTurtle.html">                 THREEx.LogoTurtle.js               </a>                                           <a class="source" href="THREEx.PlasmaShader.html">                 THREEx.PlasmaShader.js               </a>                                           <a class="source" href="THREEx.SkyMap.html">                 THREEx.SkyMap.js               </a>                                           <a class="source" href="THREEx.WindowResize.html">                 THREEx.WindowResize.js               </a>                                           <a class="source" href="THREEx.glCapability.html">                 THREEx.glCapability.js               </a>                                           <a class="source" href="THREEx.requestAnimationFrame.html">                 THREEx.requestAnimationFrame.js               </a>                                           <a class="source" href="THREEx.screenshot.html">                 THREEx.screenshot.js               </a>                                           <a class="source" href="threex.chromeWebStoreInstall.html">                 threex.chromeWebStoreInstall.js               </a>                                           <a class="source" href="threex.domevent.html">                 threex.domevent.js               </a>                                           <a class="source" href="threex.embedded.html">                 threex.embedded.js               </a>                                           <a class="source" href="threex.sparks.html">                 threex.sparks.js               </a>                                           <a class="source" href="threex.sparksPlugins.html">                 threex.sparksPlugins.js               </a>                                           <a class="source" href="threex.texturePoolBall.html">                 threex.texturePoolBall.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               threex.sparks.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This THREEx helper makes it even easier to use spark.js with three.js
* FIXME This is currently only with WebGL</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>Code</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">THREEx</span>	<span class="o">=</span> <span class="nx">THREEx</span> 	<span class="o">||</span> <span class="p">{};</span>


<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">opts</span>		<span class="o">=</span> <span class="nx">opts</span>	<span class="o">||</span> <span class="p">{};</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_maxParticles</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">maxParticles</span>	<span class="o">||</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_texture</span>	<span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">texture</span>	<span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">_buildDefaultTexture</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">counter</span>	<span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">counter</span>	<span class="o">||</span> <span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
	</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>TODO replace this by objectpool.js</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">vertexIndexPool</span> <span class="o">=</span> <span class="p">{</span>
		<span class="nx">__pools</span><span class="o">:</span> <span class="p">[],</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get a new Vector</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">__pools</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>	<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">__pools</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;pool ran out!&quot;</span><span class="p">)</span>
			<span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Release a vector back into the pool</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">add</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span> <span class="k">this</span><span class="p">.</span><span class="nx">__pools</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>	<span class="p">}</span>
	<span class="p">};</span>
	
	
	<span class="kd">var</span> <span class="nx">particles</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
	<span class="kd">var</span> <span class="nx">vertices</span>	<span class="o">=</span> <span class="nx">particles</span><span class="p">.</span><span class="nx">vertices</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_maxParticles</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">position</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">,</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">,</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">);</span>
		<span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vertex</span><span class="p">(</span><span class="nx">position</span><span class="p">));</span>
		<span class="nx">vertexIndexPool</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>to handle window resize</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">this</span><span class="p">.</span><span class="nx">_$onWindowResize</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_onWindowResize</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_$onWindowResize</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

	<span class="kd">var</span> <span class="nx">attributes</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="nx">size</span>	<span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">[]</span> <span class="p">},</span>
		<span class="nx">aColor</span>	<span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">[]</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="kd">var</span> <span class="nx">uniforms</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uniforms</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="nx">texture</span>		<span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="nx">texture</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_texture</span> 		<span class="p">},</span>
		<span class="nx">color</span>		<span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">)</span>	<span class="p">},</span>
		<span class="nx">sizeRatio</span>	<span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_computeSizeRatio</span><span class="p">()</span>	<span class="p">}</span>
	<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>fill attributes array</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">valuesSize</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">valuesColor</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span><span class="p">.</span><span class="nx">aColor</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">particles</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">v</span><span class="o">++</span> <span class="p">){</span>
		<span class="nx">valuesSize</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">99</span><span class="p">;</span>
		<span class="nx">valuesColor</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span> <span class="mh">0x000000</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">material</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span><span class="p">(</span> <span class="p">{</span>
		<span class="nx">uniforms</span>	<span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_uniforms</span><span class="p">,</span>
		<span class="nx">attributes</span>	<span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span><span class="p">,</span>
		<span class="nx">vertexShader</span>	<span class="o">:</span> <span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">vertexShaderText</span><span class="p">,</span>
		<span class="nx">fragmentShader</span>	<span class="o">:</span> <span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">fragmentShaderText</span><span class="p">,</span>

		<span class="nx">blending</span>	<span class="o">:</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">AdditiveBlending</span><span class="p">,</span>
		<span class="nx">depthWrite</span>	<span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>depthTest    : false,</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">transparent</span>	<span class="o">:</span> <span class="kc">true</span>
	<span class="p">});</span>

	<span class="k">this</span><span class="p">.</span><span class="nx">_group</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ParticleSystem</span><span class="p">(</span> <span class="nx">particles</span><span class="p">,</span> <span class="nx">material</span> <span class="p">);</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">dynamic</span>		<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">sortParticles</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>	<span class="c1">// TODO is this needed ?	</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>// EMITTER STUFF</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">setTargetParticle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>					
		<span class="kd">var</span> <span class="nx">vertexIdx</span>	<span class="o">=</span> <span class="nx">vertexIndexPool</span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>
		<span class="kd">var</span> <span class="nx">target</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="nx">vertexIdx</span>	<span class="o">:</span> <span class="nx">vertexIdx</span><span class="p">,</span>
			<span class="nx">size</span>		<span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span>	<span class="nx">valuesSize</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="k">return</span> <span class="nx">valuesSize</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">];</span>
			<span class="p">},</span>
			<span class="nx">color</span>		<span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
				<span class="k">if</span><span class="p">(</span> <span class="nx">value</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span>	<span class="nx">valuesColor</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">]</span>	<span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
				<span class="k">return</span> <span class="nx">valuesColor</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
	<span class="p">};</span>


	<span class="kd">var</span> <span class="nx">onParticleCreated</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">particle</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">vertexIdx</span>	<span class="o">=</span> <span class="nx">particle</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">vertexIdx</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>copy particle position into three.js geometry</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">vertices</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">].</span><span class="nx">position</span>	<span class="o">=</span> <span class="nx">particle</span><span class="p">.</span><span class="nx">position</span><span class="p">;</span>						
	<span class="p">};</span>
	
	<span class="kd">var</span> <span class="nx">onParticleDead</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">particle</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">vertexIdx</span>	<span class="o">=</span> <span class="nx">particle</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">vertexIdx</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Hide the particle</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">valuesColor</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">].</span><span class="nx">setHex</span><span class="p">(</span> <span class="mh">0x000000</span> <span class="p">);</span>
		<span class="nx">vertices</span><span class="p">[</span><span class="nx">vertexIdx</span><span class="p">].</span><span class="nx">position</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">,</span><span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">,</span> <span class="nb">Number</span><span class="p">.</span><span class="nx">POSITIVE_INFINITY</span><span class="p">);</span>
		</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Mark particle system as available by returning to pool</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">vertexIndexPool</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">vertexIdx</span> <span class="p">);</span>
	<span class="p">};</span>
	
	<span class="kd">var</span> <span class="nx">emitter</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_emitter</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">SPARKS</span><span class="p">.</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">counter</span><span class="p">);</span>

	<span class="nx">emitter</span><span class="p">.</span><span class="nx">addInitializer</span><span class="p">(</span><span class="k">new</span> <span class="nx">SPARKS</span><span class="p">.</span><span class="nx">Target</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">setTargetParticle</span><span class="p">));</span>
	<span class="nx">emitter</span><span class="p">.</span><span class="nx">addCallback</span><span class="p">(</span><span class="s2">&quot;created&quot;</span>	<span class="p">,</span> <span class="nx">onParticleCreated</span>	<span class="p">);</span>
	<span class="nx">emitter</span><span class="p">.</span><span class="nx">addCallback</span><span class="p">(</span><span class="s2">&quot;dead&quot;</span>	<span class="p">,</span> <span class="nx">onParticleDead</span>	<span class="p">);</span>
<span class="p">}</span>


<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_$onWindowResize</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">_emitter</span><span class="p">.</span><span class="nx">isRunning</span><span class="p">()</span> <span class="p">)</span>	<span class="k">this</span><span class="p">.</span><span class="nx">_emitter</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>////////////////////////////////////////////////////////////////////////////////
                                    //
////////////////////////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">container</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_group</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emitter</span>		<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_emitter</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyVertices</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_group</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">__dirtyColors</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span><span class="p">.</span><span class="nx">size</span><span class="p">.</span><span class="nx">needsUpdate</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_attributes</span><span class="p">.</span><span class="nx">aColor</span><span class="p">.</span><span class="nx">needsUpdate</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>////////////////////////////////////////////////////////////////////////////////
    handle window resize                        //
////////////////////////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_onWindowResize</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_uniforms</span><span class="p">.</span><span class="nx">sizeRatio</span><span class="p">.</span><span class="nx">value</span>	<span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_computeSizeRatio</span><span class="p">();</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">_uniforms</span><span class="p">.</span><span class="nx">sizeRatio</span><span class="p">.</span><span class="nx">needsUpdate</span>	<span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_computeSizeRatio</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>////////////////////////////////////////////////////////////////////////////////
    Shader Text                         //
////////////////////////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">vertexShaderText</span>	<span class="o">=</span> <span class="p">[</span>
	<span class="s2">&quot;attribute	float	size;&quot;</span><span class="p">,</span>
	<span class="s2">&quot;attribute	vec4	aColor;&quot;</span><span class="p">,</span>
	
	<span class="s2">&quot;uniform	float	sizeRatio;&quot;</span><span class="p">,</span>

	<span class="s2">&quot;varying	vec4	vColor;&quot;</span><span class="p">,</span>

	<span class="s2">&quot;void main() {&quot;</span><span class="p">,</span>
		<span class="s2">&quot;vec4 mvPosition= modelViewMatrix * vec4( position, 1.0 );&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>FIXME is that the proper formula for size ? doesnt this depends on the fov ?</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="s2">&quot;gl_PointSize	= size * sizeRatio * ( 150.0 / length( mvPosition.xyz ) );&quot;</span><span class="p">,</span>
		<span class="s2">&quot;gl_Position	= projectionMatrix * mvPosition;&quot;</span><span class="p">,</span>

		<span class="s2">&quot;vColor		= aColor;&quot;</span><span class="p">,</span>
	<span class="s2">&quot;}&quot;</span>
<span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">fragmentShaderText</span>	<span class="o">=</span> <span class="p">[</span>
	<span class="s2">&quot;uniform vec3		color;&quot;</span><span class="p">,</span>
	<span class="s2">&quot;uniform sampler2D	texture;&quot;</span><span class="p">,</span>

	<span class="s2">&quot;varying vec4		vColor;&quot;</span><span class="p">,</span>
	
	<span class="s2">&quot;void main() {&quot;</span><span class="p">,</span>
		<span class="s2">&quot;vec4 outColor	= texture2D( texture, gl_PointCoord );&quot;</span><span class="p">,</span>
		<span class="s2">&quot;gl_FragColor	= outColor * vec4( color * vColor.xyz, 1.0 );&quot;</span><span class="p">,</span>
	<span class="s2">&quot;}&quot;</span>
<span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>////////////////////////////////////////////////////////////////////////////////
    Texture                             //
////////////////////////////////////////////////////////////////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">THREEx</span><span class="p">.</span><span class="nx">Sparks</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_buildDefaultTexture</span>	<span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="nx">size</span>		<span class="o">=</span> <span class="nx">size</span> <span class="o">||</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kd">var</span> <span class="nx">canvas</span>	<span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span> <span class="s1">&#39;canvas&#39;</span> <span class="p">);</span>
	<span class="kd">var</span> <span class="nx">context</span>	<span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span> <span class="s1">&#39;2d&#39;</span> <span class="p">);</span>
	<span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>	<span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>	<span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
	
	<span class="kd">var</span> <span class="nx">gradient</span>	<span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">createRadialGradient</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span><span class="mi">2</span> <span class="p">);</span>				
	<span class="nx">gradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span> <span class="mi">0</span>  <span class="p">,</span> <span class="s1">&#39;rgba(255,255,255,1)&#39;</span> <span class="p">);</span>
	<span class="nx">gradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255,1)&#39;</span> <span class="p">);</span>
	<span class="nx">gradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;rgba(128,128,128,1)&#39;</span> <span class="p">);</span>
	<span class="nx">gradient</span><span class="p">.</span><span class="nx">addColorStop</span><span class="p">(</span> <span class="mi">1</span>  <span class="p">,</span> <span class="s1">&#39;rgba(0,0,0,1)&#39;</span> <span class="p">);</span>

	<span class="nx">context</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
	<span class="nx">context</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span>
	
	<span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span>	<span class="o">=</span> <span class="nx">gradient</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>context.fillStyle    = 'rgba(128,128,128,1)';</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">context</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
			
	<span class="kd">var</span> <span class="nx">texture</span>	<span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Texture</span><span class="p">(</span> <span class="nx">canvas</span> <span class="p">);</span>
	<span class="nx">texture</span><span class="p">.</span><span class="nx">needsUpdate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="nx">texture</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 